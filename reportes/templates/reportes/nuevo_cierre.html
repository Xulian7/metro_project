{% extends "accounts/home.html" %}
{% load humanize %}

{% block content %}
<div class="card p-4 shadow-sm">

  <!-- ================= HEADER ================= -->
  <h4 class="fw-bold mb-1">
    Cierre de caja · {{ request.user.username }}
  </h4>

  <p class="text-muted mb-4">
    Periodo: {{ inicio }} → {{ fin }}
  </p>

  <!-- ================= FORM ================= -->
  <form method="post" id="form-cierre">
    {% csrf_token %}

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Medio</th>
            <th>Cuenta</th>
            <th class="text-end">Sistema</th>
            <th class="text-end">Arqueo</th>
            <th class="text-end">Diferencia</th>
          </tr>
        </thead>

        <tbody>
          {% for t in totales %}
          <tr>

            <!-- Medio -->
            <td>
              {{ t.configuracion__medio__nombre }}
            </td>

            <!-- Cuenta -->
            <td>
              {{ t.configuracion__cuenta_destino__nombre }}
            </td>

            <!-- Total sistema -->
            <td class="text-end">
              ${{ t.total|intcomma }}
              <input type="hidden"
                     name="sistema_{{ forloop.counter }}"
                     value="{{ t.total }}">
            </td>

            <!-- Arqueo -->
            <td class="text-end">
              <input type="number"
                     step="0.01"
                     min="0"
                     required
                     class="form-control form-control-sm arqueo-input text-end"
                     name="arqueo_{{ forloop.counter }}"
                     data-sistema="{{ t.total }}">
            </td>

            <!-- Diferencia -->
            <td class="text-end fw-semibold diferencia-cell text-muted">
              —
            </td>

            <!-- Configuración (CLAVE REAL) -->
            <input type="hidden"
                   name="configuracion_{{ forloop.counter }}"
                   value="{{ t.configuracion_id }}">

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <hr>

    <!-- ================= OBSERVACIÓN ================= -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Observación</label>
      <textarea name="observacion"
                class="form-control"
                rows="2"
                placeholder="Opcional: notas del cierre, faltantes, incidencias…"></textarea>
    </div>

    <!-- ================= ACCIÓN ================= -->
    <div class="text-end">
      <button type="submit" class="btn btn-primary">
        Guardar cierre
      </button>
    </div>

  </form>
</div>

<!-- ================= SCRIPT DIFERENCIAS ================= -->
<script>
  document.querySelectorAll(".arqueo-input").forEach(input => {
    input.addEventListener("input", () => {

      const sistema = parseFloat(input.dataset.sistema || 0);
      const arqueo = parseFloat(input.value || 0);
      const diff = arqueo - sistema;

      const cell = input
        .closest("tr")
        .querySelector(".diferencia-cell");

      cell.textContent = diff.toLocaleString("es-CO", {
        style: "currency",
        currency: "COP"
      });

      cell.className =
        "text-end fw-semibold diferencia-cell " +
        (diff === 0
          ? "text-success"
          : diff < 0
          ? "text-danger"
          : "text-primary");
    });
  });
</script>

<!-- ================= VALIDACIÓN UX ================= -->
<script>
  document.getElementById("form-cierre")
    .addEventListener("submit", e => {

      const inputs = document.querySelectorAll(".arqueo-input");

      for (const i of inputs) {
        if (i.value === "") {
          alert("⚠️ Debes completar el arqueo de todos los medios antes de guardar.");
          e.preventDefault();
          return;
        }
      }
    });
</script>

{% endblock %}
