{% extends "accounts/home.html" %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Gestion de almacen{% endblock %}
{% block content %}

<div class="container-fluid py-2">
    
    <!-- Tabs -->
    <ul class="nav nav-tabs modern-tabs" id="almacenTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button">Productos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="proveedores-tab" data-bs-toggle="tab" data-bs-target="#proveedores" type="button">Proveedores</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="movimientos-tab" data-bs-toggle="tab" data-bs-target="#movimientos" type="button">Movimientos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button">Stock</button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- Productos -->
        <div class="tab-pane fade show active" id="productos">
            <!-- Contenedor superior: carga masiva + botón crear producto -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <!-- Formulario de carga masiva -->
                <form method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                    {% csrf_token %}
                    <input type="file" name="archivo_excel" accept=".xlsx,.xls" class="form-control form-control-sm">
                    <button type="submit" class="btn btn-outline-primary btn-sm btn-app-action">
                        <i class="bi bi-upload"></i> Cargar productos
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm btn-app-action" data-bs-toggle="modal" data-bs-target="#crearProductoModal">
                        <i class="bi bi-plus-lg"></i> Nuevo producto
                    </button>
                    <form method="post" class="m-0">
                        {% csrf_token %}
                        <button type="submit" name="export_csv"
                            class="btn btn-outline-primary btn-sm btn-app-action">
                            <i class="bi bi-file-earmark-arrow-down"></i> Exportar CSV
                        </button>
                    </form>
                </form>
            </div>

            <!-- Modal Crear Producto -->
            <div class="modal fade" id="crearProductoModal" tabindex="-1" aria-labelledby="crearProductoLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                    <h5 class="modal-title" id="crearProductoLabel">Crear Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        {% render_field producto_form.nombre class="form-control" placeholder="Ej. Tornillo cabeza hexagonal" %}
                        </div>
                        <div class="col-md-6">
                        <label class="form-label">Referencia</label>
                        {% render_field producto_form.referencia class="form-control" placeholder="Ref-001" %}
                        </div>
                        <div class="col-md-4">
                        <label class="form-label">Utilidad</label>
                        {% render_field producto_form.utilidad class="form-control" placeholder="Alta/Media/Baja" %}
                        </div>
                        <div class="col-md-4">
                        <label class="form-label">Precio venta</label>
                        {% render_field producto_form.precio_venta class="form-control" step="0.01" placeholder="5000" %}
                        </div>
                        <div class="col-md-4">
                        <label class="form-label">EAN</label>
                        {% render_field producto_form.ean class="form-control" placeholder="Código EAN" %}
                        </div>
                    </div>
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" name="producto_submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
                </div>
            </div>
            </div>

            <!-- Contenedor principal -->
            <div class="card shadow-sm p-4">
                <div class="card-body">
                    <!-- Título -->
                    <!--<h5 class="card-title text-center mb-4 fw-semibold">Lista de Productos</h5> -->
                    <!-- Buscador con icono -->
                    <div class="d-flex justify-content-center mb-3">
                        <div class="position-relative w-50">
                            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                            <input 
                            type="text" 
                            id="filtroNombre" 
                            class="form-control ps-5 text-center" 
                            placeholder="Buscar por nombre..."
                            >
                        </div>
                    </div>

                    <!-- Tabla de productos -->
                    <div class="table-responsive">
                        <table class="table modern-table align-middle text-center" id="tablaProductos">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Referencia</th>
                                    <th>Utilidad</th>
                                    <th>Precio Venta</th>
                                    <th>EAN</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos %}
                                <tr data-id="{{ producto.id }}">
                                    <td>{{ producto.nombre }}</td>
                                    <td>{{ producto.referencia }}</td>
                                    <td>{{ producto.utilidad }}</td>
                                    <td>{{ producto.precio_venta }}</td>
                                    <td>{{ producto.ean }}</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm btn-app-action editarBtn" data-bs-toggle="modal" data-bs-target="#modalEditar">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal de edición -->
            <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel">Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditar">
                    <input type="hidden" id="productoId">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" id="editNombre" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Referencia</label>
                        <input type="text" id="editReferencia" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Utilidad</label>
                        <input type="text" id="editUtilidad" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio Venta</label>
                        <input type="number" step="0.01" id="editPrecioVenta" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">EAN</label>
                        <input type="text" id="editEan" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Guardar cambios</button>
                    </form>
                </div>
                </div>
            </div>
            </div>

            <!-- Script de filtrado y edición -->
            <script>
            document.addEventListener("DOMContentLoaded", function() {
            const input = document.getElementById("filtroNombre");
            const table = document.getElementById("tablaProductos");
            const rows = table.getElementsByTagName("tr");

            //Filtrado dinámico
            input.addEventListener("keyup", function() {
                const filtro = input.value.toLowerCase();
                for (let i = 1; i < rows.length; i++) {
                const celdaNombre = rows[i].getElementsByTagName("td")[0];
                if (celdaNombre) {
                    const texto = celdaNombre.textContent.toLowerCase();
                    rows[i].style.display = texto.includes(filtro) ? "" : "none";
                }
                }
            });

            //Cargar datos al modal
            document.querySelectorAll(".editarBtn").forEach(boton => {
                boton.addEventListener("click", function() {
                const fila = boton.closest("tr");
                document.getElementById("productoId").value = fila.dataset.id;
                document.getElementById("editNombre").value = fila.children[0].textContent;
                document.getElementById("editReferencia").value = fila.children[1].textContent;
                document.getElementById("editUtilidad").value = fila.children[2].textContent;
                document.getElementById("editPrecioVenta").value = fila.children[3].textContent;
                document.getElementById("editEan").value = fila.children[4].textContent;
                });
            });

            //Guardar cambios (AJAX)
            document.getElementById("formEditar").addEventListener("submit", function(e) {
                e.preventDefault();
                const id = document.getElementById("productoId").value;
                const data = {
                nombre: document.getElementById("editNombre").value,
                referencia: document.getElementById("editReferencia").value,
                utilidad: document.getElementById("editUtilidad").value,
                precio_venta: document.getElementById("editPrecioVenta").value,
                ean: document.getElementById("editEan").value
                };

                fetch("{% url 'editar_producto' 0 %}".replace("0", id), {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
                })
                .then(res => res.json())
                .then(resp => {
                if (resp.success) {
                    const fila = document.querySelector(`tr[data-id="${id}"]`);
                    fila.children[0].textContent = data.nombre;
                    fila.children[1].textContent = data.referencia;
                    fila.children[2].textContent = data.utilidad;
                    fila.children[3].textContent = data.precio_venta;
                    fila.children[4].textContent = data.ean;
                    bootstrap.Modal.getInstance(document.getElementById("modalEditar")).hide();
                } else {
                    alert("Error al guardar cambios");
                }
                })
                .catch(() => alert("Error de conexión"));
            });
            });
            </script>

            <!-- Estilo adicional -->
            <style>
            #filtroNombre:focus + .bi-search,
            #filtroNombre:not(:placeholder-shown) + .bi-search {
            color: #0d6efd;
            transform: scale(1.1);
            transition: all 0.2s ease;
            }
            </style>


        </div>

        <!-- Proveedores -->
        <div class="tab-pane fade" id="proveedores">
            <h3 class="mb-4"> Crear Proveedor</h3>

            <form method="post" class="modern-form row g-3 mb-4" novalidate>
                {% csrf_token %}
                <div class="col-md-4">
                    <label for="id_nombre" class="form-label fw-semibold text-secondary small">Nombre</label>
                    {{ proveedor_form.nombre|add_class:"form-control form-control-modern" }}
                </div>
                <div class="col-md-4">
                    <label for="id_nit" class="form-label fw-semibold text-secondary small">NIT</label>
                    {{ proveedor_form.nit|add_class:"form-control form-control-modern" }}
                </div>
                <div class="col-md-4">
                    <label for="id_telefono" class="form-label fw-semibold text-secondary small">Teléfono</label>
                    {{ proveedor_form.telefono|add_class:"form-control form-control-modern" }}
                </div>

                <div class="col-12 d-flex justify-content-end mt-3">
                    <button type="submit" name="proveedor_submit" class="btn btn-outline-primary btn-sm btn-app-action">
                        Guardar
                    </button>
                </div>
            </form>


            <hr>

            <h3 class="mb-3">Lista de Proveedores</h3>
            <div class="table-responsive">
                <table class="modern-table w-100 text-center align-middle">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>NIT</th>
                            <th>Teléfono</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prov in proveedores %}
                        <tr>
                            <td>{{ prov.nombre }}</td>
                            <td>{{ prov.nit }}</td>
                            <td>{{ prov.telefono }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-muted">No hay proveedores registrados</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Movimientos -->
        <div class="tab-pane fade" id="movimientos">
            <h3>Movimientos por Producto</h3>

            <!-- Botones superiores -->
            <div class="d-flex justify-content-between mb-3">
                <!-- Nuevo movimiento -->
                <button 
                    type="button" 
                    class="btn btn-success btn-app-action" 
                    data-bs-toggle="modal" 
                    data-bs-target="#nuevoMovimientoModal">
                    <i class="bi bi-plus-circle"></i> Nuevo movimiento
                </button>


                <!-- Carga masiva de factura -->
                <form method="post" enctype="multipart/form-data" class="d-flex gap-2">
                    {% csrf_token %}
                    <input type="file" name="archivo_factura" class="form-control" accept=".xlsx">
                    <button 
                        type="submit" 
                        name="carga_masiva_factura" 
                        class="btn btn-primary btn-app-action">
                        <i class="bi bi-file-earmark-arrow-up"></i> Cargar factura
                    </button>
                </form>
            </div>

            {% if mensaje_factura %}
                <div class="alert alert-{{ mensaje_factura.tipo }}" role="alert">
                    {{ mensaje_factura.texto }}
                </div>
            {% endif %}

            <!-- Modal Nuevo Movimiento -->
            <div class="modal fade" id="nuevoMovimientoModal" tabindex="-1" aria-labelledby="nuevoMovimientoLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="nuevoMovimientoLabel">Registrar Movimiento</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <div class="container-fluid">
                                    {% for field in movimiento_form %}
                                        <div class="row mb-3">
                                            <label for="{{ field.id_for_label }}" class="col-sm-4 col-form-label text-end">
                                                {{ field.label }}{% if field.field.required %}*{% endif %}
                                            </label>
                                            <div class="col-sm-8">
                                                {{ field }}
                                                {% if field.help_text %}
                                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                                {% for error in field.errors %}
                                                    <div class="text-danger">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" name="movimiento_submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Listado de movimientos por producto -->
            {% for producto, movs in movimientos_por_producto.items %}
                <h4 class="mt-3">
                    {{ producto.nombre }} ({{ producto.referencia }}) 
                    - Stock: <span class="{% if movs.stock_actual <= 0 %}text-danger{% else %}text-success{% endif %}">{{ movs.stock_actual }}</span>
                    - Valor Stock: ${{ movs.valor_stock }}
                </h4>

                <table class="table table-sm table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Proveedor</th>
                            <th>Fecha</th>
                            <th>Precio Unitario</th>
                            <th>Movimiento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in movs.ingresos %}
                            <tr class="table-success">
                                <td>{{ m.get_tipo_display }}</td>
                                <td>{{ m.cantidad }}</td>
                                <td>{% if m.proveedor %}{{ m.proveedor.nombre }}{% else %}-{% endif %}</td>
                                <td>{{ m.fecha }}</td>
                                <td>{{ m.precio_unitario }}</td>
                                <td>Ingreso</td>
                            </tr>
                        {% endfor %}

                        {% for m in movs.salidas %}
                            <tr class="table-danger">
                                <td>{{ m.get_tipo_display }}</td>
                                <td>{{ m.cantidad }}</td>
                                <td>{% if m.proveedor %}{{ m.proveedor.nombre }}{% else %}-{% endif %}</td>
                                <td>{{ m.fecha }}</td>
                                <td>{{ m.precio_unitario }}</td>
                                <td>Salida</td>
                            </tr>
                        {% endfor %}

                        {% if not movs.ingresos and not movs.salidas %}
                            <tr>
                                <td colspan="6" class="text-center">No hay movimientos registrados.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            {% endfor %}
        </div>


        <!-- Pestaña Stock -->
        <div class="tab-pane fade" id="stock" role="tabpanel" aria-labelledby="stock-tab">
            <h5 class="mb-3">Resumen de Stock</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th>Referencia</th>
                            <th>Stock Actual</th>
                            <th>Valor Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto, movs in movimientos_por_producto.items %}
                        <tr>
                            <td>{{ producto.nombre }}</td>
                            <td>{{ producto.referencia }}</td>
                            <td>
                                <span class="{% if movs.stock_actual <= 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
                                    {{ movs.stock_actual }}
                                </span>
                            </td>
                            <td>${{ movs.valor_stock }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.querySelector('#id_tipo');
    const facturaFieldRow = document.querySelector('[for="id_factura_referencia"]')?.closest('.row');

    function toggleFacturaField() {
        if (!tipoSelect || !facturaFieldRow) return;

        const tiposConFactura = [
            'ingreso_compra',
            'salida_venta',
            'ingreso_devolucion_cliente',
            'salida_devolucion_proveedor'
        ];

        facturaFieldRow.style.display = tiposConFactura.includes(tipoSelect.value) ? '' : 'none';
    }

    toggleFacturaField();
    tipoSelect?.addEventListener('change', toggleFacturaField);
});
</script>
{% endblock %}
