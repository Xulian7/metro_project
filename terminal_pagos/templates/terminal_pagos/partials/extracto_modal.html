<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Extracto de pagos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Fecha pactada</th>
              <th>Fecha pago</th>
              <th class="text-end">Valor aplicado</th>
              <th>Factura</th>
            </tr>
          </thead>
          <tbody id="extracto-body">
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Cargando extractoâ€¦
              </td>
            </tr>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>

<!-- ðŸ“Œ SCRIPT DEL POPOVER DE FACTURA -->
<script>
document.addEventListener("click", function (e) {

  const tag = e.target.closest(".factura-tag");
  if (!tag) return;

  const facturaId = tag.dataset.facturaId;

  // ðŸ§¹ cerrar otros popovers
  document.querySelectorAll(".factura-tag").forEach(t => {
    if (t !== tag) {
      bootstrap.Popover.getInstance(t)?.dispose();
    }
  });

  const pop = new bootstrap.Popover(tag, {
    html: true,
    content: "Cargando pagosâ€¦",
    trigger: "manual",
    placement: "right",
  });

  pop.show();

  fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
    .then(res => res.json())
    .then(data => {

      let html = `
        <strong>Factura #${data.factura}</strong>
        <hr class="my-1">
      `;

      if (data.pagos.length === 0) {
        html += `<em class="text-muted">Sin pagos</em>`;
      } else {
        data.pagos.forEach(p => {
          html += `
            <div class="mb-1">
              <strong>${p.medio}</strong><br>
              <small class="text-muted">${p.canal}</small><br>
              $${Number(p.valor).toLocaleString("es-CO")}
              ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
            </div>
          `;
        });
      }

      pop.setContent({ ".popover-body": html });
    });

});
</script>

