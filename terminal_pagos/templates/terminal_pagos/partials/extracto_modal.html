<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Extracto de pagos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Fecha pactada</th>
              <th>Fecha pago</th>
              <th class="text-end">Valor aplicado</th>
              <th>Factura</th>
            </tr>
          </thead>
          <tbody id="extracto-body">
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Cargando extractoâ€¦
              </td>
            </tr>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>

<script>
let popover = null;
let hideTimer = null;

/* =========================
   HOVER SOBRE FACTURA TAG
========================= */
document.addEventListener("mouseover", function (e) {
  const tag = e.target.closest(".factura-tag");
  if (!tag) return;

  // cancelar cierre si estaba programado
  if (hideTimer) {
    clearTimeout(hideTimer);
    hideTimer = null;
  }

  // si ya hay uno abierto sobre este tag, no recrear
  if (popover && popover._element === tag) return;

  // cerrar otros
  document.querySelectorAll(".factura-tag").forEach(t => {
    bootstrap.Popover.getInstance(t)?.dispose();
  });

  const facturaId = tag.dataset.facturaId;

  popover = new bootstrap.Popover(tag, {
    html: true,
    trigger: "manual",
    placement: "right",
    container: "body",
    content: "Cargando pagosâ€¦",
  });

  popover.show();

  fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
    .then(res => res.json())
    .then(data => {

      let html = `
        <strong>Factura #${data.factura}</strong>
        <hr class="my-1">
      `;

      if (!data.pagos.length) {
        html += `<em class="text-muted">Sin pagos</em>`;
      } else {
        data.pagos.forEach(p => {
          html += `
            <div class="mb-2">
              <strong>${p.medio}</strong><br>
              <small class="text-muted">${p.canal}</small><br>
              $${Number(p.valor).toLocaleString("es-CO")}
              ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
            </div>
          `;
        });
      }

      popover.setContent({ ".popover-body": html });

      // ðŸ‘‡ enganchar hover del popover
      const popEl = document.querySelector(".popover");
      if (popEl) {
        popEl.addEventListener("mouseenter", () => {
          if (hideTimer) clearTimeout(hideTimer);
        });

        popEl.addEventListener("mouseleave", scheduleHide);
      }
    });
});


/* =========================
   SALIDA DEL TAG
========================= */
document.addEventListener("mouseout", function (e) {
  const tag = e.target.closest(".factura-tag");
  if (!tag) return;

  scheduleHide();
});


/* =========================
   CIERRE DIFERIDO (CLAVE)
========================= */
function scheduleHide() {
  hideTimer = setTimeout(() => {
    document.querySelectorAll(".factura-tag").forEach(t => {
      bootstrap.Popover.getInstance(t)?.dispose();
    });
    popover = null;
  }, 300); // ðŸ‘ˆ delay humano
}
</script>
