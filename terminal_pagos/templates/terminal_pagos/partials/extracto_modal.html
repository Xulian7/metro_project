<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Extracto de pagos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Fecha pactada</th>
              <th>Fecha pago</th>
              <th class="text-end">Valor aplicado</th>
              <th>Factura</th>
            </tr>
          </thead>
          <tbody id="extracto-body">
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Cargando extractoâ€¦
              </td>
            </tr>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>

<script>
  let popover = null;
  let hideTimer = null;
  let activo = false;

  document.addEventListener("mouseover", function (e) {
    const tag = e.target.closest(".factura-tag");
    if (!tag) return;

    if (hideTimer) clearTimeout(hideTimer);

    // ya activo sobre este tag â†’ no recrear
    if (activo && popover?._element === tag) return;

    // cerrar otros
    document.querySelectorAll(".factura-tag").forEach(t => {
      bootstrap.Popover.getInstance(t)?.dispose();
    });

    const facturaId = tag.dataset.facturaId;

    popover = new bootstrap.Popover(tag, {
      html: true,
      trigger: "manual",
      placement: "right",
      container: "body",
      content: `
        <div id="popover-content">
          <em class="text-muted">Cargando pagosâ€¦</em>
        </div>
      `,
    });

    popover.show();
    activo = true;

    // ðŸ” fetch SOLO actualiza contenido interno
    fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
      .then(res => res.json())
      .then(data => {
        const cont = document.getElementById("popover-content");
        if (!cont) return;

        let html = `
          <strong>Factura #${data.factura.id}</strong>
          <hr class="my-1">
        `;

        if (!data.pagos.length) {
          html += `<em class="text-muted">Sin pagos</em>`;
        } else {
          data.pagos.forEach(p => {
            html += `
              <div class="mb-2">
                <strong>${p.medio}</strong><br>
                <small class="text-muted">${p.canal}</small><br>
                $${Number(p.valor).toLocaleString("es-CO")}
                ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
              </div>
            `;
          });
        }

        cont.innerHTML = html;

        // mantener hover sobre el popover
        const popEl = cont.closest(".popover");
        if (popEl) {
          popEl.addEventListener("mouseenter", () => {
            if (hideTimer) clearTimeout(hideTimer);
          });
          popEl.addEventListener("mouseleave", scheduleHide);
        }
      });
  });

  document.addEventListener("mouseout", function (e) {
    const tag = e.target.closest(".factura-tag");
    if (!tag) return;
    scheduleHide();
  });

  function scheduleHide() {
    hideTimer = setTimeout(() => {
      document.querySelectorAll(".factura-tag").forEach(t => {
        bootstrap.Popover.getInstance(t)?.dispose();
      });
      popover = null;
      activo = false;
    }, 300);
  }
</script>
