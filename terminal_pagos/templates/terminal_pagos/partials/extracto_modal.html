<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Extracto de pagos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Fecha pactada</th>
              <th>Fecha pago</th>
              <th class="text-end">Valor aplicado</th>
              <th>Factura</th>
            </tr>
          </thead>
          <tbody id="extracto-body">
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Cargando extracto…
              </td>
            </tr>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>

<script>
let popoverActivo = null;

/* =========================
   ABRIR POPOVER
========================= */
document.addEventListener("click", function (e) {

  const tag = e.target.closest(".factura-tag");
  if (!tag) return;

  e.preventDefault();
  e.stopPropagation(); // ⛔ CLAVE

  // Toggle
  if (popoverActivo === tag) {
    bootstrap.Popover.getInstance(tag)?.dispose();
    popoverActivo = null;
    return;
  }

  // Cerrar otros
  document.querySelectorAll(".factura-tag").forEach(t => {
    bootstrap.Popover.getInstance(t)?.dispose();
  });

  const facturaId = tag.dataset.facturaId;

  const pop = new bootstrap.Popover(tag, {
    html: true,
    trigger: "manual",
    placement: "right",
    container: "body",
    content: "Cargando pagos…",
  });

  pop.show();
  popoverActivo = tag;

  fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
    .then(res => res.json())
    .then(data => {

      let html = `
        <strong>Factura #${data.factura}</strong>
        <hr class="my-1">
      `;

      if (!data.pagos.length) {
        html += `<em class="text-muted">Sin pagos</em>`;
      } else {
        data.pagos.forEach(p => {
          html += `
            <div class="mb-2">
              <strong>${p.medio}</strong><br>
              <small class="text-muted">${p.canal}</small><br>
              $${Number(p.valor).toLocaleString("es-CO")}
              ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
            </div>
          `;
        });
      }

      pop.setContent({ ".popover-body": html });
    });
});


/* =========================
   CERRAR AL CLICK FUERA
========================= */
document.addEventListener("click", function () {
  document.querySelectorAll(".factura-tag").forEach(t => {
    bootstrap.Popover.getInstance(t)?.dispose();
  });
  popoverActivo = null;
});
</script>
