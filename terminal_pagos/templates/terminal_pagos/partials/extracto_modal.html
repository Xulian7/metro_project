<!-- ================= MODAL EXTRACTO DE PAGOS ================= -->
<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <!-- HEADER -->
      <div class="modal-header">
        <h5 class="modal-title fw-bold">
          Extracto financiero
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- ================= RESUMEN FINANCIERO ================= -->
        <div class="row g-3 mb-4">

          <div class="col-md">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body py-3">
                <small class="text-muted">Contrato</small>
                <div class="fw-semibold fs-6" id="extracto-contrato">—</div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body py-3">
                <small class="text-muted">Antigüedad</small>
                <div class="fw-bold fs-5" id="extracto-antiguedad">
                  — <small class="text-muted">días</small>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm h-100 bg-light">
              <div class="card-body py-3">
                <small class="text-muted">Tarifas pagadas</small>
                <div class="fw-bold fs-5 text-success" id="extracto-pagadas">
                  $0
                </div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm h-100 bg-light">
              <div class="card-body py-3">
                <small class="text-muted">Tarifas vencidas</small>
                <div class="fw-bold fs-5 text-danger" id="extracto-vencidas">
                  $0
                </div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body py-3">
                <small class="text-muted">Días de atraso</small>
                <div class="fw-bold fs-5" id="extracto-atraso">
                  0
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- ================= FIN RESUMEN ================= -->

        <!-- ================= TABLA EXTRACTO ================= -->
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Fecha pactada</th>
                <th>Fecha pago</th>
                <th class="text-end">Valor aplicado</th>
                <th>Factura</th>
              </tr>
            </thead>

            <tbody id="extracto-body">
              <tr>
                <td colspan="4" class="text-center text-muted py-4">
                  Cargando extracto…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- ================= FIN TABLA ================= -->

      </div>
    </div>
  </div>
</div>
<!-- ================= FIN MODAL ================= -->


<!-- ================= SCRIPT EXTRACTO ================= -->
<script>
function abrirExtractoContrato(contratoId) {

  const modal = new bootstrap.Modal(
    document.getElementById("extractoModal")
  );
  modal.show();

  // placeholders
  document.getElementById("extracto-contrato").textContent = "—";
  document.getElementById("extracto-antiguedad").innerHTML =
    `— <small class="text-muted">días</small>`;
  document.getElementById("extracto-pagadas").textContent = "$0";
  document.getElementById("extracto-vencidas").textContent = "$0";
  document.getElementById("extracto-atraso").textContent = "0";

  const tbody = document.getElementById("extracto-body");
  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="text-center text-muted py-4">
        Cargando extracto…
      </td>
    </tr>
  `;

  fetch(`/terminal_pagos/extracto/contrato/${contratoId}/`)
    .then(res => res.json())
    .then(data => {

      // ================= HEADER =================
      document.getElementById("extracto-contrato").textContent =
        data.contrato.label;

      // ================= TABLA =================
      tbody.innerHTML = "";

      if (!data.filas.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted py-4">
              Sin movimientos
            </td>
          </tr>`;
        return;
      }

      data.filas.forEach(f => {
        tbody.innerHTML += `
          <tr>
            <td>${f.fecha_pactada}</td>
            <td>${f.fecha_pago || "—"}</td>
            <td class="text-end">
              $${Number(f.valor_aplicado).toLocaleString("es-CO")}
            </td>
            <td>
              ${f.factura_id ? `#${f.factura_id}` : "—"}
            </td>
          </tr>
        `;
      });
    })
    .catch(() => {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="text-center text-danger py-4">
            Error al cargar el extracto
          </td>
        </tr>
      `;
    });
}
</script>
<!-- ================= END SCRIPT ================= -->
