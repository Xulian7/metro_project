<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Extracto de pagos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Fecha pactada</th>
              <th>Fecha pago</th>
              <th class="text-end">Valor aplicado</th>
              <th>Factura</th>
            </tr>
          </thead>
          <tbody id="extracto-body">
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Cargando extractoâ€¦
              </td>
            </tr>
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("click", function (e) {

  const tag = e.target.closest(".factura-tag");

  // ðŸ”» click fuera â†’ cerrar todos
  if (!tag) {
    document.querySelectorAll(".factura-tag").forEach(t => {
      bootstrap.Popover.getInstance(t)?.dispose();
    });
    return;
  }

  e.stopPropagation();

  const facturaId = tag.dataset.facturaId;

  // ðŸ” toggle: si ya existe, cerrar
  const existing = bootstrap.Popover.getInstance(tag);
  if (existing) {
    existing.dispose();
    return;
  }

  // ðŸ”» cerrar otros
  document.querySelectorAll(".factura-tag").forEach(t => {
    if (t !== tag) {
      bootstrap.Popover.getInstance(t)?.dispose();
    }
  });

  const pop = new bootstrap.Popover(tag, {
    html: true,
    trigger: "manual",
    placement: "right",
    content: "Cargando pagosâ€¦",
    container: "body",
  });

  pop.show();

  fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
    .then(res => res.json())
    .then(data => {

      let html = `
        <strong>Factura #${data.factura}</strong>
        <hr class="my-1">
      `;

      if (!data.pagos.length) {
        html += `<em class="text-muted">Sin pagos</em>`;
      } else {
        data.pagos.forEach(p => {
          html += `
            <div class="mb-2">
              <strong>${p.medio}</strong><br>
              <small class="text-muted">${p.canal}</small><br>
              $${Number(p.valor).toLocaleString("es-CO")}
              ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
            </div>
          `;
        });
      }

      pop.setContent({ ".popover-body": html });
    });
});
</script>


<Style>
  .factura-tag.active {
  background-color: #0d6efd;
}
</Style>