<!-- ================= MODAL EXTRACTO DE PAGOS ================= -->
<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <!-- HEADER -->
      <div class="modal-header">
        <h5 class="modal-title fw-bold">
          Extracto financiero
        </h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- ================= RESUMEN FINANCIERO ================= -->
        <div class="row g-3 mb-4">

          <!-- CONTRATO -->
          <div class="col-md">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body py-3">
                <small class="text-muted">Contrato</small>
                <div class="fw-semibold fs-6">
                  ‚Äî
                </div>
              </div>
            </div>
          </div>

          <!-- ANTIG√úEDAD -->
          <div class="col-md">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body py-3">
                <small class="text-muted">Antig√ºedad</small>
                <div class="fw-bold fs-5">
                  0 <small class="text-muted">d√≠as</small>
                </div>
              </div>
            </div>
          </div>

          <!-- TARIFAS PAGADAS -->
          <div class="col-md">
            <div class="card border-0 shadow-sm h-100 bg-light">
              <div class="card-body py-3">
                <small class="text-muted">Tarifas pagadas</small>
                <div class="fw-bold fs-5 text-success">
                  $0
                </div>
              </div>
            </div>
          </div>

          <!-- TARIFAS VENCIDAS -->
          <div class="col-md">
            <div class="card border-0 shadow-sm h-100 bg-light">
              <div class="card-body py-3">
                <small class="text-muted">Tarifas vencidas</small>
                <div class="fw-bold fs-5 text-danger">
                  $0
                </div>
              </div>
            </div>
          </div>

          <!-- D√çAS DE ATRASO -->
          <div class="col-md">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body py-3">
                <small class="text-muted">D√≠as de atraso</small>
                <div class="fw-bold fs-5">
                  0
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- ================= FIN RESUMEN ================= -->

        <!-- ================= TABLA EXTRACTO ================= -->
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Fecha pactada</th>
                <th>Fecha pago</th>
                <th class="text-end">Valor aplicado</th>
                <th>Factura</th>
              </tr>
            </thead>

            <tbody id="extracto-body">
              <tr>
                <td colspan="4"
                    class="text-center text-muted py-4">
                  Selecciona una factura para ver el extracto
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- ================= FIN TABLA ================= -->

      </div>

    </div>
  </div>
</div>
<!-- ================= FIN MODAL ================= -->


<script>
  let popover = null;
  let hideTimer = null;
  let activo = false;

  document.addEventListener("mouseover", function (e) {
    const tag = e.target.closest(".factura-tag");
    if (!tag) return;

    if (hideTimer) clearTimeout(hideTimer);

    // ya activo sobre este tag ‚Üí no recrear
    if (activo && popover?._element === tag) return;

    // cerrar otros
    document.querySelectorAll(".factura-tag").forEach(t => {
      bootstrap.Popover.getInstance(t)?.dispose();
    });

    const facturaId = tag.dataset.facturaId;

    popover = new bootstrap.Popover(tag, {
      html: true,
      trigger: "manual",
      placement: "right",
      container: "body",
      content: `
        <div id="popover-content">
          <em class="text-muted">Cargando pagos‚Ä¶</em>
        </div>
      `,
    });

    popover.show();
    activo = true;

    // üîÅ fetch SOLO actualiza contenido interno
    fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
      .then(res => res.json())
      .then(data => {
        const cont = document.getElementById("popover-content");
        if (!cont) return;

        let html = `
          <strong>Factura #${data.factura.id}</strong>
          <hr class="my-1">
        `;

        if (!data.pagos.length) {
          html += `<em class="text-muted">Sin pagos</em>`;
        } else {
          data.pagos.forEach(p => {
            html += `
              <div class="mb-2">
                <strong>${p.medio}</strong><br>
                <small class="text-muted">${p.canal}</small><br>
                $${Number(p.valor).toLocaleString("es-CO")}
                ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
              </div>
            `;
          });
        }

        cont.innerHTML = html;

        // mantener hover sobre el popover
        const popEl = cont.closest(".popover");
        if (popEl) {
          popEl.addEventListener("mouseenter", () => {
            if (hideTimer) clearTimeout(hideTimer);
          });
          popEl.addEventListener("mouseleave", scheduleHide);
        }
      });
  });

  document.addEventListener("mouseout", function (e) {
    const tag = e.target.closest(".factura-tag");
    if (!tag) return;
    scheduleHide();
  });

  function scheduleHide() {
    hideTimer = setTimeout(() => {
      document.querySelectorAll(".factura-tag").forEach(t => {
        bootstrap.Popover.getInstance(t)?.dispose();
      });
      popover = null;
      activo = false;
    }, 300);
  }
</script>
