<!-- ================= MODAL EXTRACTO DE PAGOS ================= -->
<div class="modal fade" id="extractoModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <!-- HEADER -->
      <div class="modal-header">
        <h5 class="modal-title fw-bold">
          Extracto financiero
        </h5>

        <div class="d-flex gap-2">
          <!-- ðŸ“¸ BOTÃ“N CAPTURA -->
          <button type="button"
                  id="btn-captura-extracto"
                  class="btn btn-outline-secondary btn-sm"
                  title="Copiar extracto como imagen">
            ðŸ“¸ Copiar
          </button>

          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"></button>
        </div>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- ðŸŽ¯ ZONA CAPTURABLE -->
        <div id="extracto-capturable">

          <!-- ================= RESUMEN FINANCIERO ================= -->
          <div class="row g-3 mb-4">

            <!-- CONTRATO -->
            <div class="col-md">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                  <small class="text-muted text-uppercase">Contrato</small>
                  <div id="resumen-contrato"
                       class="fw-semibold fs-6 text-primary mt-1">
                    â€”
                  </div>
                </div>
              </div>
            </div>

            <!-- ANTIGÃœEDAD -->
            <div class="col-md">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                  <small class="text-muted text-uppercase">AntigÃ¼edad</small>
                  <div id="resumen-antiguedad"
                       class="fw-bold fs-5 mt-1">
                    0 <small class="text-muted fs-6">dÃ­as</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- TARIFAS PAGADAS -->
            <div class="col-md">
              <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10">
                <div class="card-body py-3">
                  <small class="text-muted text-uppercase">Tarifas pagadas</small>
                  <div id="resumen-pagadas"
                       class="fw-bold fs-5 text-success mt-1">
                    0 cuotas
                  </div>
                </div>
              </div>
            </div>

            <!-- TARIFAS VENCIDAS -->
            <div class="col-md">
              <div class="card border-0 shadow-sm h-100 bg-danger bg-opacity-10">
                <div class="card-body py-3">
                  <small class="text-muted text-uppercase">Tarifas vencidas</small>
                  <div id="resumen-vencidas"
                       class="fw-bold fs-5 text-danger mt-1">
                    0 cuotas
                  </div>
                </div>
              </div>
            </div>

            <!-- DÃAS DE ATRASO -->
            <div class="col-md">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-3">
                  <small class="text-muted text-uppercase">Ciclos de atraso</small>
                  <div id="resumen-atraso"
                       class="fw-bold fs-5 mt-1">
                    0
                  </div>
                </div>
              </div>
            </div>

          </div>
          <!-- ================= FIN RESUMEN ================= -->

          <!-- ================= TABLA EXTRACTO ================= -->
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>Fecha pactada</th>
                  <th>Fecha pago</th>
                  <th class="text-end">Valor aplicado</th>
                  <th>Factura</th>
                </tr>
              </thead>

              <tbody id="extracto-body">
                <tr>
                  <td colspan="4"
                      class="text-center text-muted py-4">
                    Selecciona un contrato para ver el extracto
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- ================= FIN TABLA ================= -->

        </div>
        <!-- ðŸŽ¯ FIN CAPTURABLE -->

      </div>

    </div>
  </div>
</div>
<!-- ================= FIN MODAL ================= -->


<!-- ================= POPOVER FACTURAS ================= -->
<script>
  let popover = null;
  let hideTimer = null;
  let activo = false;

  document.addEventListener("mouseover", function (e) {
    const tag = e.target.closest(".factura-tag");
    if (!tag) return;

    if (hideTimer) clearTimeout(hideTimer);

    // ya activo sobre este tag â†’ no recrear
    if (activo && popover?._element === tag) return;

    // cerrar otros
    document.querySelectorAll(".factura-tag").forEach(t => {
      bootstrap.Popover.getInstance(t)?.dispose();
    });

    const facturaId = tag.dataset.facturaId;

    popover = new bootstrap.Popover(tag, {
      html: true,
      trigger: "manual",
      placement: "right",
      container: "body",
      content: `
        <div id="popover-content">
          <em class="text-muted">Cargando pagosâ€¦</em>
        </div>
      `,
    });

    popover.show();
    activo = true;

    // ðŸ” fetch SOLO actualiza contenido interno
    fetch(`/terminal_pagos/extracto/factura/${facturaId}/`)
      .then(res => res.json())
      .then(data => {
        const cont = document.getElementById("popover-content");
        if (!cont) return;

        let html = `
          <strong>Factura #${data.factura.id}</strong>
          <hr class="my-1">
        `;

        if (!data.pagos.length) {
          html += `<em class="text-muted">Sin pagos</em>`;
        } else {
          data.pagos.forEach(p => {
            html += `
              <div class="mb-2">
                <strong>${p.medio}</strong><br>
                <small class="text-muted">${p.canal}</small><br>
                $${Number(p.valor).toLocaleString("es-CO")}
                ${p.referencia ? `<br><small>Ref: ${p.referencia}</small>` : ""}
              </div>
            `;
          });
        }

        cont.innerHTML = html;

        // mantener hover sobre el popover
        const popEl = cont.closest(".popover");
        if (popEl) {
          popEl.addEventListener("mouseenter", () => {
            if (hideTimer) clearTimeout(hideTimer);
          });
          popEl.addEventListener("mouseleave", scheduleHide);
        }
      });
  });

  document.addEventListener("mouseout", function (e) {
    const tag = e.target.closest(".factura-tag");
    if (!tag) return;
    scheduleHide();
  });

  function scheduleHide() {
    hideTimer = setTimeout(() => {
      document.querySelectorAll(".factura-tag").forEach(t => {
        bootstrap.Popover.getInstance(t)?.dispose();
      });
      popover = null;
      activo = false;
    }, 300);
  }
</script>

<!-- ================= ACTUALIZAR RESUMEN MODAL ================= -->
<script>
  document.addEventListener("click", function (e) {
    const btn = e.target.closest(".btn-extracto");
    if (!btn) return;

    // ===== leer datos del botÃ³n =====
    const contrato = btn.dataset.contratoLabel;
    const dias = btn.dataset.dias;
    const pagadas = btn.dataset.cuotasPagadas;
    const vencidas = btn.dataset.cuotasVencidas;
    const saldoCuotas = parseFloat(btn.dataset.saldoCuotas || 0);

    // ===== pintar contrato =====
    document.getElementById("resumen-contrato").textContent = contrato;

    // ===== antigÃ¼edad =====
    document.getElementById("resumen-antiguedad").innerHTML =
      `${dias} <small class="text-muted">dÃ­as</small>`;

    // ===== tarifas pagadas =====
    document.getElementById("resumen-pagadas").textContent =
      `${pagadas} cuotas`;

    // ===== tarifas vencidas =====
    document.getElementById("resumen-vencidas").textContent =
      `${vencidas} cuotas`;

    // ===== dÃ­as de atraso (regla simple) =====
    document.getElementById("resumen-atraso").textContent =
      saldoCuotas > 0 ? saldoCuotas : 0;
  });
</script>

<!-- ================= CAPTURA DE EXTRACTO COMO IMAGEN ================= -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  document.getElementById("btn-captura-extracto")
    ?.addEventListener("click", async () => {

      const target = document.getElementById("extracto-capturable");
      if (!target) return;

      try {
        const canvas = await html2canvas(target, {
          backgroundColor: "#ffffff",
          scale: 2,              // mÃ¡s nitidez
          useCORS: true
        });

        canvas.toBlob(async blob => {
          if (!blob) return;

          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob })
          ]);

          // feedback visual rÃ¡pido
          const btn = document.getElementById("btn-captura-extracto");
          const original = btn.innerHTML;

          btn.innerHTML = "âœ… Copiado";
          btn.classList.remove("btn-outline-secondary");
          btn.classList.add("btn-outline-success");

          setTimeout(() => {
            btn.innerHTML = original;
            btn.classList.remove("btn-outline-success");
            btn.classList.add("btn-outline-secondary");
          }, 1500);
        });

      } catch (err) {
        alert("No se pudo copiar el extracto.");
        console.error(err);
      }
    });
</script>

<!-- ================= LIMPIAR MODAL AL CERRAR ================= -->
<script>
  const extractoModalEl = document.getElementById("extractoModal");

  extractoModalEl.addEventListener("hidden.bs.modal", () => {
    // ðŸ§¹ eliminar cualquier backdrop huÃ©rfano
    document.querySelectorAll(".modal-backdrop").forEach(b => b.remove());

    // ðŸ§¹ liberar scroll
    document.body.classList.remove("modal-open");
    document.body.style.removeProperty("padding-right");

    // ðŸ§¹ resetear contenido si quieres
    document.getElementById("extracto-body").innerHTML = `
      <tr>
        <td colspan="4" class="text-center text-muted py-4">
          Selecciona un contrato para ver el extracto
        </td>
      </tr>
    `;
  });
</script>
