{% extends "accounts/home.html" %}
{% block content %}

<div class="card p-4 shadow-sm">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0">Pagos registrados</h5>
  </div>

  <!-- ========================= -->
  <!-- FILTROS Y BUSCADOR -->
  <!-- ========================= -->
  <div class="row g-3 align-items-end mb-3">

    <!-- Buscador -->
    <div class="col-md-4">
      <input
        type="text"
        id="buscador-pagos"
        class="form-control"
        placeholder="Buscar por referencia o contrato (placa / cliente)">
    </div>

    <!-- Desde -->
    <div class="col-md-2">
      <label class="form-label">Desde</label>
      <input type="date" id="fecha-desde" class="form-control" value="{{ desde }}">
    </div>

    <!-- Hasta -->
    <div class="col-md-2">
      <label class="form-label">Hasta</label>
      <input type="date" id="fecha-hasta" class="form-control" value="{{ hasta }}">
    </div>

    <!-- Botón -->
    <div class="col-md-2">
      <button id="filtrar-fechas" class="btn btn-primary w-100">
        Filtrar
      </button>
    </div>

    <!-- Solo no validados -->
    <div class="col-md-2">
      <div class="form-check mt-4">
        <input
          class="form-check-input"
          type="checkbox"
          id="solo-no-validados">
        <label class="form-check-label" for="solo-no-validados">
          Solo no validados
        </label>
      </div>
    </div>

  </div>


  <!-- ========================= -->
  <!-- TABLA DE PAGOS -->
  <!-- ========================= -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Fecha</th>
          <th>Contrato</th>
          <th>Factura</th>
          <th>Medio</th>
          <th>Canal</th>
          <th>Cuenta</th>
          <th>Referencia</th>
          <th>Validado</th>
          <th class="text-end">Valor</th>
        </tr>
      </thead>
      <tbody id="tabla-pagos">
        {% for pago in pagos %}
        <tr>
          <td>{{ pago.fecha_pago|date:"Y-m-d" }}</td>

          <td>
            {{ pago.factura.contrato.vehiculo.placa }}<br>
            <small class="text-muted">
              {{ pago.factura.contrato.cliente.nombre }}
            </small>
          </td>

          <td>
            #{{ pago.factura.id }}<br>
            <small class="text-muted">
              {{ pago.factura.estado_pago }}
            </small>
          </td>

          <td>{{ pago.configuracion.medio.nombre }}</td>
          <td>{{ pago.canal.nombre }}</td>
          <td>{{ pago.configuracion.cuenta_destino.nombre }}</td>
          <td>{{ pago.referencia|default:"—" }}</td>
          <td class="text-end fw-semibold">
            {{ pago.valor }}
          </td>
          <td class="text-center">
            {% if pago.validado %}
              <span class="badge bg-success">Validado</span>
            {% else %}
              <button
                class="btn btn-sm btn-outline-primary validar-medio"
                data-pago-id="{{ pago.id }}">
                Validar
              </button>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted">
            No hay pagos registrados
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<script>
document.addEventListener("DOMContentLoaded", () => {

  const btn = document.getElementById("filtrar-fechas");

  btn?.addEventListener("click", () => {
    const desde = document.getElementById("fecha-desde").value;
    const hasta = document.getElementById("fecha-hasta").value;

    const params = new URLSearchParams();

    if (desde) params.append("desde", desde);
    if (hasta) params.append("hasta", hasta);

    window.location.search = params.toString();
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  document.querySelectorAll(".validar-medio").forEach(btn => {
    btn.addEventListener("click", () => {
      const pagoId = btn.dataset.pagoId;

      if (!confirm("¿Marcar este pago como VALIDADO?")) return;

      fetch(`/terminal_pagos/validar-medio/${pagoId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": document.getElementById("csrf-token").value
        }
      })
      .then(res => {
        if (!res.ok) throw new Error("Error en validación");
        window.location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("No se pudo validar el pago");
      });
    });
  });

});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {

  const buscador = document.getElementById("buscador-pagos");
  const filas = document.querySelectorAll("#tabla-pagos tr");

  buscador?.addEventListener("input", () => {
    const texto = buscador.value.toLowerCase();

    filas.forEach(fila => {
      const contenido = fila.innerText.toLowerCase();

      if (contenido.includes(texto)) {
        fila.style.display = "";
      } else {
        fila.style.display = "none";
      }
    });
  });

});

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const buscador = document.getElementById("buscador-pagos");
  const checkbox = document.getElementById("solo-no-validados");
  const filas = document.querySelectorAll("#tabla-pagos tr");

  function aplicarFiltros() {
    const texto = buscador.value.toLowerCase();
    const soloNoValidados = checkbox.checked;

    filas.forEach(fila => {
      const contenido = fila.innerText.toLowerCase();
      const esValidado = fila.querySelector(".badge.bg-success") !== null;

      let visible = true;

      // filtro texto
      if (texto && !contenido.includes(texto)) {
        visible = false;
      }

      // filtro validados
      if (soloNoValidados && esValidado) {
        visible = false;
      }

      fila.style.display = visible ? "" : "none";
    });
  }

  buscador?.addEventListener("input", aplicarFiltros);
  checkbox?.addEventListener("change", aplicarFiltros);

});
</script>

{% endblock %}
