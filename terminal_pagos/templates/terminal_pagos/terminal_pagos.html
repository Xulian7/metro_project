{% extends "accounts/home.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<!-- ========================= -->
<!-- Select2 CSS -->
<!-- ========================= -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold fs-5 mb-4">Nueva Transacci√≥n</h3>

  <form method="post" class="row g-3">
    {% csrf_token %}

    <!-- ========================= -->
    <!-- Contrato -->
    <!-- ========================= -->
    <div class="col-md-8">
      <label class="form-label">Contrato (Placa - Cliente)</label>
      {{ factura_form.contrato|add_class:"form-select select-buscable" }}
    </div>

    <div class="col-md-4 d-flex align-items-end justify-content-end">
      <button type="submit" class="btn btn-primary btn-app-action w-100">
        Guardar Factura
      </button>
    </div>

    <!-- ========================= -->
    <!-- √çtems -->
    <!-- ========================= -->
    <div class="col-12 mt-4">
      <h6 class="fw-bold mb-3">√çtems</h6>
    </div>

    {{ item_formset.management_form }}

    {% for form in item_formset %}
      <div class="row g-3 align-items-end border rounded p-3 mb-2 item-row">

        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          {{ form.tipo_item|add_class:"form-select tipo-item" }}
        </div>

        <div class="col-md-4">
          <label class="form-label">Descripci√≥n</label>
          {{ form.descripcion|add_class:"form-select descripcion-item" }}
        </div>

        <div class="col-md-2">
          <label class="form-label">Cantidad</label>
          {{ form.cantidad|add_class:"form-control cantidad-item" }}
        </div>

        <div class="col-md-2">
          <label class="form-label">Valor</label>
          {{ form.valor_unitario|add_class:"form-control valor-unitario-item" }}
        </div>

        <div class="col-md-2 text-end">
          {{ form.DELETE }}
        </div>

      </div>
    {% endfor %}

  </form>

</div>

<!-- ========================= -->
<!-- JS -->
<!-- ========================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  const productosAlmacen = {{ productos_json|safe }};

  /* =========================
     Select2 helper
  ========================= */
  function activarSelect2(selector, placeholder = 'Buscar...') {
    $(selector).select2({
      placeholder: placeholder,
      allowClear: true,
      width: '100%'
    });
  }

  /* =========================
     Ready
  ========================= */
  $(document).ready(function () {

    // Select2 inicial (Contrato y cualquier select-buscable inicial)
    activarSelect2('.select-buscable', 'Buscar por placa o cliente...');

    inicializarItems();

    $('select[name="contrato"]').on('change', function () {
      recalcularTodos();
    });
  });

  /* =========================
     Helpers
  ========================= */
  function getTarifaContrato() {
    const contrato = document.querySelector('select[name="contrato"]');
    if (!contrato || contrato.selectedIndex === -1) return 0;

    const option = contrato.options[contrato.selectedIndex];
    return parseFloat(option.dataset.tarifa || 0);
  }

  /* =========================
     √çtems
  ========================= */
  function inicializarItems() {
    document.querySelectorAll('.item-row').forEach(row => {
      const tipo = row.querySelector('.tipo-item');
      const descripcion = row.querySelector('.descripcion-item');
      const cantidad = row.querySelector('.cantidad-item');
      const valor = row.querySelector('.valor-unitario-item');

      if (!tipo || !descripcion || !cantidad || !valor) return;

      const aplicarLogica = () => {

        // üî• destruir Select2 si existe antes de tocar el HTML
        if ($(descripcion).hasClass('select2-hidden-accessible')) {
          $(descripcion).select2('destroy');
        }

        descripcion.innerHTML = '';

        /* ===== TARIFA ===== */
        if (tipo.value === 'tarifa') {
          descripcion.innerHTML =
            `<option value="tarifa">Pago de tarifa</option>`;
          descripcion.disabled = true;

          const tarifa = getTarifaContrato();
          const cant = parseFloat(cantidad.value || 0);
          valor.value = (tarifa * cant).toFixed(2);
        }

        /* ===== ALMAC√âN ===== */
        else if (tipo.value === 'almacen') {
          descripcion.disabled = false;
          descripcion.innerHTML =
            `<option value="">Seleccione producto</option>`;

          productosAlmacen.forEach(p => {
            descripcion.innerHTML +=
              `<option value="${p.id}">${p.nombre}</option>`;
          });

          activarSelect2(descripcion, 'Buscar producto...');
          valor.value = '';
        }

        /* ===== OTRO ===== */
        else {
          descripcion.disabled = false;
          descripcion.innerHTML =
            `<option value="">‚Äî</option>`;

          activarSelect2(descripcion, 'Buscar...');
          valor.value = '';
        }
      };

      /* =========================
         Eventos base
      ========================= */
      tipo.addEventListener('change', aplicarLogica);

      cantidad.addEventListener('input', function () {
        if (tipo.value === 'almacen' && descripcion.value) return;
        aplicarLogica();
      });

      /* =========================
         Precio por producto (almac√©n)
      ========================= */
      descripcion.addEventListener('change', function () {
        if (tipo.value !== 'almacen') return;
        if (!descripcion.value) return;

        const producto = productosAlmacen.find(
          p => String(p.id) === String(descripcion.value)
        );
        if (!producto) return;

        const cant = parseFloat(cantidad.value || 0);
        const precio = parseFloat(producto.precio_venta || 0);

        valor.value = (precio * cant).toFixed(2);
      });

      cantidad.addEventListener('input', function () {
        if (tipo.value !== 'almacen') return;
        if (!descripcion.value) return;

        const producto = productosAlmacen.find(
          p => String(p.id) === String(descripcion.value)
        );
        if (!producto) return;

        const cant = parseFloat(cantidad.value || 0);
        const precio = parseFloat(producto.precio_venta || 0);

        valor.value = (precio * cant).toFixed(2);
      });

      /* =========================
         üî• Inicializaci√≥n correcta
      ========================= */
      aplicarLogica();
    });
  }

  /* =========================
     Recalcular
  ========================= */
  function recalcularTodos() {
    document.querySelectorAll('.item-row .tipo-item').forEach(t => {
      t.dispatchEvent(new Event('change'));
    });
  }
</script>


{% endblock %}
