{% extends "accounts/home.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
  .item-row {
    animation: fadeInUp 0.25s ease-out;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .remove-item,
  .remove-pago {
    width: 32px;
    height: 32px;
    padding: 0;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .item-row,
  .pago-row {
    align-items: center;
  }
</style>

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Nueva Transacci√≥n</h3>

  <form method="post" 
    action="{% url 'terminal_pagos:crear_factura' %}"
    class="row g-3">
    {% csrf_token %}

    <!-- CONTRATO -->
    <div class="col-md-8">
      <label class="form-label">Contrato (Placa - Cliente)</label>
      {{ factura_form.contrato|add_class:"form-select select-buscable" }}
    </div>

    <div class="col-md-4 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        Guardar Factura
      </button>
    </div>

    <!-- √çTEMS -->
    <div class="col-12 mt-4 d-flex justify-content-between align-items-center">
      <h6 class="fw-bold mb-0">√çtems</h6>
      <button type="button"
              class="btn btn-outline-primary btn-sm"
              id="add-item">
        + Agregar √≠tem
      </button>
    </div>

    <div class="col-12">
      <div class="row text-muted fw-semibold small border-bottom pb-2 mb-2">
        <div class="col-md-2">Tipo</div>
        <div class="col-md-4">Descripci√≥n</div>
        <div class="col-md-2 text-center">Cantidad</div>
        <div class="col-md-2 text-end">Valor</div>
        <div class="col-md-2 text-center">Acci√≥n</div>
      </div>
    </div>


    {{ item_formset.management_form }}

    <!-- TEMPLATE ITEM -->
    <div id="empty-form" class="d-none">
      <div class="row align-items-center border rounded-3 px-3 py-2 mb-2 item-row bg-light"
           data-subtotal="0">

        <div class="col-md-2">
          {{ item_formset.empty_form.tipo_item|add_class:"form-select form-select-sm tipo-item" }}
        </div>

        <div class="col-md-4">
          {{ item_formset.empty_form.descripcion|add_class:"form-select form-select-sm descripcion-item" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.cantidad|add_class:"form-control form-control-sm cantidad-item text-center" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.valor_unitario|add_class:"form-control form-control-sm valor-unitario-item text-end" }}
        </div>

        <div class="col-md-2 d-flex justify-content-end">
          <button type="button"
                  class="btn btn-outline-danger btn-sm remove-item">
            ‚úñ
          </button>
        </div>

      </div>
    </div>

    <div id="items-container" class="col-12"></div>

    <!-- TOTALES -->
    <div class="col-12 mt-4">
      <div class="border-top pt-3 d-flex justify-content-end">
        <div class="text-end">

          <div class="d-flex justify-content-between gap-4 fs-5">
            <span>Total:</span>
            <strong id="total">$0</strong>
          </div>

        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- PAGOS -->
    <!-- ========================= -->
    <div class="col-12 mt-5 d-flex justify-content-between align-items-center">
      <h6 class="fw-bold mb-0">Pagos</h6>
      <button type="button"
              class="btn btn-outline-success btn-sm"
              id="add-pago">
        + Agregar pago
      </button>
    </div>

    <!-- ENCABEZADOS PAGOS -->
    <div class="col-12">
      <div class="row text-muted fw-semibold small border-bottom pb-2 mb-2">
        <div class="col-md-2">Medio</div>
        <div class="col-md-2">Origen</div>
        <div class="col-md-2">Cuenta</div>
        <div class="col-md-2">Fecha</div>
        <div class="col-md-2">Referencia</div>
        <div class="col-md-1 text-end">Valor</div>
        <div class="col-md-1 text-center">Acci√≥n</div>
      </div>
    </div>

    <style>
      .pago-row {
        display: grid;
        grid-template-columns:
          minmax(120px, 1.2fr)   /* Medio */
          minmax(120px, 1.2fr)   /* Origen */
          minmax(140px, 1.5fr)   /* Cuenta */
          minmax(130px, 1fr)     /* Fecha */
          minmax(160px, 1.5fr)   /* Referencia */
          minmax(100px, 0.8fr)   /* Valor */
          40px;                  /* Acci√≥n */
        gap: 0.5rem;
        align-items: end;
      }

      /* En ventanas angostas: refluye autom√°ticamente */
      @media (max-width: 1200px) {
        .pago-row {
          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
      }
    </style>


    <!-- ================= TEMPLATE PAGO (UX GUIADO) ================= -->
    <div id="empty-pago" class="d-none">
      <div class="pago-row border rounded-3 px-2 py-2 mb-2 bg-light">

        <select class="form-select form-select-sm pago-medio" name="medio_pago[]">
          <option value="">Medio</option>
        </select>

        <select class="form-select form-select-sm pago-canal" name="canal_pago[]">
          <option value="">Canal</option>
        </select>

        <select class="form-select form-select-sm pago-cuenta" name="cuenta_pago[]">
          <option value="">Cuenta destino</option>
        </select>

        <input type="date"
              class="form-control form-control-sm pago-fecha"
              name="fecha_pago[]"
              value="{{ today|date:'Y-m-d' }}">

        <input type="text"
              class="form-control form-control-sm pago-referencia"
              name="referencia_pago[]"
              placeholder="Referencia">

        <input type="number"
              step="0.01"
              min="0"
              class="form-control form-control-sm pago-valor text-end"
              name="valor_pago[]"
              placeholder="0.00">

        <button type="button"
                class="btn btn-outline-danger btn-sm remove-pago">
          ‚úñ
        </button>

        <input type="hidden"
              name="configuracion_pago_id[]"
              class="pago-config-id">
      </div>
    </div>




    <div id="pagos-container" class="col-12"></div>

    <!-- ================= RESUMEN PAGOS ================= -->
    <div class="col-12 mt-3">
      <div class="d-flex justify-content-end">
        <div class="text-end">
          <div class="d-flex justify-content-between gap-4">
            <span class="text-muted">Total pagado:</span>
            <strong id="total-pagado">$0</strong>
          </div>
          <div class="d-flex justify-content-between gap-4">
            <span class="text-muted">Saldo pendiente:</span>
            <strong id="saldo-pendiente">$0</strong>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{{ productos_json|json_script:"productos-almacen" }}
{{ servicios_json|json_script:"servicios-taller" }}
{{ configuraciones_json|json_script:"configuraciones-json" }}
{{ canales_json|json_script:"canales-json" }}



<script>
  const productosAlmacen = JSON.parse(document.getElementById('productos-almacen').textContent);
  const serviciosTaller = JSON.parse(document.getElementById('servicios-taller').textContent);

  $(document).ready(() => {
    $('.select-buscable').select2({ width:'100%', placeholder:'Buscar‚Ä¶', allowClear:true });
    $('select[name="contrato"]').on('change', recalcularTodos);
  });

  document.getElementById('add-item').addEventListener('click', () => {
    const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
    const index = parseInt(totalForms.value);

    const html = document.getElementById('empty-form').innerHTML
      .replace(/__prefix__/g, index);

    const container = document.getElementById('items-container');
    container.insertAdjacentHTML('beforeend', html);
    totalForms.value = index + 1;

    inicializarItem(container.lastElementChild);
  });

  const datosDescripcion = {
    tarifa: [{id:'tarifa', text:'Pago de tarifa', valor:0}],
    almacen: productosAlmacen.map(p => ({id:p.id, text:p.nombre, valor:p.precio_venta})),
    taller: serviciosTaller.map(s => ({id:s.id, text:s.nombre_servicio, valor:s.valor}))
  };

  function getTarifaContrato() {
    const sel = document.querySelector('select[name="contrato"]');
    return sel?.selectedOptions[0]?.dataset.tarifa || 0;
  }

  function cargarDescripcion(row) {
    const tipo = row.querySelector('.tipo-item');
    const desc = row.querySelector('.descripcion-item');
    const opciones = datosDescripcion[tipo.value] || [];

    desc.innerHTML = '';
    opciones.forEach(o => {
      const opt = document.createElement('option');
      if (tipo.value === 'tarifa') {
        opt.value = 'tarifa';
      } else {
        opt.value = `${tipo.value}:${o.id}`;
      }
      opt.textContent = o.text;
      opt.dataset.valor = o.valor;
      desc.appendChild(opt);
    });

    $(desc).select2({ width:'100%', placeholder:'Buscar‚Ä¶', allowClear:true });
  }

  function recalcularFila(row) {
    const tipo = row.querySelector('.tipo-item').value;
    const cant = parseFloat(row.querySelector('.cantidad-item').value || 0);
    let subtotal = 0;

    if (tipo === 'tarifa') {
      subtotal = getTarifaContrato() * cant;
    } else {
      const opt = row.querySelector('.descripcion-item').selectedOptions[0];
      subtotal = (opt?.dataset.valor || 0) * cant;
    }

    row.dataset.subtotal = subtotal;
    row.querySelector('.valor-unitario-item').value = subtotal ? subtotal.toFixed(2) : '';
    recalcularTotales();
  }

  function recalcularTotales() {
    let total = 0;
    document.querySelectorAll('.item-row').forEach(r => {
      total += parseFloat(r.dataset.subtotal || 0);
    });

    document.getElementById('total').innerText =
      total.toLocaleString('es-CO', { minimumFractionDigits: 2 });

    if (typeof recalcularResumen === "function") {
      recalcularResumen();
    }
  }


  $('#items-container')
    .on('change', '.tipo-item', function () {
      const row = this.closest('.item-row');
      cargarDescripcion(row);
      recalcularFila(row);
    })
    .on('input', '.cantidad-item', function () {
      recalcularFila(this.closest('.item-row'));
    })
    .on('select2:select select2:clear', '.descripcion-item', function () {
      recalcularFila(this.closest('.item-row'));
    })
    .on('click', '.remove-item', function () {
      this.closest('.item-row').remove();
      recalcularTotales();
    });

  function inicializarItem(row) {
    cargarDescripcion(row);
  }

  function recalcularTodos() {
    document.querySelectorAll('.item-row').forEach(recalcularFila);
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    /* =========================
      DATA DESDE BACKEND
    ========================= */
    let CONFIGS = [];
    let CANALES = [];

    try {
      const c1 = document.getElementById("configuraciones-json");
      const c2 = document.getElementById("canales-json");

      if (c1) CONFIGS = JSON.parse(c1.textContent);
      if (c2) CANALES = JSON.parse(c2.textContent);
    } catch (e) {
      console.error("Error leyendo JSONs de pago", e);
    }

    /* =========================
      ELEMENTOS BASE
    ========================= */
    const pagosContainer = document.getElementById("pagos-container");
    const addPagoBtn = document.getElementById("add-pago");
    const tpl = document.getElementById("empty-pago");

    if (!pagosContainer || !tpl) return;

    /* =========================
      HELPERS
    ========================= */
    function uniqueBy(arr, keyFn) {
      const map = new Map();
      arr.forEach(item => {
        const key = keyFn(item);
        if (!map.has(key)) map.set(key, item);
      });
      return Array.from(map.values());
    }

    /* =========================
      MEDIOS
    ========================= */
    function cargarMedios(select) {
      select.innerHTML = '<option value="">Medio</option>';

      const medios = uniqueBy(CONFIGS, c => c.medio_id);

      medios.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.medio_id;
        opt.textContent = m["medio__nombre"];
        select.appendChild(opt);
      });
    }

    /* =========================
      CUENTAS
    ========================= */
    function cargarCuentas(select, medioId, configIdInput) {
      select.innerHTML = '<option value="">Cuenta destino</option>';

      const cuentas = CONFIGS.filter(
        c => String(c.medio_id) === String(medioId)
      );

      cuentas.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c["cuenta_destino__nombre"];
        select.appendChild(opt);
      });

      if (cuentas.length > 0) {
        select.value = cuentas[0].id;
        configIdInput.value = cuentas[0].id;
      }
    }

    /* =========================
      CANALES
    ========================= */
    function cargarCanales(select, medioId) {
      select.innerHTML = '<option value="">Origen</option>';

      const canales = CANALES.filter(
        c => String(c.medio_id) === String(medioId) && c.activo
      );

      canales.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nombre;
        opt.dataset.referencia = c.requiere_referencia ? "1" : "0";
        select.appendChild(opt);
      });
    }

    /* =========================
      AGREGAR FILA
    ========================= */
    function agregarPago() {
      pagosContainer.insertAdjacentHTML("beforeend", tpl.innerHTML);
      const row = pagosContainer.lastElementChild;
      if (!row) return;

      const medioSel = row.querySelector(".pago-medio");
      const canalSel = row.querySelector(".pago-canal");
      const cuentaSel = row.querySelector(".pago-cuenta");
      const referenciaInput = row.querySelector(".pago-referencia");
      const configIdInput = row.querySelector(".pago-config-id");

      cargarMedios(medioSel);

      /* ---- CAMBIO DE MEDIO ---- */
      medioSel.addEventListener("change", () => {
        const medioId = medioSel.value;

        canalSel.innerHTML = '<option value="">Origen</option>';
        cuentaSel.innerHTML = '<option value="">Cuenta destino</option>';
        referenciaInput.value = "";
        configIdInput.value = "";

        if (!medioId) return;

        cargarCanales(canalSel, medioId);
        cargarCuentas(cuentaSel, medioId, configIdInput);
      });

      /* ---- CAMBIO DE CUENTA ---- */
      cuentaSel.addEventListener("change", () => {
        configIdInput.value = cuentaSel.value || "";
      });

      /* ---- CAMBIO DE CANAL ---- */
      canalSel.addEventListener("change", () => {
        const opt = canalSel.selectedOptions[0];
        if (!opt) return;

        if (opt.dataset.referencia !== "1") {
          referenciaInput.value = "";
        }
      });
    }

    /* =========================
      TOTALES
    ========================= */
    function recalcularPagos() {
      let totalPagado = 0;

      document.querySelectorAll(".pago-valor").forEach(i => {
        totalPagado += parseFloat(i.value || 0);
      });

      const totalPagadoEl = document.getElementById("total-pagado");
      if (totalPagadoEl) {
        totalPagadoEl.innerText = totalPagado.toLocaleString("es-CO", {
          minimumFractionDigits: 2
        });
      }

      // ===== SALDO PENDIENTE =====
      let totalFactura = 0;
      document.querySelectorAll(".item-row").forEach(r => {
        totalFactura += parseFloat(r.dataset.subtotal || 0);
      });

      const saldo = totalFactura - totalPagado;

      const saldoEl = document.getElementById("saldo-pendiente");
      if (saldoEl) {
        saldoEl.innerText = saldo.toLocaleString("es-CO", {
          minimumFractionDigits: 2
        });
      }
    }


    /* =========================
      EVENTOS
    ========================= */
    addPagoBtn?.addEventListener("click", agregarPago);

    pagosContainer.addEventListener("input", e => {
      if (e.target.classList.contains("pago-valor")) {
        recalcularPagos();
      }
    });

    pagosContainer.addEventListener("click", e => {
      if (e.target.classList.contains("remove-pago")) {
        e.target.closest(".pago-row")?.remove();
        recalcularPagos();
      }
    });

  });

  function recalcularResumen() {
    const totalFactura = Array.from(document.querySelectorAll('.item-row'))
      .reduce((acc, r) => acc + parseFloat(r.dataset.subtotal || 0), 0);

    const totalPagado = Array.from(document.querySelectorAll('.pago-valor'))
      .reduce((acc, i) => acc + parseFloat(i.value || 0), 0);

    const saldo = totalFactura - totalPagado;

    document.getElementById("total-pagado").innerText =
      totalPagado.toLocaleString("es-CO", { minimumFractionDigits: 2 });

    document.getElementById("saldo-pendiente").innerText =
      saldo.toLocaleString("es-CO", { minimumFractionDigits: 2 });
  }



</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    if (!form) return;

    form.addEventListener("submit", () => {

      // üîë Sincronizar configuraciones de pago antes de enviar
      document.querySelectorAll(".pago-row").forEach(row => {
        const cuentaSel = row.querySelector(".pago-cuenta");
        const configIdInput = row.querySelector(".pago-config-id");

        if (cuentaSel && configIdInput) {
          configIdInput.value = cuentaSel.value || "";
        }
      });

      // Nada m√°s: dejamos que el submit fluya normal
    });
  });
</script>


{% endblock %}
