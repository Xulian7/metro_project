{% extends "accounts/home.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Nueva Transacción</h3>

  <form method="post" class="row g-3">
    {% csrf_token %}

    <div class="col-md-8">
      <label class="form-label">Contrato (Placa - Cliente)</label>
      {{ factura_form.contrato|add_class:"form-select select-buscable" }}
    </div>

    <div class="col-md-4 d-flex align-items-end justify-content-end">
      <button type="submit" class="btn btn-primary btn-app-action w-100">
        Guardar Factura
      </button>
    </div>

    <div class="col-12 mt-4">
      <h6 class="fw-bold mb-3">Ítems</h6>
    </div>

    <div class="col-12 mb-2">
      <button type="button" class="btn btn-outline-secondary" id="add-item">
        + Agregar ítem
      </button>
    </div>

    {{ item_formset.management_form }}

    <div id="empty-form" class="d-none">
      <div class="row g-3 align-items-end border rounded p-3 mb-2 item-row">

        <div class="col-md-2">
          {{ item_formset.empty_form.tipo_item|add_class:"form-select tipo-item" }}
        </div>

        <div class="col-md-4">
          {{ item_formset.empty_form.descripcion|add_class:"form-select descripcion-item" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.cantidad|add_class:"form-control cantidad-item" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.valor_unitario|add_class:"form-control valor-unitario-item" }}
        </div>

        <div class="col-md-2 text-end">
          {{ item_formset.empty_form.DELETE }}
        </div>

      </div>
    </div>

    <div id="items-container" class="col-12"></div>

  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{{ productos_json|json_script:"productos-almacen" }}
{{ servicios_json|json_script:"servicios-taller" }}

<script>
const productosAlmacen = JSON.parse(document.getElementById('productos-almacen').textContent);
const serviciosTaller = JSON.parse(document.getElementById('servicios-taller').textContent);

// Inicializa select contrato
$(document).ready(function () {
  $('.select-buscable').select2({
    placeholder: 'Buscar por placa o cliente...',
    allowClear: true,
    width: '100%'
  });

  // Recalcular tarifas si cambia contrato
  $('select[name="contrato"]').on('change', recalcularTodos);
});

// Agregar item dinámico
document.getElementById('add-item').addEventListener('click', function () {
  const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
  const totalForms = parseInt(totalFormsInput.value);

  const emptyFormHtml = document.getElementById('empty-form')
    .innerHTML
    .replace(/__prefix__/g, totalForms);

  const container = document.getElementById('items-container');
  container.insertAdjacentHTML('beforeend', emptyFormHtml);
  totalFormsInput.value = totalForms + 1;

  // Inicializar el nuevo row
  const newRow = container.querySelectorAll('.item-row');
  setTimeout(() => inicializarItem(newRow[newRow.length - 1]), 0);
});

// =========================
// Funciones de utilidad
// =========================
function getTarifaContrato() {
  const contrato = document.querySelector('select[name="contrato"]');
  if (!contrato || contrato.selectedIndex === -1) return 0;
  return parseFloat(contrato.options[contrato.selectedIndex].dataset.tarifa || 0);
}

function cargarDescripcion(row) {
  const tipo = row.querySelector('.tipo-item');
  const descripcion = row.querySelector('.descripcion-item');
  if (!tipo || !descripcion) return;

  if ($(descripcion).hasClass('select2-hidden-accessible')) $(descripcion).select2('destroy');

  descripcion.innerHTML = '';
  descripcion.disabled = false;

  if (tipo.value === 'tarifa') {
    descripcion.innerHTML = `<option value="tarifa">Pago de tarifa</option>`;
    descripcion.disabled = true;
  } else if (tipo.value === 'almacen') {
    descripcion.innerHTML = `<option value="">Seleccione producto</option>`;
    productosAlmacen.forEach(p => {
      descripcion.innerHTML += `<option value="${p.id}" data-valor="${p.precio_venta}">${p.nombre}</option>`;
    });
  } else if (tipo.value === 'taller') {
    descripcion.innerHTML = `<option value="">Seleccione servicio</option>`;
    serviciosTaller.forEach(s => {
      descripcion.innerHTML += `<option value="${s.id}" data-valor="${s.valor}">${s.nombre_servicio}</option>`;
    });
  } else {
    descripcion.innerHTML = `<option value="">—</option>`;
  }

  if (!descripcion.disabled) {
    $(descripcion).select2({ placeholder: 'Buscar…', allowClear: true, width: '100%' });
  }
}

function recalcularFila(row) {
  const tipo = row.querySelector('.tipo-item');
  const descripcion = row.querySelector('.descripcion-item');
  const cantidad = row.querySelector('.cantidad-item');
  const valor = row.querySelector('.valor-unitario-item');
  if (!tipo || !descripcion || !cantidad || !valor) return;

  let total = 0;
  const cant = parseFloat(cantidad.value || 0);

  if (tipo.value === 'tarifa') total = getTarifaContrato() * cant;
  else {
    const selected = descripcion.options[descripcion.selectedIndex];
    if (selected) total = (parseFloat(selected.dataset.valor || 0)) * cant;
  }

  valor.value = total ? total.toFixed(2) : '';
}

// Delegación de eventos
$('#items-container')
  .on('change', '.tipo-item', function () {
    const row = this.closest('.item-row');
    cargarDescripcion(row);
    recalcularFila(row);
  })
  .on('input', '.cantidad-item', function () {
    const row = this.closest('.item-row');
    recalcularFila(row);
  })
  .on('select2:select select2:clear', '.descripcion-item', function () {
    const row = this.closest('.item-row');
    recalcularFila(row);
  });

// Inicialización individual
function inicializarItem(row) {
  cargarDescripcion(row);
  recalcularFila(row);
}

// Recalculo global
function recalcularTodos() {
  document.querySelectorAll('.item-row').forEach(row => recalcularFila(row));
}
</script>

{% endblock %}
