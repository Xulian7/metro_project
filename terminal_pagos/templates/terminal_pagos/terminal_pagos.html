{% extends "accounts/home.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
  .item-row {
    animation: fadeInUp 0.25s ease-out;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .remove-item,
  .remove-pago {
    width: 32px;
    height: 32px;
    padding: 0;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .item-row,
  .pago-row {
    align-items: center;
  }

</style>

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Nueva Transacci√≥n</h3>

  <form id="factura-form" method="post" 
    action="{% url 'terminal_pagos:crear_factura' %}"
    class="row g-3">
    {% csrf_token %}

    <!-- CONTRATO -->
    <div class="col-md-8">
      <label class="form-label">Contrato (Placa - Cliente)</label>
      {{ factura_form.contrato|add_class:"form-select select-buscable" }}
    </div>

    <!-- BOTONES ACCI√ìN -->
    <div class="col-md-4 d-flex align-items-end gap-2">
  
      <!-- Guardar -->
      <button type="submit"
              class="btn btn-primary flex-fill">
        Guardar Factura
      </button>

      <!-- Visor -->
      <a href="{% url 'terminal_pagos:visor_facturas' %}"
        class="btn btn-outline-secondary flex-fill"
        title="Ir al visor de facturas">
        üìÑ Ver facturas
      </a>

    </div>

    <!-- √çTEMS -->
    <div class="col-12 mt-4 d-flex justify-content-between align-items-center">
      <h6 class="fw-bold mb-0">√çtems</h6>
      <button type="button"
              class="btn btn-outline-primary btn-sm"
              id="add-item">
        + Agregar √≠tem
      </button>
    </div>

    <div class="col-12">
      <div class="row text-muted fw-semibold small border-bottom pb-2 mb-2">
        <div class="col-md-2">Tipo</div>
        <div class="col-md-4">Descripci√≥n</div>
        <div class="col-md-2 text-center">Cantidad</div>
        <div class="col-md-2 text-end">Valor</div>
        <div class="col-md-2 text-center">Acci√≥n</div>
      </div>
    </div>


    {{ item_formset.management_form }}

    <!-- TEMPLATE ITEM -->
    <div id="empty-form" class="d-none">
      <div class="row align-items-center border rounded-3 px-3 py-2 mb-2 item-row bg-light"
           data-subtotal="0">

        <div class="col-md-2">
          {{ item_formset.empty_form.tipo_item|add_class:"form-select form-select-sm tipo-item" }}
        </div>

        <div class="col-md-4">
          {{ item_formset.empty_form.descripcion|add_class:"form-select form-select-sm descripcion-item" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.cantidad|add_class:"form-control form-control-sm cantidad-item text-center" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.valor_unitario|add_class:"form-control form-control-sm valor-unitario-item text-end" }}
        </div>

        <div class="col-md-2 d-flex justify-content-end">
          <button type="button"
                  class="btn btn-outline-danger btn-sm remove-item">
            ‚úñ
          </button>
        </div>

      </div>
    </div>

    <div id="items-container" class="col-12"></div>

    <!-- TOTALES -->
    <div class="col-12 mt-4">
      <div class="border-top pt-3 d-flex justify-content-end">
        <div class="text-end">

          <div class="d-flex justify-content-between gap-4 fs-5">
            <span>Total:</span>
            <strong id="total">$0</strong>
          </div>

        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- PAGOS -->
    <!-- ========================= -->
    <div class="col-12 mt-5 d-flex justify-content-between align-items-center">
      <h6 class="fw-bold mb-0">Pagos</h6>
      <button type="button"
              class="btn btn-outline-success btn-sm"
              id="add-pago">
        + Agregar pago
      </button>
    </div>

    <!-- ENCABEZADOS PAGOS -->
    <div class="col-12">
      <div class="row text-muted fw-semibold small border-bottom pb-2 mb-2">
        <div class="col-md-2">Medio</div>
        <div class="col-md-2">Origen</div>
        <div class="col-md-2">Cuenta</div>
        <div class="col-md-2">Fecha</div>
        <div class="col-md-2">Referencia</div>
        <div class="col-md-1 text-end">Valor</div>
        <div class="col-md-1 text-center">Acci√≥n</div>
      </div>
    </div>

    <!-- ================= TEMPLATE PAGO (UX GUIADO) ================= -->
    <div id="empty-pago" class="d-none">
      <div class="row align-items-center g-2 border rounded-3 px-2 py-2 mb-2 pago-row bg-light">

        <div class="col">
          <select class="form-select form-select-sm pago-medio" name="medio_pago[]">
            <option value="">Medio</option>
          </select>
        </div>

        <div class="col">
          <select class="form-select form-select-sm pago-canal" name="canal_pago[]">
            <option value="">Canal</option>
          </select>
        </div>

        <div class="col">
          <select class="form-select form-select-sm pago-cuenta" name="cuenta_pago[]">
            <option value="">Cuenta destino</option>
          </select>
        </div>

        <div class="col">
          <input type="date"
                class="form-control form-control-sm pago-fecha"
                name="fecha_pago[]"
                value="{{ today|date:'Y-m-d' }}">
        </div>

        <div class="col">
          <input type="text"
                class="form-control form-control-sm pago-referencia d-none"
                name="referencia_pago[]"
                placeholder="Referencia">
        </div>

        <div class="col">
          <input type="number"
                step="1000"
                min="0"
                class="form-control form-control-sm pago-valor text-end d-none"
                name="valor_pago[]"
                placeholder="">
        </div>

        <div class="col-auto d-flex justify-content-center">
          <button type="button"
                  class="btn btn-outline-danger btn-sm remove-pago">
            ‚úñ
          </button>
        </div>

        <input type="hidden"
              name="configuracion_pago_id[]"
              class="pago-config-id">
      </div>
    </div>


    <div class="col-12">
      <div class="w-100 overflow-auto">
        <div id="pagos-container"></div>
      </div>
    </div>

    <!-- ================= RESUMEN PAGOS ================= -->
    <div class="col-12 mt-3">
      <div class="d-flex justify-content-end">
        <div class="text-end">
          <div class="d-flex justify-content-between gap-4">
            <span class="text-muted">Total pagado:</span>
            <strong id="total-pagado">$0</strong>
          </div>
          <div class="d-flex justify-content-between gap-4">
            <span class="text-muted">Saldo pendiente:</span>
            <strong id="saldo-pendiente">$0</strong>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- ================= MODAL FACTURA ================= -->
  {% if factura %}
  <div class="modal fade" id="facturaModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">

        <!-- ================= HEADER ================= -->
        <div class="modal-header align-items-start">
          <div class="d-flex gap-3 align-items-center">
            <img src="{% static 'accounts/empresa-2.png' %}"
                alt="Empresa"
                style="height:50px;">
            <div>
              <h5 class="modal-title mb-0">
                Factura #{{ factura.id }}
              </h5>
              <small class="text-muted">
                {{ factura.fecha|date:"d/m/Y H:i" }}
              </small>
            </div>
          </div>

          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"></button>
        </div>

        <!-- ================= BODY ================= -->
        <div class="modal-body">

          <!-- DATOS GENERALES -->
          <div class="card card-body mb-3 py-2">
            <div class="row small align-items-center">
              <div class="col-md-6">
                <strong>Contrato:</strong><br>
                {{ factura.contrato }}
              </div>
              <div class="col-md-6 text-md-end">
                <strong>Estado:</strong><br>
                <span class="badge
                  {% if factura.estado_pago == 'Pagada' %}
                    bg-success
                  {% elif factura.estado_pago == 'Parcial' %}
                    bg-warning text-dark
                  {% else %}
                    bg-danger
                  {% endif %}
                ">
                  {{ factura.get_estado_pago_display }}
                </span>
              </div>
            </div>
          </div>

          <!-- ================= DETALLE ================= -->
          <h6 class="fw-bold text-uppercase small mb-2">
            Detalle
          </h6>

          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Descripci√≥n</th>
                <th class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {% for i in factura.items.all %}
              <tr>
                <td>{{ i.descripcion }}</td>
                <td class="text-end">
                  ${{ i.subtotal|floatformat:0 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- ================= PAGOS ================= -->
          <h6 class="fw-bold text-uppercase small mt-4 mb-2">
            Pagos recibidos
          </h6>

          {% if factura.pagos.all %}
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Medio</th>
                <th>Canal</th>
                <th>Referencia</th>
                <th class="text-end">Valor</th>
              </tr>
            </thead>
            <tbody>
              {% for p in factura.pagos.all %}
              <tr>
                <td>{{ p.configuracion.medio.nombre }}</td>
                <td>{{ p.canal.nombre }}</td>
                <td class="text-muted">
                  {{ p.referencia|default:"‚Äî" }}
                </td>
                <td class="text-end">
                  ${{ p.valor|floatformat:0 }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
            <p class="text-muted fst-italic">
              No se registraron pagos en esta factura.
            </p>
          {% endif %}

          <!-- ================= TOTALES ================= -->
          <div class="border-top pt-3 mt-4">
            <div class="row justify-content-end">
              <div class="col-md-6">
                <div class="d-flex justify-content-between">
                  <span>Total</span>
                  <strong>
                    ${{ factura.total|floatformat:0 }}
                  </strong>
                </div>
                <div class="d-flex justify-content-between text-muted">
                  <span>Pagado</span>
                  <span>
                    ${{ factura.total_pagado|floatformat:0 }}
                  </span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- ================= FOOTER ================= -->
        <div class="modal-footer">
          <button type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">
            Cerrar
          </button>
          <button type="button"
                  class="btn btn-primary"
                  id="btn-imprimir-factura">
            üñ®Ô∏è Imprimir / Copiar
          </button>
        </div>

      </div>
    </div>
  </div>
  {% endif %}

  <!-- ================= SCRIPT MODAL FACTURA ================= -->
  {% if factura %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const modal = new bootstrap.Modal(
          document.getElementById("facturaModal")
        );
        modal.show();

        // üßº limpia ?factura= del URL sin recargar
        const url = new URL(window.location);
        url.searchParams.delete("factura");
        window.history.replaceState({}, "", url);
      });
    </script>
  {% endif %}

  <!-- ================= SCRIPT SUBMIT FACTURA ================= -->
  <script>
    const form = document.getElementById("factura-form");

    form.addEventListener("submit", async function (e) {

      // ‚õî cortar submit nativo
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      // ======================
      // 1Ô∏è‚É£ VALIDAR REFERENCIAS
      // ======================
      const referencias = Array.from(
        document.querySelectorAll(".pago-referencia")
      )
      .map(i => i.value.trim())
      .filter(v => v.length > 0);

      for (const ref of referencias) {
        const res = await fetch(
          `/terminal_pagos/validar-referencia/?referencia=${encodeURIComponent(ref)}`
        );
        const data = await res.json();

        if (!data.ok) {
          alert(
            `‚ùå La referencia "${ref}" ya fue utilizada.\n\n` +
            `Cliente: ${data.cliente}\n` +
            `Veh√≠culo: ${data.vehiculo}\n\n` +
            `Contrato #${data.contrato_id}\n` +
            `Factura #${data.factura_id}\n` +
            `Pago #${data.pago_id}`
          );
          return false;
        }
      }

      // ======================
      // 2Ô∏è‚É£ VALIDAR TOTALES
      // ======================
      const totalFactura = Array.from(document.querySelectorAll(".item-row"))
        .reduce((acc, r) => acc + parseFloat(r.dataset.subtotal || 0), 0);

      const totalPagado = Array.from(document.querySelectorAll(".pago-valor"))
        .reduce((acc, i) => acc + parseFloat(i.value || 0), 0);

      const tf = Number(totalFactura.toFixed(2));
      const tp = Number(totalPagado.toFixed(2));

      if (tp !== tf) {
        alert(
          tp < tf
            ? "‚ùå El total pagado no cubre el total de la factura."
            : "‚ùå El total pagado excede el total de la factura."
        );
        return false;
      }

      // ======================
      // 3Ô∏è‚É£ CONFIRMACI√ìN
      // ======================
      const ok = confirm(
        `¬øConfirmas guardar la factura?\n\n` +
        `Total factura: $${tf.toLocaleString("es-CO")}\n` +
        `Total pagado:  $${tp.toLocaleString("es-CO")}`
      );

      if (!ok) return false;

      // ======================
      // 4Ô∏è‚É£ SINCRONIZAR CONFIG
      // ======================
      document.querySelectorAll(".pago-row").forEach(row => {
        const cuentaSel = row.querySelector(".pago-cuenta");
        const configIdInput = row.querySelector(".pago-config-id");
        if (cuentaSel && configIdInput) {
          configIdInput.value = cuentaSel.value || "";
        }
      });

      // ======================
      // 5Ô∏è‚É£ SUBMIT REAL
      // ======================
      form.submit();
    });
 </script>


  <!-- ================= SCRIPT COPIAR FACTURA ================= -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const btn = document.getElementById("btn-imprimir-factura");
      if (!btn) return;

      btn.addEventListener("click", async () => {

        const modal = document.querySelector("#facturaModal .modal-content");
        if (!modal) return;

        try {
          const canvas = await html2canvas(modal, {
            backgroundColor: "#ffffff",
            scale: 2
          });

          canvas.toBlob(async blob => {
            if (!blob) return;

            await navigator.clipboard.write([
              new ClipboardItem({ "image/png": blob })
            ]);

            alert("üìã Factura copiada al portapapeles.\nP√©gala donde quieras.");
          });

        } catch (err) {
          console.error(err);
          alert("‚ùå No se pudo copiar la factura.");
        }

      });

    });
  </script>

</div>

<!-- ================= SCRIPTS EXTERNOS ================= -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- ================= DATOS JSON ================= -->
{{ productos_json|json_script:"productos-almacen" }}
{{ servicios_json|json_script:"servicios-taller" }}
{{ creditos_json|json_script:"creditos-activos" }}
{{ configuraciones_json|json_script:"configuraciones-json" }}
{{ canales_json|json_script:"canales-json" }}


<!-- ================= SCRIPT GESTI√ìN √çTEMS ================= -->
<script>
  const productosAlmacen = JSON.parse(document.getElementById('productos-almacen').textContent);
  const serviciosTaller = JSON.parse(document.getElementById('servicios-taller').textContent);
  const creditosActivos = JSON.parse(document.getElementById('creditos-activos').textContent);

  $(document).ready(() => {
    $('.select-buscable').select2({ width:'100%', placeholder:'Buscar‚Ä¶', allowClear:true });
    $('select[name="contrato"]').on('change', recalcularTodos);
  });

  document.getElementById('add-item').addEventListener('click', () => {
    const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
    const index = parseInt(totalForms.value);

    const html = document.getElementById('empty-form').innerHTML
      .replace(/__prefix__/g, index);

    const container = document.getElementById('items-container');
    container.insertAdjacentHTML('beforeend', html);
    totalForms.value = index + 1;

    inicializarItem(container.lastElementChild);
  });

  const datosDescripcion = {
    tarifa: [{id:'tarifa', text:'Pago de tarifa', valor:0}],
    almacen: productosAlmacen.map(p => ({id:p.id, text:p.nombre, valor:p.precio_venta})),
    taller: serviciosTaller.map(s => ({id:s.id, text:s.nombre_servicio, valor:s.valor})),
    abono_credito: creditosActivos.map(c => ({
      id: c.id,
      text: `Cr√©dito #${c.id} ¬∑ ${c["contrato__cliente__nombre"]} ¬∑ ${c["contrato__vehiculo__placa"]}`,
      valor: c.saldo
    }))

  };

  function getTarifaContrato() {
    const sel = document.querySelector('select[name="contrato"]');
    return sel?.selectedOptions[0]?.dataset.tarifa || 0;
  }

  function cargarDescripcion(row) {
    const tipo = row.querySelector('.tipo-item');
    const desc = row.querySelector('.descripcion-item');
    const valorInput = row.querySelector('.valor-unitario-item');

    const opciones = datosDescripcion[tipo.value] || [];

    // ---- reset descripci√≥n ----
    desc.innerHTML = '';
    opciones.forEach(o => {
      const opt = document.createElement('option');
      if (tipo.value === 'tarifa') {
        opt.value = 'tarifa';
      } else {
        opt.value = `${tipo.value}:${o.id}`;
      }
      opt.textContent = o.text;
      opt.dataset.valor = o.valor;
      desc.appendChild(opt);
    });

    // ---- reset valor manual ----
    valorInput.dataset.manual = "0";
    valorInput.value = "";

    // ---- reset subtotal frontend ----
    row.dataset.subtotal = "0";

    // ---- reinicializar select2 ----
    if ($(desc).hasClass("select2-hidden-accessible")) {
      $(desc).select2("destroy");
    }

    $(desc).select2({
      width: '100%',
      placeholder: 'Buscar‚Ä¶',
      allowClear: true
    });
  }


  function recalcularFila(row) {
    const tipo = row.querySelector('.tipo-item').value;
    const cant = parseFloat(row.querySelector('.cantidad-item').value || 0);
    const valorInput = row.querySelector('.valor-unitario-item');

    let subtotal = 0;

    // üëá SI el usuario escribi√≥ manualmente un valor
    if (valorInput.dataset.manual === "1") {
      const manualValue = parseFloat(valorInput.value || 0);
      subtotal = manualValue;
    } else {
      // üëá comportamiento normal
      if (tipo === 'tarifa') {
        subtotal = getTarifaContrato() * cant;
      } else {
        const opt = row.querySelector('.descripcion-item').selectedOptions[0];
        subtotal = (opt?.dataset.valor || 0) * cant;
      }

      valorInput.value = subtotal ? subtotal.toFixed(2) : '';
    }

    row.dataset.subtotal = subtotal;
    recalcularTotales();
  }


  function recalcularTotales() {
    let total = 0;
    document.querySelectorAll('.item-row').forEach(r => {
      total += parseFloat(r.dataset.subtotal || 0);
    });

    document.getElementById('total').innerText =
      total.toLocaleString('es-CO', { minimumFractionDigits: 2 });

    if (typeof recalcularResumen === "function") {
      recalcularResumen();
    }
  }


  $('#items-container')
    .on('change', '.tipo-item', function () {
      const row = this.closest('.item-row');
      cargarDescripcion(row);
      recalcularFila(row);
    })
    .on('input', '.cantidad-item', function () {
      recalcularFila(this.closest('.item-row'));
    })
    // üëá NUEVO: detectar edici√≥n manual del valor
    .on('input', '.valor-unitario-item', function () {
      const row = this.closest('.item-row');
      this.dataset.manual = "1";
      recalcularFila(row);
    })
    .on('select2:select select2:clear', '.descripcion-item', function () {
      recalcularFila(this.closest('.item-row'));
    })
    .on('click', '.remove-item', function () {
      this.closest('.item-row').remove();
      recalcularTotales();
    });


  function inicializarItem(row) {
    cargarDescripcion(row);
  }

  function recalcularTodos() {
    document.querySelectorAll('.item-row').forEach(recalcularFila);
  }
</script>

<!-- ================= SCRIPT GESTI√ìN PAGOS ================= -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    /* =========================
      DATA DESDE BACKEND
    ========================= */
    let CONFIGS = [];
    let CANALES = [];

    try {
      const c1 = document.getElementById("configuraciones-json");
      const c2 = document.getElementById("canales-json");

      if (c1) CONFIGS = JSON.parse(c1.textContent);
      if (c2) CANALES = JSON.parse(c2.textContent);
    } catch (e) {
      console.error("Error leyendo JSONs de pago", e);
    }

    /* =========================
      ELEMENTOS BASE
    ========================= */
    const pagosContainer = document.getElementById("pagos-container");
    const addPagoBtn = document.getElementById("add-pago");
    const tpl = document.getElementById("empty-pago");

    if (!pagosContainer || !tpl) return;

    /* =========================
      HELPERS
    ========================= */
    function uniqueBy(arr, keyFn) {
      const map = new Map();
      arr.forEach(item => {
        const key = keyFn(item);
        if (!map.has(key)) map.set(key, item);
      });
      return Array.from(map.values());
    }

    /* =========================
      MEDIOS
    ========================= */
    function cargarMedios(select) {
      select.innerHTML = '<option value="">Medio</option>';

      const medios = uniqueBy(CONFIGS, c => c.medio_id);

      medios.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.medio_id;
        opt.textContent = m["medio__nombre"];
        select.appendChild(opt);
      });
    }

    /* =========================
      CUENTAS
    ========================= */
    function cargarCuentas(select, medioId, configIdInput) {
      select.innerHTML = '<option value="">Cuenta destino</option>';

      const cuentas = CONFIGS.filter(
        c => String(c.medio_id) === String(medioId)
      );

      cuentas.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c["cuenta_destino__nombre"];
        select.appendChild(opt);
      });

      if (cuentas.length > 0) {
        select.value = cuentas[0].id;
        configIdInput.value = cuentas[0].id;
      }
    }

    /* =========================
      CANALES
    ========================= */
    function cargarCanales(select, medioId) {
      select.innerHTML = '<option value="">Origen</option>';

      const canales = CANALES.filter(
        c => String(c.medio_id) === String(medioId) && c.activo
      );

      canales.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nombre;
        opt.dataset.referencia = c.requiere_referencia ? "1" : "0";
        select.appendChild(opt);
      });
    }

    /* =========================
      AGREGAR FILA
    ========================= */
    function agregarPago() {
      pagosContainer.insertAdjacentHTML("beforeend", tpl.innerHTML);
      const row = pagosContainer.lastElementChild;
      if (!row) return;

      const medioSel = row.querySelector(".pago-medio");
      const canalSel = row.querySelector(".pago-canal");
      const cuentaSel = row.querySelector(".pago-cuenta");
      const referenciaInput = row.querySelector(".pago-referencia");
      const configIdInput = row.querySelector(".pago-config-id");

      cargarMedios(medioSel);

      /* ---- CAMBIO DE MEDIO ---- */
      medioSel.addEventListener("change", () => {
        const medioId = medioSel.value;

        canalSel.innerHTML = '<option value="">Origen</option>';
        cuentaSel.innerHTML = '<option value="">Cuenta destino</option>';
        referenciaInput.value = "";
        configIdInput.value = "";

        if (!medioId) return;

        cargarCanales(canalSel, medioId);
        cargarCuentas(cuentaSel, medioId, configIdInput);
      });

      /* ---- CAMBIO DE CUENTA ---- */
      cuentaSel.addEventListener("change", () => {
        configIdInput.value = cuentaSel.value || "";
      });

      /* ---- CAMBIO DE CANAL ---- */
      canalSel.addEventListener("change", () => {
        const opt = canalSel.selectedOptions[0];
        if (!opt) return;

        if (opt.dataset.referencia !== "1") {
          referenciaInput.value = "";
        }
      });
    }

    /* =========================
      TOTALES
    ========================= */
    function recalcularPagos() {
      let totalPagado = 0;

      document.querySelectorAll(".pago-valor").forEach(i => {
        totalPagado += parseFloat(i.value || 0);
      });

      const totalPagadoEl = document.getElementById("total-pagado");
      if (totalPagadoEl) {
        totalPagadoEl.innerText = totalPagado.toLocaleString("es-CO", {
          minimumFractionDigits: 2
        });
      }

      // ===== SALDO PENDIENTE =====
      let totalFactura = 0;
      document.querySelectorAll(".item-row").forEach(r => {
        totalFactura += parseFloat(r.dataset.subtotal || 0);
      });

      const saldo = totalFactura - totalPagado;

      const saldoEl = document.getElementById("saldo-pendiente");
      if (saldoEl) {
        saldoEl.innerText = saldo.toLocaleString("es-CO", {
          minimumFractionDigits: 2
        });
      }
    }


    /* =========================
      EVENTOS
    ========================= */
    addPagoBtn?.addEventListener("click", agregarPago);

    pagosContainer.addEventListener("input", e => {
      if (e.target.classList.contains("pago-valor")) {
        recalcularPagos();
      }
    });

    pagosContainer.addEventListener("click", e => {
      if (e.target.classList.contains("remove-pago")) {
        e.target.closest(".pago-row")?.remove();
        recalcularPagos();
      }
    });

  });

  function recalcularResumen() {
    const totalFactura = Array.from(document.querySelectorAll('.item-row'))
      .reduce((acc, r) => acc + parseFloat(r.dataset.subtotal || 0), 0);

    const totalPagado = Array.from(document.querySelectorAll('.pago-valor'))
      .reduce((acc, i) => acc + parseFloat(i.value || 0), 0);

    const saldo = totalFactura - totalPagado;

    document.getElementById("total-pagado").innerText =
      totalPagado.toLocaleString("es-CO", { minimumFractionDigits: 2 });

    document.getElementById("saldo-pendiente").innerText =
      saldo.toLocaleString("es-CO", { minimumFractionDigits: 2 });
  }

</script>

<!-- ================= SCRIPT VALIDACI√ìN UX GUIADA PAGOS ================= -->
<script>
  document.addEventListener("input", (e) => {

    const row = e.target.closest(".pago-row");
    if (!row) return;

    const medio      = row.querySelector(".pago-medio");
    const canal      = row.querySelector(".pago-canal");
    const cuenta     = row.querySelector(".pago-cuenta");
    const fecha      = row.querySelector(".pago-fecha");
    const referencia = row.querySelector(".pago-referencia");
    const valor      = row.querySelector(".pago-valor");

    if (!medio || !canal || !cuenta || !fecha || !referencia || !valor) return;

    /* ===============================
      1Ô∏è‚É£ ¬øCanal exige referencia?
    ================================ */
    const selectedOption = canal.options[canal.selectedIndex];
    const exigeReferencia =
      selectedOption?.dataset.referencia === "1";

    /* ===============================
      2Ô∏è‚É£ Mostrar / ocultar REFERENCIA
    ================================ */
    referencia.classList.toggle("d-none", !exigeReferencia);

    if (!exigeReferencia) {
      referencia.value = "";
    }

    /* ===============================
      3Ô∏è‚É£ Campos base completos
    ================================ */
    const medioOk  = medio.value !== "";
    const canalOk  = canal.value !== "";
    const cuentaOk = cuenta.value !== "";
    const fechaOk  = fecha.value !== "";

    /* ===============================
      4Ô∏è‚É£ Referencia v√°lida (si aplica)
    ================================ */
    const referenciaOk =
      !exigeReferencia || referencia.value.trim() !== "";

    /* ===============================
      5Ô∏è‚É£ Mostrar / ocultar VALOR
    ================================ */
    const mostrarValor =
      medioOk &&
      canalOk &&
      cuentaOk &&
      fechaOk &&
      referenciaOk;

    valor.classList.toggle("d-none", !mostrarValor);

    if (!mostrarValor) {
      valor.value = "";
    }
  });
</script>



{% endblock %}
