{% extends "accounts/home.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
  .item-row {
    animation: fadeInUp 0.25s ease-out;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Nueva Transacción</h3>

  <form method="post" class="row g-3">
    {% csrf_token %}

    <!-- CONTRATO -->
    <div class="col-md-8">
      <label class="form-label">Contrato (Placa - Cliente)</label>
      {{ factura_form.contrato|add_class:"form-select select-buscable" }}
    </div>

    <div class="col-md-4 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        Guardar Factura
      </button>
    </div>

    <!-- ÍTEMS -->
    <div class="col-12 mt-4">
      <h6 class="fw-bold mb-2">Ítems</h6>
    </div>

    <div class="col-12">
      <div class="row text-muted fw-semibold small border-bottom pb-2 mb-2">
        <div class="col-md-2">Tipo</div>
        <div class="col-md-4">Descripción</div>
        <div class="col-md-2 text-center">Cantidad</div>
        <div class="col-md-2 text-end">Valor</div>
        <div class="col-md-2 text-center">Acción</div>
      </div>
    </div>

    <div class="col-12 d-flex justify-content-between align-items-center mb-2">
      <span class="text-muted small">Agrega productos, servicios o tarifas</span>
      <button type="button" class="btn btn-outline-primary btn-sm" id="add-item">
        + Agregar ítem
      </button>
    </div>

    {{ item_formset.management_form }}

    <!-- TEMPLATE ITEM -->
    <div id="empty-form" class="d-none">
      <div class="row align-items-center border rounded-3 px-3 py-2 mb-2 item-row bg-light"
           data-subtotal="0">

        <div class="col-md-2">
          {{ item_formset.empty_form.tipo_item|add_class:"form-select form-select-sm tipo-item" }}
        </div>

        <div class="col-md-4">
          {{ item_formset.empty_form.descripcion|add_class:"form-select form-select-sm descripcion-item" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.cantidad|add_class:"form-control form-control-sm cantidad-item text-center" }}
        </div>

        <div class="col-md-2">
          {{ item_formset.empty_form.valor_unitario|add_class:"form-control form-control-sm valor-unitario-item text-end" }}
        </div>

        <div class="col-md-2 text-center">
          <button type="button" class="btn btn-outline-danger btn-sm remove-item">✖</button>
        </div>

      </div>
    </div>

    <div id="items-container" class="col-12"></div>

    <!-- TOTALES -->
    <div class="col-12 mt-4">
      <div class="border-top pt-3 d-flex justify-content-end">
        <div class="text-end">

          <div class="d-flex justify-content-between gap-4 fs-5">
            <span>Total:</span>
            <strong id="total">$0</strong>
          </div>

        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- PAGOS -->
    <!-- ========================= -->
    <div class="col-12 mt-5">
      <h6 class="fw-bold mb-2">Pagos</h6>
    </div>

    <div class="col-12">
      <div class="row text-muted fw-semibold small border-bottom pb-2 mb-2">
        <div class="col-md-2">Medio</div>
        <div class="col-md-2">Cuenta</div>
        <div class="col-md-2">Fecha</div>
        <div class="col-md-2">Origen</div>
        <div class="col-md-2">Referencia</div>
        <div class="col-md-1 text-end">Valor</div>
        <div class="col-md-1 text-center">Acción</div>
      </div>
    </div>

    <div class="col-12 d-flex justify-content-between align-items-center mb-2">
      <span class="text-muted small">
        Registra los pagos realizados
      </span>
      <button type="button" class="btn btn-outline-success btn-sm" id="add-pago">
        + Agregar pago
      </button>
    </div>

    <!-- ================= TEMPLATE PAGO ================= -->
    <div id="empty-pago" class="d-none">
      <div class="row align-items-center border rounded-3 px-2 py-2 mb-2 pago-row bg-light">

        <!-- TIPO DE PAGO -->
        <div class="col-md-2">
          <select class="form-select form-select-sm pago-tipo" name="tipo_pago[]">
            <option value="">—</option>
            {% for tipo in tipos_pago %}
              <option value="{{ tipo.id }}"
                      data-referencia="{{ tipo.requiere_referencia|yesno:'1,0' }}"
                      data-origen="{{ tipo.requiere_origen|yesno:'1,0' }}">
                {{ tipo.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- CUENTA -->
        <div class="col-md-2">
          <select class="form-select form-select-sm pago-cuenta" name="cuenta_pago[]">
            <option value="">—</option>
            {% for cuenta in cuentas %}
              <option value="{{ cuenta.id }}">{{ cuenta.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- FECHA -->
        <div class="col-md-2">
          <input type="date"
                class="form-control form-control-sm pago-fecha"
                name="fecha_pago[]"
                value="{{ today|date:'Y-m-d' }}">
        </div>

        <!-- ORIGEN -->
        <div class="col-md-2">
          <input type="text"
                class="form-control form-control-sm pago-origen"
                name="origen_pago[]"
                placeholder="Origen"
                readonly>
        </div>

        <!-- REFERENCIA -->
        <div class="col-md-2">
          <input type="text"
                class="form-control form-control-sm pago-referencia"
                name="referencia_pago[]"
                placeholder="Referencia"
                readonly>
        </div>

        <!-- VALOR -->
        <div class="col-md-1">
          <input type="number"
                step="0.01"
                min="0"
                class="form-control form-control-sm pago-valor text-end"
                name="valor_pago[]"
                placeholder="0.00">
        </div>

        <!-- ACCIÓN -->
        <div class="col-md-1 text-center">
          <button type="button" class="btn btn-outline-danger btn-sm remove-pago">
            ✖
          </button>
        </div>

      </div>
    </div>

    <div id="pagos-container" class="col-12"></div>

    <!-- ================= RESUMEN PAGOS ================= -->
    <div class="col-12 mt-3">
      <div class="d-flex justify-content-end">
        <div class="text-end">
          <div class="d-flex justify-content-between gap-4">
            <span class="text-muted">Total pagado:</span>
            <strong id="total-pagado">$0</strong>
          </div>
          <div class="d-flex justify-content-between gap-4">
            <span class="text-muted">Saldo pendiente:</span>
            <strong id="saldo-pendiente">$0</strong>
          </div>
        </div>
      </div>
    </div>



  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{{ productos_json|json_script:"productos-almacen" }}
{{ servicios_json|json_script:"servicios-taller" }}

<script>
const productosAlmacen = JSON.parse(document.getElementById('productos-almacen').textContent);
const serviciosTaller = JSON.parse(document.getElementById('servicios-taller').textContent);

$(document).ready(() => {
  $('.select-buscable').select2({ width:'100%', placeholder:'Buscar…', allowClear:true });
  $('select[name="contrato"]').on('change', recalcularTodos);
});

document.getElementById('add-item').addEventListener('click', () => {
  const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
  const index = parseInt(totalForms.value);

  const html = document.getElementById('empty-form').innerHTML
    .replace(/__prefix__/g, index);

  const container = document.getElementById('items-container');
  container.insertAdjacentHTML('beforeend', html);
  totalForms.value = index + 1;

  inicializarItem(container.lastElementChild);
});

const datosDescripcion = {
  tarifa: [{id:'tarifa', text:'Pago de tarifa', valor:0}],
  almacen: productosAlmacen.map(p => ({id:p.id, text:p.nombre, valor:p.precio_venta})),
  taller: serviciosTaller.map(s => ({id:s.id, text:s.nombre_servicio, valor:s.valor}))
};

function getTarifaContrato() {
  const sel = document.querySelector('select[name="contrato"]');
  return sel?.selectedOptions[0]?.dataset.tarifa || 0;
}

function cargarDescripcion(row) {
  const tipo = row.querySelector('.tipo-item');
  const desc = row.querySelector('.descripcion-item');
  const opciones = datosDescripcion[tipo.value] || [];

  desc.innerHTML = '';
  opciones.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.id;
    opt.textContent = o.text;
    opt.dataset.valor = o.valor;
    desc.appendChild(opt);
  });

  $(desc).select2({ width:'100%', placeholder:'Buscar…', allowClear:true });
}

function recalcularFila(row) {
  const tipo = row.querySelector('.tipo-item').value;
  const cant = parseFloat(row.querySelector('.cantidad-item').value || 0);
  let subtotal = 0;

  if (tipo === 'tarifa') {
    subtotal = getTarifaContrato() * cant;
  } else {
    const opt = row.querySelector('.descripcion-item').selectedOptions[0];
    subtotal = (opt?.dataset.valor || 0) * cant;
  }

  row.dataset.subtotal = subtotal;
  row.querySelector('.valor-unitario-item').value = subtotal ? subtotal.toFixed(2) : '';
  recalcularTotales();
}

function recalcularTotales() {
  let total = 0;
  document.querySelectorAll('.item-row').forEach(r => {
    total += parseFloat(r.dataset.subtotal || 0);
  });
  document.getElementById('total').innerText = total.toLocaleString('es-CO');
}

$('#items-container')
  .on('change', '.tipo-item', function () {
    const row = this.closest('.item-row');
    cargarDescripcion(row);
    recalcularFila(row);
  })
  .on('input', '.cantidad-item', function () {
    recalcularFila(this.closest('.item-row'));
  })
  .on('select2:select select2:clear', '.descripcion-item', function () {
    recalcularFila(this.closest('.item-row'));
  })
  .on('click', '.remove-item', function () {
    this.closest('.item-row').remove();
    recalcularTotales();
  });

function inicializarItem(row) {
  cargarDescripcion(row);
}

function recalcularTodos() {
  document.querySelectorAll('.item-row').forEach(recalcularFila);
}
</script>

<script>
/* =========================
   AGREGAR PAGO
========================= */
document.getElementById('add-pago').addEventListener('click', () => {
  const totalForms = document.getElementById('pagos-total-forms');
  const index = parseInt(totalForms.value);

  const html = document.getElementById('empty-pago').innerHTML;
  document.getElementById('pagos-container')
    .insertAdjacentHTML('beforeend', html);

  totalForms.value = index + 1;
});

/* =========================
   TIPO DE PAGO → REFERENCIA
========================= */
document.getElementById('pagos-container')
  .addEventListener('change', e => {

    if (e.target.classList.contains('pago-tipo')) {
      const row = e.target.closest('.pago-row');
      const refInput = row.querySelector('.pago-referencia');

      const requiere = e.target.selectedOptions[0]
        ?.dataset.referencia === '1';

      refInput.disabled = !requiere;
      refInput.required = requiere;

      if (!requiere) refInput.value = '';
    }
});

/* =========================
   RECÁLCULOS
========================= */
function obtenerTotalFactura() {
  const totalText = document.getElementById('total')
    ?.innerText
    ?.replace(/\./g, '')
    ?.replace(',', '.');

  return parseFloat(totalText) || 0;
}

function recalcularPagos() {
  let pagado = 0;

  document.querySelectorAll('.pago-valor').forEach(input => {
    pagado += parseFloat(input.value || 0);
  });

  const totalFactura = obtenerTotalFactura();
  const saldo = Math.max(totalFactura - pagado, 0);

  document.getElementById('total-pagado')
    .innerText = pagado.toLocaleString('es-CO');

  document.getElementById('saldo-pendiente')
    .innerText = saldo.toLocaleString('es-CO');

  document.querySelectorAll('.pago-valor').forEach(input => {
    const max = totalFactura - (pagado - parseFloat(input.value || 0));
    input.max = max >= 0 ? max.toFixed(2) : 0;
  });
}

/* =========================
   EVENTOS
========================= */
document.getElementById('pagos-container')
  .addEventListener('input', e => {
    if (e.target.classList.contains('pago-valor')) {
      recalcularPagos();
    }
  });

document.getElementById('pagos-container')
  .addEventListener('click', e => {
    if (e.target.classList.contains('remove-pago')) {
      e.target.closest('.pago-row').remove();
      recalcularPagos();
    }
  });
</script>




{% endblock %}
