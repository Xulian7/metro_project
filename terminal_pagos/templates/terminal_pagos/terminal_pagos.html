{% extends "accounts/home.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<!-- ========================= -->
<!-- Select2 CSS -->
<!-- ========================= -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold fs-5 mb-4">Nueva Transacción</h3>

  <form method="post" class="row g-3">
    {% csrf_token %}

    <!-- ========================= -->
    <!-- Contrato -->
    <!-- ========================= -->
    <div class="col-md-8">
      <label class="form-label">Contrato (Placa - Cliente)</label>
      {{ factura_form.contrato|add_class:"form-select select-buscable" }}
    </div>

    <div class="col-md-4 d-flex align-items-end justify-content-end">
      <button type="submit" class="btn btn-primary btn-app-action w-100">
        Guardar Factura
      </button>
    </div>

    <!-- ========================= -->
    <!-- Ítems -->
    <!-- ========================= -->
    <div class="col-12 mt-4">
      <h6 class="fw-bold mb-3">Ítems</h6>
    </div>

    {{ item_formset.management_form }}

    {% for form in item_formset %}
      <div class="row g-3 align-items-end border rounded p-3 mb-2 item-row">

        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          {{ form.tipo_item|add_class:"form-select tipo-item" }}
        </div>

        <div class="col-md-4">
          <label class="form-label">Descripción</label>
          {{ form.descripcion|add_class:"form-select descripcion-item" }}
        </div>

        <div class="col-md-2">
          <label class="form-label">Cantidad</label>
          {{ form.cantidad|add_class:"form-control cantidad-item" }}
        </div>

        <div class="col-md-2">
          <label class="form-label">Valor</label>
          {{ form.valor_unitario|add_class:"form-control valor-unitario-item" }}
        </div>

        <div class="col-md-2 text-end">
          {{ form.DELETE }}
        </div>

      </div>
    {% endfor %}

  </form>

</div>

<!-- ========================= -->
<!-- JS -->
<!-- ========================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<!-- ========================= -->
<!-- JSON seguro para JS -->
<!-- ========================= -->
{{ productos_json|json_script:"productos-almacen" }}
{{ servicios_json|json_script:"servicios-taller" }}

<script>

  const productosAlmacen = JSON.parse(
    document.getElementById('productos-almacen').textContent
  );

  const serviciosTaller = JSON.parse(
    document.getElementById('servicios-taller').textContent
  );

  $(document).ready(function () {
    // Contrato con buscador
    $('.select-buscable').select2({
      placeholder: 'Buscar por placa o cliente...',
      allowClear: true,
      width: '100%'
    });

    // Inicializar ítems
    inicializarItems();

    // Recalcular tarifas al cambiar contrato
    $('select[name="contrato"]').on('change', function () {
      recalcularTodos();
    });
  });

  // =========================
  // Utilidades
  // =========================
  function getTarifaContrato() {
    const contrato = document.querySelector('select[name="contrato"]');
    if (!contrato || contrato.selectedIndex === -1) return 0;

    const option = contrato.options[contrato.selectedIndex];
    return parseFloat(option.dataset.tarifa || 0);
  }

  function getPrecioProducto(descripcionSelect) {
  if (!descripcionSelect || descripcionSelect.selectedIndex === -1) return 0;

  const option = descripcionSelect.options[descripcionSelect.selectedIndex];
  return parseFloat(option.dataset.precio || 0);
}

  // =========================
  // Descripción (select dinámico)
  // =========================
  function cargarDescripcion(row) {
    const tipo = row.querySelector('.tipo-item');
    const descripcion = row.querySelector('.descripcion-item');

    if (!tipo || !descripcion) return;

    // destruir select2 si existe
    if ($(descripcion).hasClass('select2-hidden-accessible')) {
      $(descripcion).select2('destroy');
    }

    descripcion.innerHTML = '';
    descripcion.disabled = false;

    if (tipo.value === 'tarifa') {
      descripcion.innerHTML = `<option value="tarifa">Pago de tarifa</option>`;
      descripcion.disabled = true;
    }

    else if (tipo.value === 'almacen') {
      descripcion.innerHTML = `<option value="">Seleccione producto</option>`;

      productosAlmacen.forEach(p => {
        descripcion.innerHTML += `
          <option value="${p.id}" data-precio="${p.precio_venta}">
            ${p.nombre}
          </option>`;
      });
    }

    else if (tipo.value === 'servicio_taller') {
      descripcion.innerHTML = `<option value="">Seleccione servicio</option>`;

      serviciosTaller.forEach(s => {
        descripcion.innerHTML += `
          <option value="${s.id}" data-precio="${s.precio}">
            ${s.nombre}
          </option>`;
      });
    }

    else {
      descripcion.innerHTML = `<option value="">—</option>`;
    }

    if (!descripcion.disabled) {
      $(descripcion).select2({
        placeholder: 'Buscar…',
        allowClear: true,
        width: '100%'
      });
    }
  }


  // =========================
  // Recalcular valores
  // =========================
  function recalcularFila(row) {
    const tipo = row.querySelector('.tipo-item');
    const descripcion = row.querySelector('.descripcion-item');
    const cantidad = row.querySelector('.cantidad-item');
    const valor = row.querySelector('.valor-unitario-item');

    if (!tipo || !descripcion || !cantidad || !valor) return;

    const cant = parseFloat(cantidad.value || 0);
    let total = 0;

    if (tipo.value === 'tarifa') {
      const tarifa = getTarifaContrato();
      total = tarifa * cant;
    }

    else if (tipo.value === 'almacen' || tipo.value === 'servicio_taller') {
      const selected = descripcion.options[descripcion.selectedIndex];

      if (selected) {
        const precio = parseFloat(selected.dataset.precio || 0);
        total = precio * cant;
      }
    }

    valor.value = total ? total.toFixed(2) : '';
  }


  // =========================
  // Inicialización general
  // =========================
  function inicializarItems() {
    document.querySelectorAll('.item-row').forEach(row => {
      const tipo = row.querySelector('.tipo-item');
      const cantidad = row.querySelector('.cantidad-item');
      const descripcion = row.querySelector('.descripcion-item');

      if (!tipo || !cantidad) return;

      // Cambio de tipo → reconstruir descripción
      tipo.addEventListener('change', () => {
        cargarDescripcion(row);
        recalcularFila(row);
      });

      // Cambio de descripción (producto / servicio)
      descripcion.addEventListener('change', () => {
        recalcularFila(row);
      });

      // Cambio de cantidad → solo recalcular
      cantidad.addEventListener('input', () => {
        recalcularFila(row);
      });

      // Estado inicial
      cargarDescripcion(row);
      recalcularFila(row);
    });
  }

  // =========================
  // Recalcular todo
  // =========================
  function recalcularTodos() {
    document.querySelectorAll('.item-row').forEach(row => {
      recalcularFila(row);
    });
  }
</script>


{% endblock %}
