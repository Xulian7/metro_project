{% extends "accounts/home.html" %}
{% load static %}

{% block content %}

<div class="container-fluid py-4">

  <!-- ================= CONTRATO / CONTEXTO ================= -->
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          Terminal de Pagos ¬∑ Contrato / Veh√≠culo
        </div>
        <div class="card-body row g-3">
          <div class="col-md-3">
            <label class="form-label">Contrato</label>
            <input type="text" class="form-control" value="{{ contrato.id }} - {{ contrato.cliente }}" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Placa</label>
            <input type="text" class="form-control" value="{{ contrato.vehiculo.placa }}" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Cliente</label>
            <input type="text" class="form-control" value="{{ contrato.cliente }}" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Fecha</label>
            <input type="text" class="form-control" value="{{ now|date:'Y-m-d H:i' }}" disabled>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= CUERPO PRINCIPAL ================= -->
  <div class="row">

    <!-- ================= ITEMS ================= -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
          √çtems de la factura
        </div>

        <div class="card-body">

          <!-- Alta de √≠tems -->
          <div class="row g-2 mb-3">
            <div class="col-md-3">
              <label class="form-label">Tipo</label>
              <select id="tipoItem" class="form-select">
                <option value="">Seleccione‚Ä¶</option>
                <option value="TARIFA">Tarifa</option>
                <option value="PRODUCTO">Producto</option>
                <option value="TALLER">Servicio Taller</option>
                <option value="ESPECIAL">Pago Especial</option>
              </select>
            </div>

            <div class="col-md-5">
              <label class="form-label">Descripci√≥n</label>
              <input type="text" id="descripcionItem" class="form-control">
            </div>

            <div class="col-md-2">
              <label class="form-label">Cantidad</label>
              <input type="number" id="cantidadItem" class="form-control" value="1" step="0.01">
            </div>

            <div class="col-md-2">
              <label class="form-label">Valor Unit.</label>
              <input type="number" id="valorItem" class="form-control" step="0.01">
            </div>

            <!-- Campos din√°micos -->
            <div class="col-md-6 d-none" id="campoProducto">
              <label class="form-label">Producto (almac√©n)</label>
              <select class="form-select">
                <option value="">Seleccione producto</option>
                {% for p in productos %}
                  <option value="{{ p.id }}">{{ p.nombre }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 d-none" id="campoServicio">
              <label class="form-label">Servicio taller</label>
              <select class="form-select">
                <option value="">Seleccione servicio</option>
                {% for s in servicios %}
                  <option value="{{ s.id }}">{{ s.nombre }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-12 text-end mt-2">
              <button class="btn btn-success" type="button" onclick="agregarItem()">
                ‚ûï Agregar √≠tem
              </button>
            </div>
          </div>

          <hr>

          <!-- Lista de √≠tems -->
          <div id="listaItems"></div>

        </div>
      </div>
    </div>

    <!-- ================= RESUMEN + PAGOS ================= -->
    <div class="col-md-4">

      <div class="card shadow-sm mb-3">
        <div class="card-header bg-secondary text-white">
          Resumen
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold">Total</span>
            <span class="fs-4">$ <span id="totalFactura">0.00</span></span>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          Pagos
        </div>
        <div class="card-body">

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Medio</label>
              <select class="form-select">
                {% for m in medios_pago %}
                  <option value="{{ m.id }}">{{ m.nombre }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Valor</label>
              <input type="number" class="form-control" step="0.01">
            </div>

            <div class="col-md-12">
              <label class="form-label">Referencia</label>
              <input type="text" class="form-control">
            </div>

            <div class="col-md-12 text-end mt-2">
              <button class="btn btn-outline-primary" type="button">
                ‚ûï Agregar pago
              </button>
            </div>
          </div>

        </div>
      </div>

      <div class="d-grid mt-3">
        <button class="btn btn-lg btn-dark">
          üíæ Cerrar factura
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    const itemsContainer = document.getElementById("items-container");
    const pagosContainer = document.getElementById("pagos-container");

    const btnAddItem = document.getElementById("add-item");
    const btnAddPago = document.getElementById("add-pago");

    const totalFacturaEl = document.getElementById("total-factura");
    const totalPagosEl = document.getElementById("total-pagos");
    const btnGuardar = document.getElementById("btn-guardar");

    /* =============================
       UTILIDADES
    ============================= */

    const parseNumber = (v) => parseFloat(v) || 0;

    const updateBtnEstado = () => {
        const totalFactura = parseNumber(totalFacturaEl.textContent);
        const totalPagos = parseNumber(totalPagosEl.textContent);

        if (totalPagos === totalFactura && totalFactura > 0) {
            btnGuardar.disabled = false;
            btnGuardar.classList.remove("btn-danger");
            btnGuardar.classList.add("btn-success");
        } else {
            btnGuardar.disabled = true;
            btnGuardar.classList.remove("btn-success");
            btnGuardar.classList.add("btn-danger");
        }
    };

    /* =============================
       ITEMS
    ============================= */

    const recalcularItems = () => {
        let total = 0;

        document.querySelectorAll(".item-row").forEach(row => {
            const cantidad = parseNumber(row.querySelector(".item-cantidad")?.value);
            const valor = parseNumber(row.querySelector(".item-valor")?.value);
            const subtotal = cantidad * valor;

            const totalInput = row.querySelector(".item-total");
            if (totalInput) {
                totalInput.value = subtotal.toFixed(2);
            }

            total += subtotal;
        });

        totalFacturaEl.textContent = total.toFixed(2);
        recalcularPagos();
    };

    const manejarTipoItem = (row) => {
        const tipo = row.querySelector(".item-tipo")?.value;

        const camposOpcionales = row.querySelectorAll("[data-only]");

        camposOpcionales.forEach(campo => {
            const only = campo.dataset.only;
            campo.disabled = only !== tipo;
        });
    };

    itemsContainer.addEventListener("input", (e) => {
        if (
            e.target.classList.contains("item-cantidad") ||
            e.target.classList.contains("item-valor")
        ) {
            recalcularItems();
        }
    });

    itemsContainer.addEventListener("change", (e) => {
        if (e.target.classList.contains("item-tipo")) {
            manejarTipoItem(e.target.closest(".item-row"));
        }
    });

    btnAddItem.addEventListener("click", () => {
        const rows = itemsContainer.querySelectorAll(".item-row");
        const newRow = rows[0].cloneNode(true);

        newRow.querySelectorAll("input, select").forEach(input => {
            input.value = "";
        });

        itemsContainer.appendChild(newRow);
    });

    /* =============================
       PAGOS
    ============================= */

    const recalcularPagos = () => {
        let totalPagos = 0;

        document.querySelectorAll(".pago-row").forEach(row => {
            const valor = parseNumber(row.querySelector(".pago-valor")?.value);
            totalPagos += valor;
        });

        totalPagosEl.textContent = totalPagos.toFixed(2);

        const totalFactura = parseNumber(totalFacturaEl.textContent);

        if (totalPagos > totalFactura) {
            totalPagosEl.classList.add("text-danger");
        } else {
            totalPagosEl.classList.remove("text-danger");
        }

        updateBtnEstado();
    };

    pagosContainer.addEventListener("input", (e) => {
        if (e.target.classList.contains("pago-valor")) {
            recalcularPagos();
        }
    });

    btnAddPago.addEventListener("click", () => {
        const rows = pagosContainer.querySelectorAll(".pago-row");
        const newRow = rows[0].cloneNode(true);

        newRow.querySelectorAll("input, select").forEach(input => {
            input.value = "";
        });

        pagosContainer.appendChild(newRow);
    });

    /* =============================
       INIT
    ============================= */

    recalcularItems();
    recalcularPagos();

});
</script>


{% endblock %}
