{% extends 'accounts/home.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">Terminal de Pagos</h2>

    <!-- FORMULARIO DE FACTURA -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="post" id="facturaForm">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-3">
                        {{ form.cedula.label_tag }}
                        {{ form.cedula }}
                    </div>
                    <div class="col-md-3">
                        {{ form.placa.label_tag }}
                        {{ form.placa|add_class:"select2" }}
                    </div>
                    <div class="col-md-6">
                        {{ form.cliente.label_tag }}
                        {{ form.cliente }}
                    </div>
                </div>

                <script>
                document.addEventListener("DOMContentLoaded", function() {
                    $(".select2").select2();

                    $("#id_placa").on("change", function () {
                        let vehiculo_id = $(this).val();

                        if (!vehiculo_id) return;

                        fetch(`/terminal_pagos/api/get_info_por_placa/${vehiculo_id}/`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.ok) {
                                    $("#id_cedula").val(data.cedula);
                                    $("#id_cliente").val(data.cliente_nombre);
                                } else {
                                    console.warn("No se encontrÃ³ contrato.");
                                }
                            });
                    });
                });
                </script>

                <hr>
                <!-- DETALLES DE FACTURA -->
                <h5 class="mt-3">Detalles de Factura</h5>
                <table class="table table-sm align-middle text-center" id="tablaDetalles">
                    <thead class="table-light">
                        <tr>
                            <th>Concepto</th>
                            <th>DescripciÃ³n</th>
                            <th>Cant.</th>
                            <th>Valor Unit.</th>
                            <th>Total</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="detalleBody"></tbody>
                </table>
                <button type="button" class="btn btn-outline-primary btn-sm" id="agregarDetalle">
                    âž• Agregar Detalle
                </button>

                <hr>

                <!-- PAGOS -->
                <h5 class="mt-3">Pagos</h5>
                <table class="table table-sm align-middle text-center" id="tablaPagos">
                    <thead class="table-light">
                        <tr>
                            <th>Medio de Pago</th>
                            <th>Origen (Nequi)</th>
                            <th>Valor</th>
                            <th>Referencia</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="pagoBody"></tbody>
                </table>
                <button type="button" class="btn btn-outline-success btn-sm" id="agregarPago">
                    âž• Agregar Pago
                </button>

                <hr>

                <!-- BOTÃ“N FINAL -->
                <div class="text-end">
                    <button type="submit" class="btn btn-app-action px-4">
                        ðŸ’¾ Guardar Factura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- LISTADO DE FACTURAS RECIENTES -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5>ðŸ•“ Ãšltimas facturas registradas</h5>
            <table class="table table-sm table-bordered text-center mt-2">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>CÃ©dula</th>
                        <th>Placa</th>
                        <th>Fecha</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for factura in facturas %}
                        <tr>
                            <td>{{ factura.id }}</td>
                            <td>{{ factura.cliente }}</td>
                            <td>{{ factura.cedula }}</td>
                            <td>{{ factura.placa }}</td>
                            <td>{{ factura.fecha_creacion|date:"d/m/Y H:i" }}</td>
                            <td>${{ factura.total|default:"0" }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="6">Sin facturas registradas aÃºn.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- JS: DinÃ¡mica de agregar filas -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const detalleBody = document.getElementById("detalleBody");
    const pagoBody = document.getElementById("pagoBody");

    // Agregar fila de detalle
    document.getElementById("agregarDetalle").addEventListener("click", () => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <select name="detalle_concepto[]" class="form-select form-select-sm">
                    <option value="producto">Producto</option>
                    <option value="servicio">Servicio Taller</option>
                    <option value="deuda">Deuda Adicional</option>
                    <option value="arrendamiento">Tarifa Arrendamiento</option>
                    <option value="empeno">EmpeÃ±o</option>
                    <option value="abono_inicial">Abono a Inicial</option>
                </select>
            </td>
            <td><input type="text" name="detalle_descripcion[]" class="form-control form-control-sm" placeholder="DescripciÃ³n"></td>
            <td><input type="number" name="detalle_cantidad[]" class="form-control form-control-sm" value="1" min="1"></td>
            <td><input type="number" name="detalle_valor[]" class="form-control form-control-sm" value="0" step="0.01"></td>
            <td><input type="text" name="detalle_total[]" class="form-control form-control-sm" readonly></td>
            <td><button type="button" class="btn btn-outline-danger btn-sm eliminarFila">âœ–</button></td>
        `;
        detalleBody.appendChild(row);
    });

    // Agregar fila de pago
    document.getElementById("agregarPago").addEventListener("click", () => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                <select name="pago_medio[]" class="form-select form-select-sm">
                    <option value="efectivo">Efectivo</option>
                    <option value="nequi">Nequi</option>
                    <option value="ajuste">Ajuste Pico y Placa</option>
                    <option value="comision">ComisiÃ³n</option>
                </select>
            </td>
            <td>
                <select name="pago_origen[]" class="form-select form-select-sm">
                    <option value="">--</option>
                    <option value="transf_nequi">Transf Nequi</option>
                    <option value="bancolombia">Bancolombia</option>
                    <option value="consignacion">ConsignaciÃ³n</option>
                    <option value="ptm">PTM</option>
                    <option value="transfiya">TransfiYa</option>
                </select>
            </td>
            <td><input type="number" name="pago_valor[]" class="form-control form-control-sm" value="0" step="0.01"></td>
            <td><input type="text" name="pago_ref[]" class="form-control form-control-sm" placeholder="Referencia"></td>
            <td><button type="button" class="btn btn-outline-danger btn-sm eliminarFila">âœ–</button></td>
        `;
        pagoBody.appendChild(row);
    });

    // Eliminar fila genÃ©rica
    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("eliminarFila")) {
            e.target.closest("tr").remove();
        }
    });
});


</script>
{% endblock %}
