{% extends "accounts/home.html" %}
{% load humanize %}
{% block content %}

<div class="card p-4 shadow-sm">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0">
      Resumen financiero de contratos
      <small class="text-muted">(al {{ hoy }})</small>
    </h5>
  </div>

  <!-- ðŸ” BUSCADOR &  EXPORTAR -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input
        type="text"
        id="buscador-contratos"
        class="form-control"
        placeholder="Buscar por contrato, cliente o placa">
    </div>

    <div class="col-md-8 text-end">
      <button id="export-excel"
              class="btn btn-outline-success btn-sm">
        ðŸ“Š Exportar a Excel
      </button>
  </div>

  <!-- FILTRO SALDO -->
  <div class="row mb-3 align-items-end">
    <div class="col-md-4">
      <input
        type="text"
        id="buscador-contratos"
        class="form-control"
        placeholder="Buscar por contrato, cliente o placa">
    </div>

    <div class="col-md-3">
      <label class="form-label small mb-1">Saldo mÃ­nimo ($)</label>
      <input type="number"
            id="saldo-min"
            class="form-control form-control-sm"
            placeholder="Desde">
    </div>

    <div class="col-md-3">
      <label class="form-label small mb-1">Saldo mÃ¡ximo ($)</label>
      <input type="number"
            id="saldo-max"
            class="form-control form-control-sm"
            placeholder="Hasta">
    </div>

    <div class="col-md-2 text-end">
      <button class="btn btn-sm btn-outline-secondary"
              id="reset-saldo">
        Limpiar
      </button>
    </div>
  </div>


  <!-- ðŸ“‹ TABLA -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Contrato</th>
          <th>Cliente</th>
          <th>VehÃ­culo</th>
          <th data-sort="date" class="sortable">Inicio</th>
          <th class="text-end">Tarifa</th>
          <th class="text-center">Frecuencia</th>
          <th data-sort="number" class="sortable text-center">Cuotas vencidas</th>
          <th class="text-center">Pagos tarifa</th>
          <th class="text-center">Saldo</th>
          <th class="text-end">Acciones</th>

        </tr>
      </thead>

      <tbody id="tabla-contratos">
        {% for row in filas %}
        <tr>
          <td>#{{ row.contrato.id }}</td>
          
          <td>
            {{ row.contrato.cliente.nombre }}

            {% if row.contrato.cliente.status == "Lista Negra" %}
              <span class="badge bg-dark ms-1"
                    title="Cliente en lista negra">
                âš‘
              </span>
            {% endif %}
          </td>

          <td>{{ row.contrato.vehiculo.placa }}</td>

          
          <td data-fecha="{{ row.fecha_inicio|date:'Y-m-d' }}">
            {{ row.fecha_inicio|date:"d/m/Y" }}
            <br>
            <small class="text-muted">
              {{ row.dias_transcurridos }} dÃ­as
            </small>
          </td>

          <!-- Tarifa -->
          <td class="text-end">
            ${{ row.tarifa|intcomma }}
          </td>

          <!-- Frecuencia de pago -->
          <td class="text-center">
            {% if row.contrato.frecuencia_pago == "Diario" %}
              <span class="badge bg-danger">Diario</span>

            {% elif row.contrato.frecuencia_pago == "Semanal" %}
              <span class="badge bg-primary">Semanal</span>

            {% elif row.contrato.frecuencia_pago == "Quincenal" %}
              <span class="badge bg-warning text-dark">Quincenal</span>

            {% elif row.contrato.frecuencia_pago == "Mensual" %}
              <span class="badge bg-success">Mensual</span>

            {% else %}
              <span class="badge bg-secondary">
                {{ row.contrato.get_frecuencia_pago_display }}
              </span>
            {% endif %}
          </td>


          <!-- Cuotas vencidas -->
          <td class="text-center fw-semibold"
              data-cuotas="{{ row.cuotas_vencidas }}">
            {{ row.cuotas_vencidas|floatformat:1 }}
          </td>

          <!-- Pagos -->
          <td class="text-center">
            <div class="fw-semibold">
              {{ row.cuotas_pagadas|floatformat:1 }} cuotas
            </div>
            <small class="text-muted">
              ${{ row.total_pagado|intcomma }}
            </small>
          </td>

          <!-- Saldo -->
          <td class="text-center fw-semibold
              {% if row.saldo_cuotas > 0 %}
                text-danger
              {% elif row.saldo_cuotas < 0 %}
                text-primary
              {% else %}
                text-success
              {% endif %}
          "
          data-saldo="{{ row.saldo_dinero }}">
            {{ row.saldo_cuotas|floatformat:1 }}
            <br>
            <small>
              ${{ row.saldo_dinero|intcomma }}
            </small>
          </td>


          <!--  ACCIONES -->
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <button
                class="btn btn-outline-success"
                title="Cobrar">
                ðŸ’µ
              </button>

              <button
                class="btn btn-outline-primary btn-extracto"
                data-contrato-id="{{ row.contrato.id }}"
                title="Ver extracto de pagos">
                ðŸ“„
              </button>
            </div>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted">
            No hay contratos para mostrar
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>


{% include "terminal_pagos/partials/extracto_modal.html" %}


<!-- EXTRACTO DE PAGOS JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  document.querySelectorAll(".btn-extracto").forEach(btn => {
    btn.addEventListener("click", () => {
      const contratoId = btn.dataset.contratoId;

      fetch(`/terminal_pagos/extracto/contrato/${contratoId}/`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("extracto-body");
          tbody.innerHTML = "";

          data.filas.forEach(f => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${f.fecha_pactada}</td>

              <td class="text-end">
                $${Number(f.valor_pactado).toLocaleString("es-CO")}
              </td>

              <td class="text-end">
                $${Number(f.valor_aplicado).toLocaleString("es-CO")}
              </td>

              <td>
                ${f.fecha_pago ?? "â€”"}
              </td>

              <td>
                ${
                  f.factura_id
                    ? `<span class="badge bg-primary factura-tag"
                            data-factura-id="${f.factura_id}"
                            role="button">
                        #${f.factura_id}
                      </span>`
                    : "â€”"
                }
              </td>
            `;

            tbody.appendChild(tr);
          });

          const modal = new bootstrap.Modal(
            document.getElementById("extractoModal")
          );
          modal.show();
        });
    });
  });

});
</script>

<!-- BUSCADOR JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const buscador = document.getElementById("buscador-contratos");
  const filas = document.querySelectorAll("#tabla-contratos tr");

  buscador?.addEventListener("input", () => {
    const texto = buscador.value.toLowerCase();

    filas.forEach(fila => {
      const contrato = fila.children[0].innerText.toLowerCase();
      const cliente  = fila.children[1].innerText.toLowerCase();
      const placa    = fila.children[2].innerText.toLowerCase();

      fila.style.display =
        contrato.includes(texto) ||
        cliente.includes(texto) ||
        placa.includes(texto)
          ? ""
          : "none";
    });
  });
});
</script>

<!-- ORDENAMIENTO JS -->
 <script>
  document.addEventListener("DOMContentLoaded", () => {

    const tbody = document.getElementById("tabla-contratos");
    let currentIndex = null;
    let asc = true;

    document.querySelectorAll("th.sortable").forEach(th => {

      th.addEventListener("click", () => {

        const colIndex = th.cellIndex; // ðŸ”¥ ÃNDICE REAL

        // reset visual
        document.querySelectorAll("th.sortable")
          .forEach(h => h.classList.remove("asc", "desc"));

        // alternar / resetear
        if (currentIndex === colIndex) {
          asc = !asc;
        } else {
          asc = true;
          currentIndex = colIndex;
        }

        const rows = Array.from(tbody.querySelectorAll("tr"));
        const type = th.dataset.sort;

        rows.sort((a, b) => {

          // ðŸ—“ï¸ INICIO
          if (type === "date") {
            const A = new Date(a.children[colIndex].dataset.fecha);
            const B = new Date(b.children[colIndex].dataset.fecha);
            return asc ? A - B : B - A;
          }

          // ðŸ”¢ CUOTAS VENCIDAS
          if (type === "number") {
            const A = parseFloat(a.children[colIndex].dataset.cuotas);
            const B = parseFloat(b.children[colIndex].dataset.cuotas);
            return asc ? A - B : B - A;
          }

          return 0;
        });

        th.classList.add(asc ? "asc" : "desc");
        rows.forEach(r => tbody.appendChild(r));
      });

    });

  });
</script>

<!-- EXPORTAR A EXCEL JS -->
<script>
  /* ===============================
    Helpers
  ================================ */
  function cleanNumber(value) {
    if (!value) return "";
    return value
      .replace(/\$/g, "")       // quita $
      .replace(/\./g, "")       // quita miles con punto
      .replace(/,/g, ".")       // coma decimal -> punto
      .replace(/[^\d.-]/g, "") // deja solo nÃºmeros
      .trim();
  }

  /* ===============================
    Exportar a Excel
  ================================ */
  document.getElementById("export-excel").addEventListener("click", () => {

    const table = document.querySelector("table");
    let html = "<table border='1'><tr>";

    /* ---------- HEADERS ---------- */
    table.querySelectorAll("thead th").forEach((th, index) => {

      const title = th.innerText.trim();
      if (title === "Acciones") return;

      // Columnas mixtas â†’ split
      if (index === 3) {               // Inicio
        html += "<th>Inicio</th><th>DÃ­as transcurridos</th>";
      }
      else if (index === 7) {          // Pagos tarifa
        html += "<th>Pagos (cuotas)</th><th>Pagos ($)</th>";
      }
      else if (index === 8) {          // Saldo
        html += "<th>Saldo (cuotas)</th><th>Saldo ($)</th>";
      }
      else {
        html += `<th>${title}</th>`;
      }
    });

    html += "</tr>";

    /* ---------- FILAS ---------- */
    table.querySelectorAll("tbody tr").forEach(tr => {
      if (tr.style.display === "none") return; // respeta buscador

      html += "<tr>";

      tr.querySelectorAll("td").forEach((td, index) => {

        // ignora Acciones (Ãºltima columna)
        if (index === tr.children.length - 1) return;

        let text = td.innerText
          .replace(/\n+/g, "\n")
          .trim();

        /* ---- Inicio (fecha + dÃ­as) ---- */
        if (index === 3) {
          const [fecha, dias] = text.split("\n");
          html += `<td>${fecha ?? ""}</td>`;
          html += `<td>${(dias ?? "").replace("dÃ­as", "").trim()}</td>`;
          return;
        }

        /* ---- Tarifa ($ limpio) ---- */
        if (index === 4) {
          html += `<td>${cleanNumber(text)}</td>`;
          return;
        }

        /* ---- Pagos tarifa (cuotas + $ limpio) ---- */
        if (index === 7) {
          const [cuotas, dinero] = text.split("\n");
          html += `<td>${(cuotas ?? "").replace("cuotas", "").trim()}</td>`;
          html += `<td>${cleanNumber(dinero ?? "")}</td>`;
          return;
        }

        /* ---- Saldo (cuotas + $ limpio) ---- */
        if (index === 8) {
          const [cuotas, dinero] = text.split("\n");
          html += `<td>${cuotas ?? ""}</td>`;
          html += `<td>${cleanNumber(dinero ?? "")}</td>`;
          return;
        }

        /* ---- Normal ---- */
        html += `<td>${text.replace(/\n/g, " ")}</td>`;
      });

      html += "</tr>";
    });

    html += "</table>";

    /* ---------- Descargar ---------- */
    const blob = new Blob(
      ["\ufeff" + html],
      { type: "application/vnd.ms-excel;charset=utf-8;" }
    );

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = "resumen_contratos.xls";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
</script>

<!-- ESTILOS PARA ORDENAMIENTO -->
<style>
  th.sortable {
    cursor: pointer;
    user-select: none;
  }

  th.sortable::after {
    content: " â‡…";
    font-size: 0.75em;
    color: #adb5bd;
  }

  th.sortable.asc::after {
    content: " â–²";
    color: #0d6efd;
  }

  th.sortable.desc::after {
    content: " â–¼";
    color: #0d6efd;
  }
</style>

<!-- FILTRO SALDO JS -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    const rows = document.querySelectorAll("#tabla-contratos tr");
    const inputBuscar = document.getElementById("buscador-contratos");
    const inputMin = document.getElementById("saldo-min");
    const inputMax = document.getElementById("saldo-max");
    const btnReset = document.getElementById("reset-saldo");

    // ðŸ” detectar min / max reales
    let saldos = Array.from(rows)
      .map(r => Number(r.querySelector("[data-saldo]")?.dataset.saldo))
      .filter(v => !isNaN(v));

    const minSaldo = Math.min(...saldos);
    const maxSaldo = Math.max(...saldos);

    inputMin.value = minSaldo;
    inputMax.value = maxSaldo;

    function aplicarFiltros() {
      const q = inputBuscar.value.toLowerCase();
      const min = Number(inputMin.value);
      const max = Number(inputMax.value);

      rows.forEach(row => {
        const texto = row.innerText.toLowerCase();
        const saldo = Number(row.querySelector("[data-saldo]")?.dataset.saldo);

        const matchTexto = texto.includes(q);
        const matchSaldo = saldo >= min && saldo <= max;

        row.style.display = (matchTexto && matchSaldo) ? "" : "none";
      });
    }

    inputBuscar.addEventListener("input", aplicarFiltros);
    inputMin.addEventListener("input", aplicarFiltros);
    inputMax.addEventListener("input", aplicarFiltros);

    btnReset.addEventListener("click", () => {
      inputMin.value = minSaldo;
      inputMax.value = maxSaldo;
      inputBuscar.value = "";
      aplicarFiltros();
    });

  });
</script>


{% endblock %}
