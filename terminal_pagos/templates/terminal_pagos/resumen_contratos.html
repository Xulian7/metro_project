{% extends "accounts/home.html" %}
{% block content %}

<div class="card p-4 shadow-sm">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0">
      Resumen financiero de contratos
      <small class="text-muted">(al {{ hoy }})</small>
    </h5>
  </div>

  <!-- ðŸ” BUSCADOR -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input
        type="text"
        id="buscador-contratos"
        class="form-control"
        placeholder="Buscar por contrato, cliente o placa">
    </div>
  </div>

  <!-- ðŸ“‹ TABLA -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Contrato</th>
          <th>Cliente</th>
          <th>VehÃ­culo</th>
          <th data-sort="sortable date">Antiguedad</th>
          <th data-sort="number" class="sortable text-end">Tarifa</th>
          <th data-sort="string" class="sortable text-center">Frecuencia</th>
          <th data-sort="number" class="sortable text-center">Cuotas vencidas</th>
          <th data-sort="number" class="sortable text-center">Pagos tarifa</th>
          <th data-sort="number" class="sortable text-center">Saldo</th>
          <th class="text-end">Acciones</th>

        </tr>
      </thead>

      <tbody id="tabla-contratos">
        {% for row in filas %}
        <tr>
          <td>#{{ row.contrato.id }}</td>
          <td>{{ row.contrato.cliente.nombre }}</td>
          <td>{{ row.contrato.vehiculo.placa }}</td>

          <!-- Inicio + antigÃ¼edad -->
          <td>
            {{ row.fecha_inicio|date:"d/m/Y" }}
            <br>
            <small class="text-muted">
              {{ row.dias_transcurridos }} dÃ­as
            </small>
          </td>

          <!-- Tarifa -->
          <td class="text-end">
            ${{ row.tarifa|floatformat:0 }}
          </td>

          <!-- Frecuencia -->
          <td class="text-center">
            {{ row.contrato.get_frecuencia_pago_display }}
          </td>

          <!-- Cuotas vencidas -->
          <td class="text-center fw-semibold">
            {{ row.cuotas_vencidas|floatformat:1 }}
          </td>

          <!-- Pagos -->
          <td class="text-center">
            <div class="fw-semibold">
              {{ row.cuotas_pagadas|floatformat:1 }} cuotas
            </div>
            <small class="text-muted">
              ${{ row.total_pagado|floatformat:0 }}
            </small>
          </td>

          <!-- Saldo -->
          <td class="text-center fw-semibold
            {% if row.saldo_cuotas > 0 %}
              text-danger
            {% elif row.saldo_cuotas < 0 %}
              text-primary
            {% else %}
              text-success
            {% endif %}
          ">
            {{ row.saldo_cuotas|floatformat:1 }}
            <br>
            <small>
              ${{ row.saldo_dinero|floatformat:0 }}
            </small>
          </td>

          <!-- ðŸ”˜ ACCIONES -->
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <button
                class="btn btn-outline-success"
                title="Cobrar">
                ðŸ’µ
              </button>

              <button
                class="btn btn-outline-primary btn-extracto"
                data-contrato-id="{{ row.contrato.id }}"
                title="Ver extracto de pagos">
                ðŸ“„
              </button>
            </div>
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted">
            No hay contratos para mostrar
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>



{% include "terminal_pagos/partials/extracto_modal.html" %}


<!-- EXTRACTO DE PAGOS JS -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll(".btn-extracto").forEach(btn => {
      btn.addEventListener("click", () => {
        const contratoId = btn.dataset.contratoId;

        fetch(`/terminal_pagos/extracto/contrato/${contratoId}/`)
          .then(res => res.json())
          .then(data => {
            const tbody = document.getElementById("extracto-body");
            tbody.innerHTML = "";

            data.filas.forEach(f => {
              const tr = document.createElement("tr");

              tr.innerHTML = `
                <td>${f.fecha_pactada}</td>

                <td class="text-end">
                  $${Number(f.valor_pactado).toLocaleString("es-CO")}
                </td>

                <td class="text-end">
                  $${Number(f.valor_aplicado).toLocaleString("es-CO")}
                </td>

                <td>
                  ${f.fecha_pago ?? "â€”"}
                </td>

                <td>
                  ${
                    f.factura_id
                      ? `<span class="badge bg-primary factura-tag"
                              data-factura-id="${f.factura_id}"
                              role="button">
                          #${f.factura_id}
                        </span>`
                      : "â€”"
                  }
                </td>
              `;

              tbody.appendChild(tr);
            });

            const modal = new bootstrap.Modal(
              document.getElementById("extractoModal")
            );
            modal.show();
          });
      });
    });
});
</script>

<!-- ðŸ”Ž BUSCADOR JS -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const buscador = document.getElementById("buscador-contratos");
    const filas = document.querySelectorAll("#tabla-contratos tr");

    buscador?.addEventListener("input", () => {
      const texto = buscador.value.toLowerCase();

      filas.forEach(fila => {
        const contrato = fila.children[0].innerText.toLowerCase();
        const cliente  = fila.children[1].innerText.toLowerCase();
        const placa    = fila.children[2].innerText.toLowerCase();

        fila.style.display =
          contrato.includes(texto) ||
          cliente.includes(texto) ||
          placa.includes(texto)
            ? ""
            : "none";
      });
    });
  });
</script>

<!-- ðŸ“Š ORDENAR TABLA JS -->
<script>
document.querySelectorAll("th.sortable").forEach((header, index) => {
  let asc = true;

  header.addEventListener("click", () => {
    const tbody = document.getElementById("tabla-contratos");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const type = header.dataset.sort;

    // Reset visual state
    document.querySelectorAll("th.sortable").forEach(th => {
      th.classList.remove("asc", "desc");
    });

    rows.sort((a, b) => {
      let A = a.children[index].innerText.trim();
      let B = b.children[index].innerText.trim();

      if (type === "number") {
        A = parseFloat(A.replace(/[^\d.-]/g, "")) || 0;
        B = parseFloat(B.replace(/[^\d.-]/g, "")) || 0;
      }

      if (type === "date") {
        A = new Date(A.split("/").reverse().join("-"));
        B = new Date(B.split("/").reverse().join("-"));
      }

      if (type === "string") {
        return asc ? A.localeCompare(B) : B.localeCompare(A);
      }

      return asc ? A - B : B - A;
    });

    header.classList.add(asc ? "asc" : "desc");
    asc = !asc;

    rows.forEach(row => tbody.appendChild(row));
  });
});
</script>



<style>
  th.sortable {
    cursor: pointer;
    user-select: none;
  }

  th.sortable::after {
    content: " â‡…";
    font-size: 0.75em;
    color: #adb5bd;
  }

  th.sortable.asc::after {
    content: " â–²";
    color: #0d6efd;
  }

  th.sortable.desc::after {
    content: " â–¼";
    color: #0d6efd;
  }
</style>


{% endblock %}
