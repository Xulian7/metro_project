{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="container-fluid">

  <!-- ================= TABS ================= -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active"
              data-bs-toggle="tab"
              data-bs-target="#tab-visor"
              type="button"
              role="tab">
        üßæ Visor de factura
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              data-bs-toggle="tab"
              data-bs-target="#tab-listado"
              type="button"
              role="tab">
        üìã Listado de facturas
      </button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ========================================================= -->
    <!-- ================= TAB VISOR FACTURA ==================== -->
    <!-- ========================================================= -->
    <div class="tab-pane fade show active" id="tab-visor" role="tabpanel">

      <!-- ================= SELECTOR ================= -->
      <div class="card p-4 shadow-sm mb-3">
        <label class="form-label fw-semibold">Buscar factura</label>

        <select id="factura-select" class="form-select">
          <option value="">Seleccione una factura‚Ä¶</option>
          {% for f in facturas %}
            <option value="{{ f.id }}">
              #{{ f.id }} ¬∑ {{ f.contrato.vehiculo.placa }} ¬∑ {{ f.contrato.cliente.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- ================= PANEL FACTURA ================= -->
      <div id="factura-panel" class="d-none">

        <!-- HEADER -->
        <div class="card shadow-sm mb-3">
          <div class="card-body d-flex justify-content-between align-items-center">

            <div>
              <h5 class="mb-0 fw-bold">
                Factura <span id="f-id"></span>
              </h5>
              <small class="text-muted d-block" id="f-fecha"></small>
              <small class="text-muted d-block">
                <span class="badge bg-success bg-opacity-10 text-success border">
                  ‚úî Registrada por <span id="f-creado-por">‚Äî</span>
                </span>
              </small>
            </div>

            <div class="text-end">
              <span id="f-estado" class="badge bg-secondary"></span>
              <span id="f-estado-pago" class="badge bg-info ms-1"></span>
            </div>

          </div>
        </div>

        <!-- RESUMEN -->
        <div class="row g-3 mb-3">

          <div class="col-md">
            <div class="card border-0 shadow-sm">
              <div class="card-body py-2">
                <small class="text-muted">Contrato</small>
                <div class="fw-semibold" id="f-contrato"></div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm">
              <div class="card-body py-2">
                <small class="text-muted">Total factura</small>
                <div class="fw-bold fs-5">$<span id="f-total"></span></div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm bg-success bg-opacity-10">
              <div class="card-body py-2">
                <small class="text-muted">Total pagado</small>
                <div class="fw-bold fs-5 text-success">
                  $<span id="f-pagado"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md">
            <div class="card border-0 shadow-sm bg-light">
              <div class="card-body py-2 text-end">
                <button id="btn-anular-factura"
                        class="btn btn-outline-danger btn-sm d-none">
                  üõë Anular factura
                </button>
              </div>
            </div>
          </div>

        </div>

        <!-- ITEMS -->
        <div class="card shadow-sm mb-3">
          <div class="card-header fw-semibold">√çtems de la factura</div>
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th>Tipo</th>
                  <th>Descripci√≥n</th>
                  <th class="text-end">Cantidad</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody id="items-body">
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">
                    Seleccione una factura
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- PAGOS -->
        <div class="card shadow-sm">
          <div class="card-header fw-semibold">Pagos aplicados</div>
          <div class="table-responsive">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th>Medio</th>
                  <th>Canal</th>
                  <th>Cuenta</th>
                  <th>Fecha</th>
                  <th class="text-end">Valor</th>
                </tr>
              </thead>
              <tbody id="pagos-body">
                <tr>
                  <td colspan="5" class="text-center text-muted py-3">
                    Seleccione una factura
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <!-- ========================================================= -->
    <!-- ================= TAB LISTADO FACTURAS ================= -->
    <!-- ========================================================= -->
    <div class="tab-pane fade" id="tab-listado" role="tabpanel">

      <div class="card shadow-sm mb-2">
        <div class="card-body py-2">
          <input
            type="text"
            id="factura-search"
            class="form-control form-control-sm"
            placeholder="Buscar por # factura, placa o cliente‚Ä¶">
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Facturas registradas</div>
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:70px">#</th>
                <th>Contrato</th>
                <th>Cliente</th>
                <th style="width:110px">Fecha</th>
                <th class="text-end" style="width:110px">Total</th>
                <th class="text-end" style="width:110px">Pagado</th>
                <th class="text-center" style="width:110px">Estado</th>
              </tr>
            </thead>

            <tbody id="facturas-tbody">
              {% for f in facturas %}
                <tr class="factura-row"
                    data-id="{{ f.id }}"
                    data-contrato="{{ f.contrato.vehiculo.placa }}"
                    data-cliente="{{ f.contrato.cliente.nombre }}"
                    data-estado="{{ f.estado }}"
                    style="cursor:pointer">

                  <td class="fw-semibold">#{{ f.id }}</td>

                  <td>
                    <span class="text-monospace">
                      {{ f.contrato.vehiculo.placa }}
                    </span>
                  </td>

                  <td>{{ f.contrato.cliente.nombre }}</td>

                  <td class="text-muted">
                    {{ f.fecha|date:"d/m/Y" }}
                  </td>

                  <td class="text-end fw-semibold">
                    ${{ f.total|floatformat:0 }}
                  </td>

                  <td class="text-end">
                    ${{ f.total_pagado|floatformat:0 }}
                  </td>

                  <td class="text-center">
                    <span class="badge
                      {% if f.estado == 'Activa' %}bg-success
                      {% elif f.estado == 'Anulada' %}bg-danger
                      {% else %}bg-secondary{% endif %}">
                      {{ f.estado }}
                    </span>
                  </td>

                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" class="text-center text-muted py-3">
                    No hay facturas registradas
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

        </div>
      </div>

    </div>

  </div>
</div>

<!-- ================= MODAL ANULAR FACTURA ================= -->
<div class="modal fade" id="modal-anular-factura" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title text-danger">üõë Anular factura</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">
          Esta acci√≥n es <strong>irreversible</strong>.
          Los pagos ser√°n compensados autom√°ticamente.
        </p>

        <label class="form-label fw-semibold">
          Motivo de la anulaci√≥n
        </label>
        <textarea
          id="motivo-anulacion"
          class="form-control"
          rows="3"
          maxlength="255"
          placeholder="Ej: Error de digitaci√≥n, pago aplicado a cliente incorrecto‚Ä¶"
        ></textarea>

        <small class="text-muted">
          M√°x. 255 caracteres
        </small>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary btn-sm"
          data-bs-dismiss="modal">
          Cancelar
        </button>

        <button
          type="button"
          class="btn btn-danger btn-sm"
          id="confirmar-anulacion">
          Confirmar anulaci√≥n
        </button>
      </div>

    </div>
  </div>
</div>




<!-- ================= LIBRER√çAS ================= -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- ================= JS VISOR ================= -->
<script>
  $(function () {

    $("#factura-select").select2({ width: "100%" });

    document.addEventListener("shown.bs.tab", function (e) {
      if (e.target.dataset.bsTarget === "#tab-visor") {
        $("#factura-select").select2("destroy").select2({
          width: "100%",
          placeholder: "Buscar factura‚Ä¶",
          allowClear: true
        });
      }
    });

    $("#factura-select").on("change", function () {
      const facturaId = this.value;
      if (!facturaId) return;

      fetch(`/terminal_pagos/visor-facturas/detalle/${facturaId}/`)
        .then(res => res.json())
        .then(data => {

          document.getElementById("factura-panel").classList.remove("d-none");

          document.getElementById("f-id").textContent = `#${data.factura.id}`;
          document.getElementById("f-fecha").textContent = data.factura.fecha;
          document.getElementById("f-total").textContent = data.factura.total;
          document.getElementById("f-pagado").textContent = data.factura.total_pagado;
          document.getElementById("f-estado").textContent = data.factura.estado;
          document.getElementById("f-estado-pago").textContent = data.factura.estado_pago;
          document.getElementById("f-creado-por").textContent = data.factura.creado_por || "‚Äî";
          document.getElementById("f-contrato").textContent =
            `#${data.contrato.id} ¬∑ ${data.contrato.vehiculo} ¬∑ ${data.contrato.cliente}`;

          const btn = document.getElementById("btn-anular-factura");
          btn.classList.add("d-none");

          if (data.factura.estado !== "Anulada") {
            btn.classList.remove("d-none");
            btn.dataset.facturaId = data.factura.id;
          }

          const itemsBody = document.getElementById("items-body");
          itemsBody.innerHTML = data.items.length
            ? data.items.map(i => `
              <tr>
                <td>${i.tipo}</td>
                <td>${i.descripcion || "‚Äî"}</td>
                <td class="text-end">${i.cantidad}</td>
                <td class="text-end">$${i.subtotal}</td>
              </tr>`).join("")
            : `<tr><td colspan="4" class="text-center text-muted py-3">Sin √≠tems</td></tr>`;

          const pagosBody = document.getElementById("pagos-body");
          pagosBody.innerHTML = data.pagos.length
            ? data.pagos.map(p => `
              <tr>
                <td>${p.medio}</td>
                <td>${p.canal}</td>
                <td>${p.cuenta}</td>
                <td>${p.fecha}</td>
                <td class="text-end">$${p.valor}</td>
              </tr>`).join("")
            : `<tr><td colspan="5" class="text-center text-muted py-3">Sin pagos</td></tr>`;
        });
    });

  });
</script>

<!-- ================= JS ANULAR FACTURA ================= -->
<script>
  let facturaAAnular = null;

  document.addEventListener("click", function (e) {
    const btn = e.target.closest("#btn-anular-factura");
    if (!btn) return;

    facturaAAnular = btn.dataset.facturaId;
    document.getElementById("motivo-anulacion").value = "";

    const modal = new bootstrap.Modal(
      document.getElementById("modal-anular-factura")
    );
    modal.show();
  });

  document.getElementById("confirmar-anulacion")
    .addEventListener("click", function () {

      const motivo = document
        .getElementById("motivo-anulacion")
        .value
        .trim();

      if (!motivo) {
        alert("Debes ingresar un motivo de anulaci√≥n.");
        return;
      }

      fetch(`/terminal_pagos/facturas/anular/${facturaAAnular}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ motivo })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.ok) {
          alert(data.error || "No se pudo anular la factura");
          return;
        }

        alert("‚úÖ Factura anulada correctamente");
        location.reload();
      })
      .catch(() => {
        alert("Error al anular la factura");
      });
    });
</script>

<!-- ================= JS LISTADO FACTURAS ================= -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    const searchInput = document.getElementById("factura-search");
    const tbody = document.querySelector("#tab-listado tbody");

    if (!tbody) return;

    let rows = Array.from(tbody.querySelectorAll(".factura-row"));

    /* ===== ORDENAR POR # FACTURA (DESC) ===== */
    rows
      .sort((a, b) => {
        return parseInt(b.dataset.id) - parseInt(a.dataset.id);
      })
      .forEach(row => tbody.appendChild(row));

    /* ===== BUSCADOR ===== */
    searchInput?.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase().trim();

      rows.forEach(row => {
        const id = row.dataset.id || "";
        const placa = row.dataset.placa?.toLowerCase() || "";
        const cliente = row.dataset.cliente?.toLowerCase() || "";

        const match =
          id.includes(q) ||
          placa.includes(q) ||
          cliente.includes(q);

        row.style.display = match ? "" : "none";
      });
    });

  });
</script>


{% endblock %}
