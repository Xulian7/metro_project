{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="container-fluid">

  <!-- ================= SELECTOR ================= -->
  <div class="card p-4 shadow-sm mb-3">
    <label class="form-label fw-semibold">Buscar factura</label>

    <select id="factura-select" class="form-select">
      <option value="">Seleccione una factura‚Ä¶</option>
      {% for f in facturas %}
        <option value="{{ f.id }}">
          #{{ f.id }} ¬∑ {{ f.contrato.vehiculo.placa }} ¬∑ {{ f.contrato.cliente.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- ================= PANEL FACTURA ================= -->
  <div id="factura-panel" class="d-none">

    <!-- HEADER -->
    <div class="card shadow-sm mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">

        <div>
          <h5 class="mb-0 fw-bold">
            Factura <span id="f-id"></span>
          </h5>
          <small class="text-muted d-block" id="f-fecha"></small>
          <small class="text-muted d-block">
            <span class="badge bg-success bg-opacity-10 text-success border">
              ‚úî Registrada por <span id="f-creado-por">‚Äî</span>
            </span>
          </small>
        </div>

        <div class="text-end">
          <span id="f-estado" class="badge bg-secondary"></span>
          <span id="f-estado-pago" class="badge bg-info ms-1"></span>
        </div>

      </div>
    </div>

    <!-- RESUMEN -->
    <div class="row g-3 mb-3">

      <div class="col-md">
        <div class="card border-0 shadow-sm">
          <div class="card-body py-2">
            <small class="text-muted">Contrato</small>
            <div class="fw-semibold">
              <span id="f-contrato"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md">
        <div class="card border-0 shadow-sm">
          <div class="card-body py-2">
            <small class="text-muted">Total factura</small>
            <div class="fw-bold fs-5">$<span id="f-total"></span></div>
          </div>
        </div>
      </div>

      <div class="col-md">
        <div class="card border-0 shadow-sm bg-success bg-opacity-10">
          <div class="card-body py-2">
            <small class="text-muted">Total pagado</small>
            <div class="fw-bold fs-5 text-success">
              $<span id="f-pagado"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md">
        <div class="card border-0 shadow-sm bg-light">
          <div class="card-body py-2 text-end">
            <button
              id="btn-anular-factura"
              class="btn btn-outline-danger btn-sm d-none"
              title="Anular factura (acci√≥n irreversible)"
            >
              üõë Anular factura
            </button>
          </div>
        </div>
      </div>


    </div>

    <!-- ================= ITEMS ================= -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-semibold">
        √çtems de la factura
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Tipo</th>
              <th>Descripci√≥n</th>
              <th class="text-end">Cantidad</th>
              <th class="text-end">Subtotal</th>
            </tr>
          </thead>
          <tbody id="items-body">
            <tr>
              <td colspan="4" class="text-center text-muted py-3">
                Seleccione una factura
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ================= PAGOS ================= -->
    <div class="card shadow-sm">
      <div class="card-header fw-semibold">
        Pagos aplicados
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Medio</th>
              <th>Canal</th>
              <th>Cuenta</th>
              <th>Fecha</th>
              <th class="text-end">Valor</th>
            </tr>
          </thead>
          <tbody id="pagos-body">
            <tr>
              <td colspan="5" class="text-center text-muted py-3">
                Seleccione una factura
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

</div>

<!-- ================= LIBRER√çAS ================= -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- ================= JS ================= -->
<script>
$(function () {

  $("#factura-select").select2({
    width: "100%",
    placeholder: "Buscar factura‚Ä¶"
  });

  $("#factura-select").on("change", function () {
    const facturaId = this.value;
    if (!facturaId) return;

    fetch(`/terminal_pagos/visor-facturas/detalle/${facturaId}/`)
      .then(res => res.json())
      .then(data => {

        document.getElementById("factura-panel").classList.remove("d-none");

        // Header
        document.getElementById("f-id").textContent = `#${data.factura.id}`;
        document.getElementById("f-fecha").textContent = data.factura.fecha;
        document.getElementById("f-total").textContent = data.factura.total;
        document.getElementById("f-pagado").textContent = data.factura.total_pagado;
        document.getElementById("f-estado").textContent = data.factura.estado;
        document.getElementById("f-estado-pago").textContent = data.factura.estado_pago;
        document.getElementById("f-creado-por").textContent = data.factura.creado_por || "‚Äî";
        document.getElementById("f-contrato").textContent =
          `#${data.contrato.id} ¬∑ ${data.contrato.vehiculo} ¬∑ ${data.contrato.cliente}`;

        // Bot√≥n anular
        const btnAnular = document.getElementById("btn-anular-factura");
        // reset por seguridad
        btnAnular.classList.add("d-none");
        btnAnular.removeAttribute("data-factura-id");

        // solo mostrar si NO est√° anulada
        if (data.factura.estado !== "Anulada") {
          btnAnular.classList.remove("d-none");
          btnAnular.dataset.facturaId = data.factura.id;
        }

        // √çtems
        const itemsBody = document.getElementById("items-body");
        itemsBody.innerHTML = "";

        if (!data.items.length) {
          itemsBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted py-3">
                Sin √≠tems
              </td>
            </tr>
          `;
        } else {
          data.items.forEach(i => {
            itemsBody.innerHTML += `
              <tr>
                <td>${i.tipo}</td>
                <td>${i.descripcion || "‚Äî"}</td>
                <td class="text-end">${i.cantidad}</td>
                <td class="text-end">$${i.subtotal}</td>
              </tr>
            `;
          });
        }

        // Pagos
        const pagosBody = document.getElementById("pagos-body");
        pagosBody.innerHTML = "";

        if (!data.pagos.length) {
          pagosBody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted py-3">
                Sin pagos registrados
              </td>
            </tr>
          `;
        } else {
          data.pagos.forEach(p => {
            pagosBody.innerHTML += `
              <tr>
                <td>${p.medio}</td>
                <td>${p.canal}</td>
                <td>${p.cuenta}</td>
                <td>${p.fecha}</td>
                <td class="text-end">$${p.valor}</td>
              </tr>
            `;
          });
        }

      })
      .catch(() => {
        alert("Error al cargar la factura");
      });
  });

});
</script>

<!-- ================= ANULAR FACTURA ================= -->
<script>
  document.addEventListener("click", function (e) {
    const btn = e.target.closest("#btn-anular-factura");
    if (!btn) return;

    alert("üöß Under construction\n\nLa anulaci√≥n de facturas estar√° disponible pr√≥ximamente.");
  });
</script>



{% endblock %}
