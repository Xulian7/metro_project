{% extends "accounts/home.html" %}

{% block content %}

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold mb-3">Nuevo crédito</h3>

  <form method="post" id="credito-form">
    {% csrf_token %}

    <!-- CONTRATO -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Contrato</label>
        {{ form.contrato }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Comentario general</label>
        {{ form.descripcion }}
      </div>
    </div>

    <hr>

    <!-- ÍTEMS -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold mb-0">Ítems del crédito</h5>
      <button type="button"
              class="btn btn-sm btn-outline-primary"
              id="btn-add-item">
        + Agregar ítem
      </button>
    </div>

    <div id="items-container"></div>

    <hr>

    <!-- TOTAL -->
    <div class="text-end mb-3">
      <strong>Total crédito:</strong>
      <span id="total-credito">$0</span>
    </div>

    <!-- GUARDAR -->
    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4">
        Guardar crédito
      </button>
    </div>

  </form>
</div>

<!-- ================= TEMPLATE FILA ================= -->
<div id="item-template" class="d-none">
  <div class="row g-2 align-items-center mb-2 credito-item-row">

    <!-- TIPO -->
    <div class="col-2">
      <select class="form-select form-select-sm item-tipo"
              name="item_tipo[]">
        <option value="">Tipo</option>
        <option value="almacen">Almacén</option>
        <option value="taller">Taller</option>
        <option value="efectivo">Efectivo</option>
      </select>
    </div>

    <!-- ITEM / SERVICIO -->
    <div class="col-3 item-desc-container"></div>

    <!-- OBS -->
    <div class="col-2">
      <input type="text"
             class="form-control form-control-sm item-obs"
             name="item_observacion[]"
             placeholder="Observación">
    </div>

    <!-- CANT -->
    <div class="col-1">
      <input type="number"
             class="form-control form-control-sm item-cant"
             name="item_cantidad[]"
             min="1"
             placeholder="Cant">
    </div>

    <!-- VALOR -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-valor text-end"
             name="item_valor[]"
             step="0.01"
             placeholder="$">
    </div>

    <!-- SUBTOTAL -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-subtotal text-end"
             name="item_subtotal[]"
             step="0.01"
             readonly>
    </div>

    <!-- REMOVE -->
    <div class="col-auto">
      <button type="button"
              class="btn btn-sm btn-outline-danger btn-remove-item">
        ✖
      </button>
    </div>

  </div>
</div>

<!-- ================= DATOS BACKEND ================= -->
<script>
  const ALMACEN_ITEMS = {{ productos|safe }};
  const TALLER_ITEMS  = {{ servicios|safe }};
</script>

<!-- ================= JS ================= -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    const btnAdd = document.getElementById("btn-add-item");
    const container = document.getElementById("items-container");
    const template = document.getElementById("item-template");
    const totalLabel = document.getElementById("total-credito");

    // ---------- Utils ----------
    const num = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    const updateTotal = () => {
      let t = 0;
      document.querySelectorAll(".item-subtotal").forEach(i => {
        t += num(i.value);
      });
      totalLabel.textContent = `$${t.toLocaleString("es-CO")}`;
    };

    const updateSubtotal = row => {
      const tipo = row.querySelector(".item-tipo").value;
      const cant = num(row.querySelector(".item-cant").value);
      const val  = num(row.querySelector(".item-valor").value);
      let sub = 0;

      if (tipo === "almacen" || tipo === "taller") sub = cant * val;
      if (tipo === "efectivo") sub = val;

      row.querySelector(".item-subtotal").value = sub ? sub.toFixed(2) : "";
      updateTotal();
    };

    // ---------- Builders ----------
    const buildSelect = (items) => {
      const s = document.createElement("select");
      s.name = "item_descripcion[]";
      s.className = "form-select form-select-sm item-desc";

      s.innerHTML = `<option value="">Seleccione...</option>`;

      items.forEach(i => {
        const o = document.createElement("option");
        o.value = i.nombre;
        o.textContent = i.nombre;
        o.dataset.precio = i.precio;
        s.appendChild(o);
      });

      return s;
    };

    const buildInput = () => {
      const i = document.createElement("input");
      i.type = "text";
      i.name = "item_descripcion[]";
      i.className = "form-control form-control-sm item-desc";
      i.placeholder = "Detalle del préstamo";
      return i;
    };

    // ---------- Tipo Rules ----------
    const applyTipo = row => {
      const tipo = row.querySelector(".item-tipo").value;
      const cont = row.querySelector(".item-desc-container");
      const cant = row.querySelector(".item-cant");
      const val  = row.querySelector(".item-valor");

      cont.innerHTML = "";

      if (tipo === "almacen") {
        const sel = buildSelect(
          ALMACEN_ITEMS.map(p => ({ nombre: p.nombre, precio: p.precio_venta }))
        );
        sel.addEventListener("change", () => {
          val.value = sel.selectedOptions[0]?.dataset.precio || "";
          updateSubtotal(row);
        });
        cont.appendChild(sel);
        cant.disabled = false;
      }

      if (tipo === "taller") {
        const sel = buildSelect(
          TALLER_ITEMS.map(s => ({ nombre: s.nombre, precio: s.valor }))
        );
        sel.addEventListener("change", () => {
          val.value = sel.selectedOptions[0]?.dataset.precio || "";
          updateSubtotal(row);
        });
        cont.appendChild(sel);
        cant.disabled = false;
      }

      if (tipo === "efectivo") {
        cont.appendChild(buildInput());
        cant.value = "";
        cant.disabled = true;
      }

      updateSubtotal(row);
    };

    // ---------- Row ----------
    const addRow = () => {
      const r = template.firstElementChild.cloneNode(true);

      r.querySelector(".item-tipo").addEventListener("change", () => applyTipo(r));
      r.querySelector(".item-cant").addEventListener("input", () => updateSubtotal(r));
      r.querySelector(".item-valor").addEventListener("input", () => updateSubtotal(r));
      r.querySelector(".btn-remove-item").addEventListener("click", () => {
        r.remove();
        updateTotal();
      });

      container.appendChild(r);
    };

    btnAdd.addEventListener("click", addRow);
  });
</script>

{% endblock %}
