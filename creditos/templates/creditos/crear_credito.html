{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold mb-3">Nuevo cr√©dito</h3>

  <form method="post" id="credito-form">
    {% csrf_token %}

    <!-- CABECERA -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Contrato</label>
        {{ form.contrato }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Comentario general</label>
        {{ form.descripcion }}
      </div>
    </div>

    <hr>

    <!-- √çTEMS -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold mb-0">√çtems del cr√©dito</h5>
      <button type="button"
              class="btn btn-sm btn-outline-primary"
              id="btn-add-item">
        + Agregar √≠tem
      </button>
    </div>

    <!-- ================= ENCABEZADOS STICKY ================= -->
    <div class="row g-2 align-items-center text-muted small fw-semibold sticky-top bg-white py-2 border-bottom"
         style="top: 0; z-index: 5">

      <div class="col-2">Tipo</div>
      <div class="col-4">√çtem / Servicio</div>
      <div class="col-1 text-center">Cant.</div>
      <div class="col-2 text-end">Valor</div>
      <div class="col-2 text-end">Subtotal</div>
      <div class="col-1"></div>

    </div>
    <!-- ================= FIN ENCABEZADOS ================= -->

    <div id="items-container" class="pt-2"></div>

    <hr>

    <!-- TOTAL -->
    <div class="text-end mb-3">
      <strong>Total cr√©dito:</strong>
      <span id="total-credito">$0</span>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4">
        Guardar cr√©dito
      </button>
    </div>
  </form>
</div>

<!-- ================= TEMPLATE FILA ================= -->
<div id="item-template" class="d-none">
  <div class="row g-2 align-items-center mb-2 credito-item-row">

    <!-- TIPO -->
    <div class="col-2">
      <select class="form-select form-select-sm item-tipo"
              name="item_tipo[]">
        <option value="">Tipo</option>
        <option value="almacen">Almac√©n</option>
        <option value="taller">Taller</option>
        <option value="efectivo">Efectivo</option>
      </select>
    </div>

    <!-- ITEM / SERVICIO -->
    <div class="col-4 item-desc-container">
      <input type="hidden" name="item_descripcion[]" value="">
    </div>

    <!-- CANTIDAD (MINIMIZADA) -->
    <div class="col-1">
      <input type="number"
             class="form-control form-control-sm item-cant text-center"
             name="item_cantidad[]"
             min="1"
             value="1"
             style="min-width:48px; padding-left:4px; padding-right:4px;">
    </div>

    <!-- VALOR -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-valor text-end"
             name="item_valor[]"
             step="1000"
             placeholder="$">
    </div>

    <!-- SUBTOTAL -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-subtotal text-end"
             name="item_subtotal[]"
             readonly>
    </div>

    <!-- ACCI√ìN -->
    <div class="col-1 text-center">
      <button type="button"
              class="btn btn-sm btn-outline-danger btn-remove-item"
              title="Eliminar √≠tem">
        ‚úñ
      </button>
    </div>

  </div>
</div>

<!-- ================= CR√âDITOS REGISTRADOS ================= -->
<hr class="my-4">
<h5 class="fw-bold mb-3">Cr√©ditos registrados</h5>

<!-- Filtros de b√∫squeda -->
<div class="row mb-2 align-items-center">
  <div class="col-md-4">
    <input type="text"
           id="credito-search"
           class="form-control form-control-sm"
           placeholder="Buscar por contrato, descripci√≥n o ID‚Ä¶">
  </div>

  <div class="col-md-4">
    <div class="form-check mt-1">
      <input class="form-check-input"
             type="checkbox"
             id="show-pagados">
      <label class="form-check-label" for="show-pagados">
        Mostrar cr√©ditos pagados
      </label>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Contrato</th>
        <th>Descripci√≥n</th>
        <th>Fecha</th>
        <th class="text-end">Monto</th>
        <th class="text-end">Saldo</th>
        <th class="text-center">Estado</th>
        <th class="text-center">Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for credito in creditos %}
        <tr class="credito-row"
            data-id="{{ credito.id }}"
            data-contrato="{{ credito.contrato }}"
            data-descripcion="{{ credito.descripcion }}"
            data-estado="{{ credito.estado }}">
          <td>
            <span class="credito-tag text-primary fw-semibold"
                  data-credito-id="{{ credito.id }}"
                  style="cursor:pointer;">
              #{{ credito.id }}
            </span>
          </td>
          <td>{{ credito.contrato }}</td>
          <td style="max-width:300px">{{ credito.descripcion|default:"‚Äî" }}</td>
          <td>{{ credito.fecha|date:"d/m/Y" }}</td>
          <td class="text-end">${{ credito.monto_total|floatformat:0 }}</td>
          <td class="text-end">${{ credito.saldo|floatformat:0 }}</td>
          <td class="text-center">
            <span class="badge
              {% if credito.estado == 'Activo' %}
                bg-success
              {% elif credito.estado == 'Pagado' %}
                bg-primary
              {% else %}
                bg-secondary
              {% endif %}
            ">
              {{ credito.estado }}
            </span>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-danger" disabled>Eliminar</button>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted">
            No hay cr√©ditos registrados
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



<!-- ================= LIBRER√çAS ================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<!-- ================= DATOS EN JSON ================= -->
{{ productos|json_script:"productos-data" }}
{{ servicios|json_script:"servicios-data" }}

<!-- ================= SCRIPT B√öSQUEDA ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const searchInput = document.getElementById("credito-search");
  const showPagados = document.getElementById("show-pagados");
  const rows = document.querySelectorAll(".credito-row");

  function filtrar() {
    const q = searchInput.value.toLowerCase().trim();
    const mostrarPagados = showPagados.checked;

    rows.forEach(row => {
      const id = row.dataset.id?.toLowerCase() || "";
      const contrato = row.dataset.contrato?.toLowerCase() || "";
      const descripcion = row.dataset.descripcion?.toLowerCase() || "";
      const estado = row.dataset.estado;

      const matchTexto =
        id.includes(q) ||
        contrato.includes(q) ||
        descripcion.includes(q);

      const matchEstado =
        mostrarPagados || estado !== "Pagado";

      row.style.display =
        matchTexto && matchEstado ? "" : "none";
    });
  }

  searchInput.addEventListener("input", filtrar);
  showPagados.addEventListener("change", filtrar);

  // estado inicial
  filtrar();
});
</script>


<!-- ================= SCRIPT ================= -->
<script>
  document.addEventListener("DOMContentLoaded", () => {


    const productos = JSON.parse(
      document.getElementById("productos-data").textContent
    );
    const servicios = JSON.parse(
      document.getElementById("servicios-data").textContent
    );

    const btnAdd = document.getElementById("btn-add-item");
    const container = document.getElementById("items-container");
    const template = document.getElementById("item-template");
    const totalLabel = document.getElementById("total-credito");
    const form = document.getElementById("credito-form");

    /* ---------------- utils ---------------- */
    const toNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    function updateTotal() {
      let total = 0;
      document.querySelectorAll(".item-subtotal").forEach(i => {
        total += toNum(i.value);
      });
      totalLabel.textContent = `$${total.toLocaleString("es-CO")}`;
    }

    function updateSubtotal(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const cant = toNum(row.querySelector(".item-cant")?.value);
      const valor = toNum(row.querySelector(".item-valor")?.value);

      let subtotal = 0;
      if (tipo === "efectivo") {
        subtotal = valor;
      } else {
        subtotal = cant * valor;
      }

      row.querySelector(".item-subtotal").value =
        subtotal ? subtotal.toFixed(2) : "";

      updateTotal();
    }

    function buildSelect(items) {
      const sel = document.createElement("select");
      sel.className = "form-select form-select-sm item-desc item-select2";
      sel.name = "item_descripcion[]";
      sel.innerHTML = `<option value="">Seleccione‚Ä¶</option>`;

      items.forEach(i => {
        const opt = document.createElement("option");
        opt.value = i.label;
        opt.dataset.precio = i.precio;
        opt.textContent = i.label;
        sel.appendChild(opt);
      });

      return sel;
    }

    function applyTipo(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const descBox = row.querySelector(".item-desc-container");
      const cant = row.querySelector(".item-cant");
      const valor = row.querySelector(".item-valor");

      // limpiar contenedor del item
      descBox.innerHTML = "";

      // reset base
      cant.disabled = false;
      cant.value = "1";
      valor.value = "";
      valor.placeholder = "$";
      valor.readOnly = false;

      /* ================= ALMAC√âN ================= */
      if (tipo === "almacen") {
        const sel = buildSelect(productos);
        descBox.appendChild(sel);

        $(sel).select2({
          width: "100%",
          placeholder: "Buscar producto‚Ä¶",
          allowClear: true
        });

        $(sel).on("select2:select", function (e) {
          const opt = e.params.data.element;
          valor.value = opt.dataset.precio || "";
          updateSubtotal(row);
        });

        valor.readOnly = true;
      }

      /* ================= TALLER ================= */
      else if (tipo === "taller") {
        const sel = buildSelect(servicios);
        descBox.appendChild(sel);

        $(sel).select2({
          width: "100%",
          placeholder: "Buscar servicio‚Ä¶",
          allowClear: true
        });

        $(sel).on("select2:select", function (e) {
          const opt = e.params.data.element;
          valor.value = opt.dataset.precio || "";
          updateSubtotal(row);
        });

        valor.readOnly = true;
      }

      /* ================= EFECTIVO ================= */
      else if (tipo === "efectivo") {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.name = "item_descripcion[]";
        inp.placeholder = "Detalle del pr√©stamo";
        inp.className = "form-control form-control-sm";
        descBox.appendChild(inp);

        cant.disabled = false;
        cant.value = "1";
        valor.readOnly = false;
        valor.placeholder = "Valor del pr√©stamo";
      }

      updateSubtotal(row);
    }


    /* -------- agregar nueva fila -------- */
    function addRow() {
      const row = template
        .querySelector(".credito-item-row")
        .cloneNode(true);

      row.querySelector(".item-tipo")
        .addEventListener("change", () => applyTipo(row));

      row.querySelector(".item-cant")
        .addEventListener("input", () => updateSubtotal(row));

      row.querySelector(".item-valor")
        .addEventListener("input", () => updateSubtotal(row));

      row.querySelector(".btn-remove-item")
        .addEventListener("click", () => {
          row.remove();
          updateTotal();
        });

      container.appendChild(row);
    }


    /* -------- validaci√≥n m√≠nima -------- */
    form.addEventListener("submit", e => {
      const rows = document.querySelectorAll(".credito-item-row");
      if (!rows.length) {
        alert("Debes agregar al menos un √≠tem al cr√©dito.");
        e.preventDefault();
      }
    });

    btnAdd.addEventListener("click", addRow);
  });
</script>

<!-- ================= SCRIPT POPOVERS CR√âDITOS ================= -->
<script>
  let popover = null;
  let hideTimer = null;
  let activo = false;

  document.addEventListener("mouseover", function (e) {
    const tag = e.target.closest(".credito-tag");
    if (!tag) return;

    if (hideTimer) clearTimeout(hideTimer);

    // Ya activo sobre este mismo tag ‚Üí no recrear
    if (activo && popover && popover._element === tag) return;

    // Cerrar otros popovers
    document.querySelectorAll(".credito-tag").forEach(t => {
      bootstrap.Popover.getInstance(t)?.dispose();
    });

    const creditoId = tag.dataset.creditoId;

    popover = new bootstrap.Popover(tag, {
      html: true,
      trigger: "manual",
      placement: "right",
      container: "body",
      sanitize: false,
      content: `
        <div id="popover-credito-content" style="min-width:260px">
          <em class="text-muted">Cargando √≠tems‚Ä¶</em>
        </div>
      `,
    });

    popover.show();
    activo = true;

    // üîÅ Fetch SOLO actualiza el contenido interno
    fetch(`/creditos/items/${creditoId}/`)
      .then(res => res.text())
      .then(html => {
        const cont = document.getElementById("popover-credito-content");
        if (!cont) return;

        cont.innerHTML = html;

        // Mantener abierto al pasar el mouse al popover
        const popEl = cont.closest(".popover");
        if (popEl) {
          popEl.addEventListener("mouseenter", () => {
            if (hideTimer) clearTimeout(hideTimer);
          });
          popEl.addEventListener("mouseleave", scheduleHide);
        }
      })
      .catch(() => {
        const cont = document.getElementById("popover-credito-content");
        if (cont) {
          cont.innerHTML = `
            <span class="text-danger">
              Error al cargar el detalle del cr√©dito
            </span>
          `;
        }
      });
  });

  document.addEventListener("mouseout", function (e) {
    const tag = e.target.closest(".credito-tag");
    if (!tag || tag.contains(e.relatedTarget)) return;
    scheduleHide();
  });

  function scheduleHide() {
    hideTimer = setTimeout(() => {
      document.querySelectorAll(".credito-tag").forEach(t => {
        bootstrap.Popover.getInstance(t)?.dispose();
      });
      popover = null;
      activo = false;
    }, 300);
  }
</script>
<!-- ================= END SCRIPT ================= -->


{% endblock %}