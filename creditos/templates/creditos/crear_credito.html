{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold mb-3">Nuevo crédito</h3>

  <form method="post" id="credito-form">
    {% csrf_token %}

    <!-- CABECERA -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Contrato</label>
        {{ form.contrato }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Comentario general</label>
        {{ form.descripcion }}
      </div>
    </div>

    <hr>

    <!-- ÍTEMS -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold mb-0">Ítems del crédito</h5>
      <button type="button"
              class="btn btn-sm btn-outline-primary"
              id="btn-add-item">
        + Agregar ítem
      </button>
    </div>

    <div id="items-container"></div>

    <hr>

    <!-- TOTAL -->
    <div class="text-end mb-3">
      <strong>Total crédito:</strong>
      <span id="total-credito">$0</span>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4">
        Guardar crédito
      </button>
    </div>
  </form>
</div>

<!-- ================= TEMPLATE FILA ================= -->
<div id="item-template" class="d-none">
  <div class="row g-2 align-items-center mb-2 credito-item-row">

    <!-- TIPO -->
    <div class="col-2">
      <select class="form-select form-select-sm item-tipo"
              name="item_tipo[]">
        <option value="">Tipo</option>
        <option value="almacen">Almacén</option>
        <option value="taller">Taller</option>
        <option value="efectivo">Efectivo</option>
      </select>
    </div>

    <!-- ITEM / SERVICIO -->
    <div class="col-4 item-desc-container">
      <input type="hidden" name="item_descripcion[]" value="">
    </div>

    <!-- CANTIDAD -->
    <div class="col-1">
      <input type="number"
             class="form-control form-control-sm item-cant text-center"
             name="item_cantidad[]"
             min="1"
             value="1">
    </div>

    <!-- VALOR -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-valor text-end"
             name="item_valor[]"
             step="1000"
             placeholder="$">
    </div>

    <!-- SUBTOTAL -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-subtotal text-end"
             name="item_subtotal[]"
             readonly>
    </div>

    <!-- ACCIÓN -->
    <div class="col-1 text-center">
      <button type="button"
              class="btn btn-sm btn-outline-danger btn-remove-item"
              title="Eliminar ítem">
        ✖
      </button>
    </div>

  </div>
</div>

<!-- ================= CRÉDITOS REGISTRADOS ================= -->
<hr class="my-4">
<h5 class="fw-bold mb-3">Créditos registrados</h5>

<div class="row mb-2">
  <div class="col-md-4">
    <input type="text"
           id="credito-search"
           class="form-control form-control-sm"
           placeholder="Buscar por contrato, descripción o ID…">
  </div>
</div>

<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Contrato</th>
        <th>Descripción</th>
        <th>Fecha</th>
        <th class="text-end">Monto</th>
        <th class="text-end">Saldo</th>
        <th class="text-center">Estado</th>
        <th class="text-center">Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for credito in creditos %}
        <tr class="credito-row"
            data-id="{{ credito.id }}"
            data-contrato="{{ credito.contrato }}"
            data-descripcion="{{ credito.descripcion }}">

          <!-- ID clickeable (detalle en el siguiente paso) -->
          <td class="text-center">
            <a href="#"
              class="credito-popover fw-bold text-decoration-none"
              data-credito-id="{{ credito.id }}"
              data-bs-toggle="popover"
              data-bs-placement="right"
              data-bs-html="true"
              data-bs-content="Cargando…">
              {{ credito.id }}
            </a>
          </td>

          <td>{{ credito.contrato }}</td>

          <td style="max-width: 300px;">
            {{ credito.descripcion|default:"—" }}
          </td>

          <td>{{ credito.fecha|date:"d/m/Y" }}</td>

          <td class="text-end">
            ${{ credito.monto_total|floatformat:0 }}
          </td>

          <td class="text-end">
            ${{ credito.saldo|floatformat:0 }}
          </td>

          <td class="text-center">
            <span class="badge {% if credito.estado == 'Activo' %}bg-success{% else %}bg-secondary{% endif %}">
              {{ credito.estado }}
            </span>
          </td>

          <td class="text-center">
            <!-- Visual por ahora -->
            <button class="btn btn-sm btn-outline-secondary" disabled>
              Abonos
            </button>

            <button class="btn btn-sm btn-outline-danger" disabled>
              Eliminar
            </button>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted">
            No hay créditos registrados
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



<!-- ================= LIBRERÍAS ================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>




{{ productos|json_script:"productos-data" }}
{{ servicios|json_script:"servicios-data" }}

<!-- ================= SCRIPT BÚSQUEDA ================= -->
<script>
    document.addEventListener("DOMContentLoaded", () => {

      const searchInput = document.getElementById("credito-search");
      const rows = document.querySelectorAll(".credito-row");

      searchInput.addEventListener("input", () => {
        const q = searchInput.value.toLowerCase().trim();

        rows.forEach(row => {
          const id = row.dataset.id?.toLowerCase() || "";
          const contrato = row.dataset.contrato?.toLowerCase() || "";
          const descripcion = row.dataset.descripcion?.toLowerCase() || "";

          const match =
            id.includes(q) ||
            contrato.includes(q) ||
            descripcion.includes(q);

          row.style.display = match ? "" : "none";
        });
      });

    });
</script>

<!-- ================= SCRIPT ================= -->
<script>
  document.addEventListener("DOMContentLoaded", () => {


    const productos = JSON.parse(
      document.getElementById("productos-data").textContent
    );
    const servicios = JSON.parse(
      document.getElementById("servicios-data").textContent
    );

    const btnAdd = document.getElementById("btn-add-item");
    const container = document.getElementById("items-container");
    const template = document.getElementById("item-template");
    const totalLabel = document.getElementById("total-credito");
    const form = document.getElementById("credito-form");

    /* ---------------- utils ---------------- */
    const toNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    function updateTotal() {
      let total = 0;
      document.querySelectorAll(".item-subtotal").forEach(i => {
        total += toNum(i.value);
      });
      totalLabel.textContent = `$${total.toLocaleString("es-CO")}`;
    }

    function updateSubtotal(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const cant = toNum(row.querySelector(".item-cant")?.value);
      const valor = toNum(row.querySelector(".item-valor")?.value);

      let subtotal = 0;
      if (tipo === "efectivo") {
        subtotal = valor;
      } else {
        subtotal = cant * valor;
      }

      row.querySelector(".item-subtotal").value =
        subtotal ? subtotal.toFixed(2) : "";

      updateTotal();
    }

    function buildSelect(items) {
      const sel = document.createElement("select");
      sel.className = "form-select form-select-sm item-desc item-select2";
      sel.name = "item_descripcion[]";
      sel.innerHTML = `<option value="">Seleccione…</option>`;

      items.forEach(i => {
        const opt = document.createElement("option");
        opt.value = i.label;
        opt.dataset.precio = i.precio;
        opt.textContent = i.label;
        sel.appendChild(opt);
      });

      return sel;
    }

    function applyTipo(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const descBox = row.querySelector(".item-desc-container");
      const cant = row.querySelector(".item-cant");
      const valor = row.querySelector(".item-valor");

      // limpiar contenedor del item
      descBox.innerHTML = "";

      // reset base
      cant.disabled = false;
      cant.value = "1";
      valor.value = "";
      valor.placeholder = "$";
      valor.readOnly = false;

      /* ================= ALMACÉN ================= */
      if (tipo === "almacen") {
        const sel = buildSelect(productos);
        descBox.appendChild(sel);

        $(sel).select2({
          width: "100%",
          placeholder: "Buscar producto…",
          allowClear: true
        });

        $(sel).on("select2:select", function (e) {
          const opt = e.params.data.element;
          valor.value = opt.dataset.precio || "";
          updateSubtotal(row);
        });

        valor.readOnly = true;
      }

      /* ================= TALLER ================= */
      else if (tipo === "taller") {
        const sel = buildSelect(servicios);
        descBox.appendChild(sel);

        $(sel).select2({
          width: "100%",
          placeholder: "Buscar servicio…",
          allowClear: true
        });

        $(sel).on("select2:select", function (e) {
          const opt = e.params.data.element;
          valor.value = opt.dataset.precio || "";
          updateSubtotal(row);
        });

        valor.readOnly = true;
      }

      /* ================= EFECTIVO ================= */
      else if (tipo === "efectivo") {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.name = "item_descripcion[]";
        inp.placeholder = "Detalle del préstamo";
        inp.className = "form-control form-control-sm";
        descBox.appendChild(inp);

        cant.disabled = true;
        cant.value = "";
        valor.readOnly = false;
        valor.placeholder = "Valor del préstamo";
      }

      updateSubtotal(row);
    }


    /* -------- agregar nueva fila -------- */
    function addRow() {
      const row = template
        .querySelector(".credito-item-row")
        .cloneNode(true);

      row.querySelector(".item-tipo")
        .addEventListener("change", () => applyTipo(row));

      row.querySelector(".item-cant")
        .addEventListener("input", () => updateSubtotal(row));

      row.querySelector(".item-valor")
        .addEventListener("input", () => updateSubtotal(row));

      row.querySelector(".btn-remove-item")
        .addEventListener("click", () => {
          row.remove();
          updateTotal();
        });

      container.appendChild(row);
    }


    /* -------- validación mínima -------- */
    form.addEventListener("submit", e => {
      const rows = document.querySelectorAll(".credito-item-row");
      if (!rows.length) {
        alert("Debes agregar al menos un ítem al crédito.");
        e.preventDefault();
      }
    });

    btnAdd.addEventListener("click", addRow);
  });
</script>

<!-- ================= SCRIPT POPOVERS ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  let activePopover = null;

  document.querySelectorAll(".credito-popover").forEach(el => {

    const pop = new bootstrap.Popover(el, {
      trigger: "manual",
      html: true,
      placement: "right"
    });

    el.addEventListener("click", async e => {
      e.preventDefault();

      // cerrar otro popover abierto
      if (activePopover && activePopover !== pop) {
        activePopover.hide();
      }

      // toggle mismo popover
      if (el.classList.contains("popover-open")) {
        pop.hide();
        el.classList.remove("popover-open");
        activePopover = null;
        return;
      }

      el.classList.add("popover-open");
      activePopover = pop;

      pop.setContent({ ".popover-body": "Cargando…" });
      pop.show();

      const creditoId = el.dataset.creditoId;
      const res = await fetch(`/creditos/items/${creditoId}/`);
      const data = await res.json();

      let html = `<div style="min-width:260px">`;

      if (!data.items.length) {
        html += `<div class="text-muted">Sin ítems</div>`;
      } else {
        data.items.forEach(i => {
          html += `
            <div class="mb-2">
              <strong>${i.tipo.toUpperCase()}</strong><br>
              ${i.descripcion}<br>
              ${
                i.cantidad
                  ? `<small>${i.cantidad} × $${i.valor_unitario.toLocaleString("es-CO")}</small><br>`
                  : ""
              }
              <span class="fw-bold">$${i.subtotal.toLocaleString("es-CO")}</span>
            </div>
          `;
        });
      }

      html += `</div>`;

      pop.setContent({ ".popover-body": html });
    });
  });

  // cerrar al click fuera
  document.addEventListener("click", e => {
    if (!e.target.closest(".popover") &&
        !e.target.closest(".credito-popover")) {
      document.querySelectorAll(".credito-popover").forEach(el => {
        el.classList.remove("popover-open");
      });
      if (activePopover) activePopover.hide();
      activePopover = null;
    }
  });

});
</script>




{% endblock %}