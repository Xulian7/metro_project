{% extends "accounts/home.html" %}

{% block content %}

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold mb-3">Nuevo crédito</h3>

  <form method="post" id="credito-form">
    {% csrf_token %}

    <!-- CONTRATO -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Contrato</label>
        {{ form.contrato }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Comentario general</label>
        {{ form.descripcion }}
      </div>
    </div>

    <hr>

    <!-- ÍTEMS -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold mb-0">Ítems del crédito</h5>
      <button type="button"
              class="btn btn-sm btn-outline-primary"
              id="btn-add-item">
        + Agregar ítem
      </button>
    </div>

    <div id="items-container"></div>

    <hr>

    <!-- TOTAL -->
    <div class="text-end mb-3">
      <strong>Total crédito:</strong>
      <span id="total-credito">$0</span>
    </div>

    <!-- GUARDAR -->
    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4">
        Guardar crédito
      </button>
    </div>

  </form>
</div>

<!-- TEMPLATE OCULTO DE FILA -->
<div id="item-template" class="d-none">
  <div class="row g-2 align-items-center mb-2 credito-item-row">

    <div class="col-2">
      <select class="form-select form-select-sm item-tipo"
              name="item_tipo[]">
        <option value="">Tipo</option>
        <option value="almacen">Almacén</option>
        <option value="taller">Taller</option>
        <option value="efectivo">Efectivo</option>
      </select>
    </div>

    <div class="col-3">
      <input type="text"
             class="form-control form-control-sm item-desc"
             name="item_descripcion[]"
             placeholder="Ítem / Servicio">
    </div>

    <div class="col-2">
      <input type="text"
             class="form-control form-control-sm item-obs"
             name="item_observacion[]"
             placeholder="Observación">
    </div>

    <div class="col-1">
      <input type="number"
             class="form-control form-control-sm item-cant"
             name="item_cantidad[]"
             min="1"
             placeholder="Cant">
    </div>

    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-valor text-end"
             name="item_valor[]"
             step="0.01"
             placeholder="$">
    </div>

    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-subtotal text-end"
             name="item_subtotal[]"
             step="0.01"
             placeholder="$"
             readonly>
    </div>

    <div class="col-auto">
      <button type="button"
              class="btn btn-sm btn-outline-danger btn-remove-item">
        ✖
      </button>
    </div>

  </div>
</div>

{% endblock %}

<!-- SCRIPT -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    const btnAdd = document.getElementById("btn-add-item");
    const container = document.getElementById("items-container");
    const template = document.getElementById("item-template");
    const totalLabel = document.getElementById("total-credito");

    // ---------------------------
    // Utilidades
    // ---------------------------
    function toNumber(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : n;
    }

    function updateTotal() {
      let total = 0;
      document.querySelectorAll(".item-subtotal").forEach(input => {
        total += toNumber(input.value);
      });
      totalLabel.textContent = `$${total.toLocaleString("es-CO")}`;
    }

    function updateRowSubtotal(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const cant = toNumber(row.querySelector(".item-cant").value);
      const valor = toNumber(row.querySelector(".item-valor").value);
      const subtotalInput = row.querySelector(".item-subtotal");

      let subtotal = 0;

      if (tipo === "almacen" || tipo === "taller") {
        subtotal = cant * valor;
      }

      if (tipo === "efectivo") {
        subtotal = valor;
      }

      subtotalInput.value = subtotal ? subtotal.toFixed(2) : "";
      updateTotal();
    }

    function applyTipoRules(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const cant = row.querySelector(".item-cant");
      const valor = row.querySelector(".item-valor");

      if (tipo === "efectivo") {
        cant.value = "";
        cant.disabled = true;
        valor.placeholder = "Valor";
      } else {
        cant.disabled = false;
        valor.placeholder = "$";
      }

      updateRowSubtotal(row);
    }

    // ---------------------------
    // Crear fila
    // ---------------------------
    function addItemRow() {
      const clone = template.firstElementChild.cloneNode(true);

      // listeners
      clone.querySelector(".item-tipo").addEventListener("change", () => {
        applyTipoRules(clone);
      });

      clone.querySelector(".item-cant").addEventListener("input", () => {
        updateRowSubtotal(clone);
      });

      clone.querySelector(".item-valor").addEventListener("input", () => {
        updateRowSubtotal(clone);
      });

      clone.querySelector(".btn-remove-item").addEventListener("click", () => {
        clone.remove();
        updateTotal();
      });

      container.appendChild(clone);
    }

    // ---------------------------
    // Eventos globales
    // ---------------------------
    btnAdd.addEventListener("click", addItemRow);

  });
</script>
