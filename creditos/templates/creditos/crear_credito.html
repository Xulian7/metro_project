{% extends "accounts/home.html" %}
{% block content %}

<div class="card p-4 shadow-sm">

  <h3 class="fw-bold mb-3">Nuevo crédito</h3>

  <form method="post" id="credito-form">
    {% csrf_token %}

    <!-- CABECERA -->
    <div class="row mb-4">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Contrato</label>
        {{ form.contrato }}
      </div>

      <div class="col-md-6">
        <label class="form-label">Comentario general</label>
        {{ form.descripcion }}
      </div>
    </div>

    <hr>

    <!-- ÍTEMS -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold mb-0">Ítems del crédito</h5>
      <button type="button"
              class="btn btn-sm btn-outline-primary"
              id="btn-add-item">
        + Agregar ítem
      </button>
    </div>

    <div id="items-container"></div>

    <hr>

    <!-- TOTAL -->
    <div class="text-end mb-3">
      <strong>Total crédito:</strong>
      <span id="total-credito">$0</span>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4">
        Guardar crédito
      </button>
    </div>
  </form>
</div>

<!-- ================= TEMPLATE FILA ================= -->
<div id="item-template" class="d-none">
  <div class="row g-2 align-items-center mb-2 credito-item-row">

    <!-- TIPO -->
    <div class="col-2">
      <select class="form-select form-select-sm item-tipo"
              name="item_tipo[]">
        <option value="">Tipo</option>
        <option value="almacen">Almacén</option>
        <option value="taller">Taller</option>
        <option value="efectivo">Efectivo</option>
      </select>
    </div>

    <!-- ITEM / SERVICIO -->
    <div class="col-3 item-desc-container">
      <!-- placeholder para mantener alineación -->
      <input type="hidden" name="item_descripcion[]" value="">
    </div>

    <!-- OBS -->
    <div class="col-2">
      <input type="text"
             class="form-control form-control-sm item-obs"
             name="item_observacion[]"
             placeholder="Observación">
    </div>

    <!-- CANTIDAD -->
    <div class="col-1">
      <input type="number"
             class="form-control form-control-sm item-cant"
             name="item_cantidad[]"
             min="1"
             placeholder="Cant">
    </div>

    <!-- VALOR -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-valor text-end"
             name="item_valor[]"
             step="0.01"
             placeholder="$">
    </div>

    <!-- SUBTOTAL -->
    <div class="col-2">
      <input type="number"
             class="form-control form-control-sm item-subtotal text-end"
             name="item_subtotal[]"
             step="0.01"
             readonly>
    </div>

    <div class="col-auto">
      <button type="button"
              class="btn btn-sm btn-outline-danger btn-remove-item">
        ✖
      </button>
    </div>

  </div>
</div>
{% endblock %}
{% block scripts %}

<!-- ================= SCRIPT ================= -->
<script>
  document.addEventListener("DOMContentLoaded", () => {

    const productos = {{ productos|safe }};
    const servicios = {{ servicios|safe }};

    const btnAdd = document.getElementById("btn-add-item");
    const container = document.getElementById("items-container");
    const template = document.getElementById("item-template");
    const totalLabel = document.getElementById("total-credito");
    const form = document.getElementById("credito-form");

    /* ---------------- utils ---------------- */
    const toNum = v => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    function updateTotal() {
      let total = 0;
      document.querySelectorAll(".item-subtotal").forEach(i => {
        total += toNum(i.value);
      });
      totalLabel.textContent = `$${total.toLocaleString("es-CO")}`;
    }

    function updateSubtotal(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const cant = toNum(row.querySelector(".item-cant")?.value);
      const valor = toNum(row.querySelector(".item-valor")?.value);

      let subtotal = 0;
      if (tipo === "efectivo") {
        subtotal = valor;
      } else {
        subtotal = cant * valor;
      }

      row.querySelector(".item-subtotal").value =
        subtotal ? subtotal.toFixed(2) : "";

      updateTotal();
    }

    function buildSelect(items) {
      const sel = document.createElement("select");
      sel.className = "form-select form-select-sm item-desc";
      sel.name = "item_descripcion[]";
      sel.innerHTML = `<option value="">Seleccione…</option>`;

      items.forEach(i => {
        const opt = document.createElement("option");
        opt.value = i.label;
        opt.dataset.precio = i.precio;
        opt.textContent = i.label;
        sel.appendChild(opt);
      });

      return sel;
    }

    function applyTipo(row) {
      const tipo = row.querySelector(".item-tipo").value;
      const descBox = row.querySelector(".item-desc-container");
      const cant = row.querySelector(".item-cant");
      const valor = row.querySelector(".item-valor");

      descBox.innerHTML = "";

      if (tipo === "almacen") {
        const sel = buildSelect(productos);
        descBox.appendChild(sel);
        cant.disabled = false;
        valor.value = "";

        sel.addEventListener("change", () => {
          valor.value = sel.selectedOptions[0]?.dataset.precio || "";
          updateSubtotal(row);
        });

      } else if (tipo === "taller") {
        const sel = buildSelect(servicios);
        descBox.appendChild(sel);
        cant.disabled = false;
        valor.value = "";

        sel.addEventListener("change", () => {
          valor.value = sel.selectedOptions[0]?.dataset.precio || "";
          updateSubtotal(row);
        });

      } else if (tipo === "efectivo") {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.name = "item_descripcion[]";
        inp.placeholder = "Detalle del préstamo";
        inp.className = "form-control form-control-sm";
        descBox.appendChild(inp);

        cant.value = "";
        cant.disabled = true;
        valor.value = "";
        valor.placeholder = "Valor del préstamo";
      }

      updateSubtotal(row);
    }

    function addRow() {
      const row = template.firstElementChild.cloneNode(true);

      row.querySelector(".item-tipo")
        .addEventListener("change", () => applyTipo(row));

      row.querySelector(".item-cant")
        .addEventListener("input", () => updateSubtotal(row));

      row.querySelector(".item-valor")
        .addEventListener("input", () => updateSubtotal(row));

      row.querySelector(".btn-remove-item")
        .addEventListener("click", () => {
          row.remove();
          updateTotal();
        });

      container.appendChild(row);
    }

    /* -------- validación mínima -------- */
    form.addEventListener("submit", e => {
      const rows = document.querySelectorAll(".credito-item-row");
      if (!rows.length) {
        alert("Debes agregar al menos un ítem al crédito.");
        e.preventDefault();
      }
    });

    btnAdd.addEventListener("click", addRow);
  });
</script>

<!-- ================= END SCRIPT ================= -->
{% endblock %}