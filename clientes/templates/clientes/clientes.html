{% extends 'accounts/home.html' %}
{% load static %}

{% block content %}
<div class="container-fluid px-4">
  <h2 class="mt-4 mb-3 text-center">GestiÃ³n de Clientes</h2>

  <!-- BotÃ³n nuevo cliente -->
  <div class="text-end mb-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#clienteModal" onclick="nuevoCliente()">
      + Nuevo Cliente
    </button>
  </div>

  <!-- Tabla de clientes -->
  <div class="table-responsive">
    <!-- Filtro por nombre -->
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" id="filtroNombre" class="form-control" placeholder=" Filtrar por nombre...">
      </div>
    </div>

    <!-- Tabla -->
    <table class="modern-table table table-striped align-middle w-100">
    <thead class="table-light">
      <tr>
        <th>CÃ©dula</th>
        <th>Nombre</th>
        <th>Nacionalidad</th>
        <th>DirecciÃ³n</th>
        <th>TelÃ©fono</th>
        <th>Referencia 1</th>
        <th>TelÃ©fono Ref. 1</th>
        <th>Referencia 2</th>
        <th>TelÃ©fono Ref. 2</th>
        <th>Tipo</th>
        <th>Status</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="clientes-table">
      {% for cliente in clientes %}
      <tr id="cliente-{{ cliente.id }}">
        <td>{{ cliente.cedula }}</td>
        <td>{{ cliente.nombre }}</td>
        <td>{{ cliente.nacionalidad|default:"â€”" }}</td>
        <td>{{ cliente.direccion|default:"â€”" }}</td>
        <td>{{ cliente.telefono|default:"â€”" }}</td>
        <td>{{ cliente.referencia_1|default:"â€”" }}</td>
        <td>{{ cliente.telefono_ref_1|default:"â€”" }}</td>
        <td>{{ cliente.referencia_2|default:"â€”" }}</td>
        <td>{{ cliente.telefono_ref_2|default:"â€”" }}</td>
        <td>
          <span class="badge {% if cliente.tipo == 'inversionista' %}bg-success{% else %}bg-secondary{% endif %}">
            {{ cliente.get_tipo_display }}
          </span>
        </td>
        <td>
          <span class="badge {% if cliente.status == 'lista_negra' %}bg-danger{% else %}bg-primary{% endif %}">
            {{ cliente.get_status_display }}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="editarCliente({{ cliente.id }})">
            âœï¸ Editar
          </button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="12" class="text-center text-muted">No hay clientes registrados.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  </div>
</div>

<!-- ğŸ¾ Modal Cliente - Estilo Bruno -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bruno-modal shadow-lg border-0">
      <form id="clienteForm" method="POST" class="p-2">
        {% csrf_token %}
        <div class="modal-header align-items-center border-0 pb-0">
          <h4 class="modal-title fw-bold text-primary" id="clienteModalLabel">ğŸ¶ Nuevo Cliente</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="bruno-form">
            {{ form.as_p }}
          </div>
        </div>

        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light bruno-btn-cancel" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn bruno-btn-save">ğŸ’¾ Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap + AJAX -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function nuevoCliente() {
  document.getElementById('clienteModalLabel').innerText = 'Nuevo Cliente';
  const form = document.getElementById('clienteForm');
  form.reset();
  form.action = '/clientes/';
}

function editarCliente(id) {
  fetch(`/clientes/${id}/`)
    .then(response => response.json())
    .then(data => {
      const form = document.getElementById('clienteForm');
      document.getElementById('clienteModalLabel').innerText = 'Editar Cliente';
      form.action = `/clientes/${id}/`;

      // Rellenar campos (asegÃºrate de que coincidan con los names del form)
      for (const key in data) {
        const field = document.getElementById(`id_${key}`);
        if (field) field.value = data[key];
      }

      const modal = new bootstrap.Modal(document.getElementById('clienteModal'));
      modal.show();
    });
}

document.getElementById('clienteForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const form = e.target;
  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      actualizarTabla();
      bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
    } else {
      alert('Error al guardar cliente');
    }
  })
  .catch(() => alert('Error en la comunicaciÃ³n con el servidor'));
});

function actualizarTabla() {
  fetch('/clientes/')
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const nuevaTabla = doc.querySelector('#clientes-table').innerHTML;
      document.querySelector('#clientes-table').innerHTML = nuevaTabla;
    });
}

// Filtro por nombre
document.getElementById('filtroNombre').addEventListener('keyup', function () {
  const filtro = this.value.toLowerCase();
  const filas = document.querySelectorAll('#clientes-table tr');

  filas.forEach(fila => {
    const nombre = fila.children[1]?.textContent.toLowerCase() || '';
    fila.style.display = nombre.includes(filtro) ? '' : 'none';
  });
});

</script>
{% endblock %}
