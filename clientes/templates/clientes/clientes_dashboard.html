{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Clientes</h3>

  <!-- ========================= -->
  <!-- FORM CREAR CLIENTE -->
  <!-- ========================= -->
  <div class="w-100 overflow-auto">
    <form method="post" class="row g-3 align-items-end mb-4">
      {% csrf_token %}

      <div class="col-md-2">
        <label class="form-label">Cédula</label>
        <input type="text" name="cedula" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Nombre</label>
        <input type="text" name="nombre" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Nacionalidad</label>
        <input type="text" name="nacionalidad" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Dirección</label>
        <input type="text" name="direccion" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Teléfono</label>
        <input type="text" name="telefono" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Referencia 1</label>
        <input type="text" name="referencia_1" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Tel. Ref. 1</label>
        <input type="text" name="telefono_ref_1" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Referencia 2</label>
        <input type="text" name="referencia_2" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Tel. Ref. 2</label>
        <input type="text" name="telefono_ref_2" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label">Tipo</label>
        <select name="tipo" class="form-select" id="tipo-create">
          <option value="Normal">Normal</option>
          <option value="Inversionista">Inversionista</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="Normal">Normal</option>
          <option value="Lista Negra">Lista Negra</option>
        </select>
      </div>

      <!-- SOLO INVERSIONISTA -->
      <div class="col-md-2 inversionista-only d-none">
        <label class="form-label">Costo Operativo</label>
        <input type="number" step="0.01" name="costo_operativo" class="form-control">
      </div>

      <div class="col-md-2 inversionista-only d-none">
        <label class="form-label">Costo Administrativo</label>
        <input type="number" step="0.01" name="costo_administrativo" class="form-control">
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" name="cliente_submit" class="btn btn-primary w-100">
          Guardar Cliente
        </button>
      </div>
    </form>
  </div>

  <!-- ========================= -->
  <!-- TABLA -->
  <!-- ========================= -->
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Cédula</th>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Status</th>
          <th class="text-end">Costo Operativo</th>
          <th class="text-end">Costo Administrativo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for c in clientes %}
        <tr>
          <td>{{ c.cedula }}</td>
          <td>{{ c.nombre }}</td>
          <td>{{ c.tipo }}</td>
          <td>{{ c.status }}</td>

          <td class="text-end">
            {% if c.tipo == "Inversionista" %}
              {{ c.costo_operativo|default:"0.00" }}
            {% else %}
              —
            {% endif %}
          </td>

          <td class="text-end">
            {% if c.tipo == "Inversionista" %}
              {{ c.costo_administrativo|default:"0.00" }}
            {% else %}
              —
            {% endif %}
          </td>

          <td>
            <button
              class="btn btn-warning btn-sm edit-cliente-btn"
              data-id="{{ c.id }}"
              data-cedula="{{ c.cedula }}"
              data-nombre="{{ c.nombre }}"
              data-tipo="{{ c.tipo }}"
              data-status="{{ c.status }}"
              data-costo-operativo="{{ c.costo_operativo }}"
              data-costo-administrativo="{{ c.costo_administrativo }}"
              data-bs-toggle="modal"
              data-bs-target="#editarClienteModal">
              Editar
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ========================= -->
<!-- MODAL EDITAR -->
<!-- ========================= -->
<div class="modal fade" id="editarClienteModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" id="edit-form">
        {% csrf_token %}
        <div class="modal-body row g-3">

          <input type="hidden" name="cliente_id" id="modal-id">

          <div class="col-md-4">
            <label>Cédula</label>
            <input type="text" name="cedula" id="modal-cedula" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Nombre</label>
            <input type="text" name="nombre" id="modal-nombre" class="form-control">
          </div>

          <div class="col-md-4">
            <label>Tipo</label>
            <select name="tipo" id="modal-tipo" class="form-select">
              <option value="Normal">Normal</option>
              <option value="Inversionista">Inversionista</option>
            </select>
          </div>

          <div class="col-md-4">
            <label>Status</label>
            <select name="status" id="modal-status" class="form-select">
              <option value="Normal">Normal</option>
              <option value="Lista Negra">Lista Negra</option>
            </select>
          </div>

          <!-- SOLO INVERSIONISTA -->
          <div class="col-md-4 inversionista-only d-none">
            <label>Costo Operativo</label>
            <input type="number" step="0.01"
                   name="costo_operativo"
                   id="modal-costo-operativo"
                   class="form-control">
          </div>

          <div class="col-md-4 inversionista-only d-none">
            <label>Costo Administrativo</label>
            <input type="number" step="0.01"
                   name="costo_administrativo"
                   id="modal-costo-administrativo"
                   class="form-control">
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- JS -->
<!-- ========================= -->
<script>
  document.addEventListener('DOMContentLoaded', () => {

    const modalId = document.getElementById('modal-id');
    const modalCedula = document.getElementById('modal-cedula');
    const modalNombre = document.getElementById('modal-nombre');
    const modalTipo = document.getElementById('modal-tipo');
    const modalStatus = document.getElementById('modal-status');
    const modalCostoOperativo = document.getElementById('modal-costo-operativo');
    const modalCostoAdministrativo = document.getElementById('modal-costo-administrativo');

    const editForm = document.getElementById('edit-form');
    const tipoCreate = document.getElementById('tipo-create');

    function toggleInversionistaFields(tipo) {
      document.querySelectorAll('.inversionista-only').forEach(el => {
        el.classList.toggle('d-none', tipo !== 'Inversionista');
      });
    }

    if (tipoCreate) {
      toggleInversionistaFields(tipoCreate.value);
      tipoCreate.addEventListener('change', () => {
        toggleInversionistaFields(tipoCreate.value);
      });
    }

    document.querySelectorAll('.edit-cliente-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        modalId.value = btn.dataset.id;
        modalCedula.value = btn.dataset.cedula;
        modalNombre.value = btn.dataset.nombre;
        modalTipo.value = btn.dataset.tipo;
        modalStatus.value = btn.dataset.status;
        modalCostoOperativo.value = btn.dataset.costoOperativo || '';
        modalCostoAdministrativo.value = btn.dataset.costoAdministrativo || '';
        toggleInversionistaFields(btn.dataset.tipo);
      });
    });

    modalTipo.addEventListener('change', e => {
      toggleInversionistaFields(e.target.value);
    });

    editForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(editForm);

      const response = await fetch('/clientes/update/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        }
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('Error al actualizar el cliente');
      }
    });

  });
</script>

{% endblock %}
