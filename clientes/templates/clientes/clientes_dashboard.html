{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Clientes</h3>

  <!-- ========================= -->
  <!-- FORM CREAR CLIENTE -->
  <!-- ========================= -->
  <div class="w-100 overflow-auto">
    <form method="post" class="row g-3 align-items-end mb-4">
      {% csrf_token %}

      <div class="col-md-2"><label>Cédula</label><input name="cedula" class="form-control"></div>
      <div class="col-md-2"><label>Nombre</label><input name="nombre" class="form-control"></div>
      <div class="col-md-2"><label>Nacionalidad</label><input name="nacionalidad" class="form-control"></div>
      <div class="col-md-2"><label>Dirección</label><input name="direccion" class="form-control"></div>
      <div class="col-md-2"><label>Teléfono</label><input name="telefono" class="form-control"></div>
      <div class="col-md-2"><label>Referencia 1</label><input name="referencia_1" class="form-control"></div>
      <div class="col-md-2"><label>Tel Ref 1</label><input name="telefono_ref_1" class="form-control"></div>
      <div class="col-md-2"><label>Referencia 2</label><input name="referencia_2" class="form-control"></div>
      <div class="col-md-2"><label>Tel Ref 2</label><input name="telefono_ref_2" class="form-control"></div>

      <div class="col-md-2">
        <label>Tipo</label>
        <select name="tipo" id="tipo-create" class="form-select">
          <option value="Normal">Normal</option>
          <option value="Inversionista">Inversionista</option>
        </select>
      </div>

      <div class="col-md-2">
        <label>Status</label>
        <select name="status" class="form-select">
          <option value="Normal">Normal</option>
          <option value="Lista Negra">Lista Negra</option>
        </select>
      </div>

      <div class="col-md-2 inversionista-only d-none">
        <label>Costo Operativo</label>
        <input type="number" step="0.01" name="costo_operativo" class="form-control">
      </div>

      <div class="col-md-2 inversionista-only d-none">
        <label>Costo Administrativo</label>
        <input type="number" step="0.01" name="costo_administrativo" class="form-control">
      </div>

      <div class="col-md-2">
        <button type="submit" name="cliente_submit" class="btn btn-primary w-100">
          Guardar
        </button>
      </div>
    </form>
  </div>


  <!-- ========================= -->
  <!-- BUSCADOR -->
  <!-- ========================= -->
  <div class="mb-3">
    <input
      type="text"
      id="cliente-search"
      class="form-control"
      placeholder="Buscar por nombre o cédula..."
    >
  </div>
  <!-- ========================= -->
  <!-- TABLA -->
  <!-- ========================= -->
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Cédula</th><th>Nombre</th><th>Nacionalidad</th><th>Dirección</th>
          <th>Teléfono</th><th>Ref 1</th><th>Tel Ref 1</th>
          <th>Ref 2</th><th>Tel Ref 2</th>
          <th>Tipo</th><th>Status</th>
          <th>Costo Operativo</th><th>Costo Administrativo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for c in clientes %}
        <tr>
          <td>{{ c.cedula }}</td>
          <td>{{ c.nombre }}</td>
          <td>{{ c.nacionalidad }}</td>
          <td>{{ c.direccion }}</td>
          <td>{{ c.telefono }}</td>
          <td>{{ c.referencia_1 }}</td>
          <td>{{ c.telefono_ref_1 }}</td>
          <td>{{ c.referencia_2 }}</td>
          <td>{{ c.telefono_ref_2 }}</td>
          <td>{{ c.tipo }}</td>
          <td>{{ c.status }}</td>
          <td>{{ c.costo_operativo|default:"—" }}</td>
          <td>{{ c.costo_administrativo|default:"—" }}</td>
          <td>
            <button class="btn btn-warning btn-sm edit-cliente-btn"
              data-id="{{ c.id }}"
              data-cedula="{{ c.cedula }}"
              data-nombre="{{ c.nombre }}"
              data-nacionalidad="{{ c.nacionalidad }}"
              data-direccion="{{ c.direccion }}"
              data-telefono="{{ c.telefono }}"
              data-ref1="{{ c.referencia_1 }}"
              data-telref1="{{ c.telefono_ref_1 }}"
              data-ref2="{{ c.referencia_2 }}"
              data-telref2="{{ c.telefono_ref_2 }}"
              data-tipo="{{ c.tipo }}"
              data-status="{{ c.status }}"
              data-costo-operativo="{{ c.costo_operativo }}"
              data-costo-administrativo="{{ c.costo_administrativo }}"
              data-bs-toggle="modal"
              data-bs-target="#editarClienteModal">
              Editar
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ========================= -->
<!-- MODAL -->
<!-- ========================= -->
<div class="modal fade" id="editarClienteModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form method="post" id="edit-form">
        {% csrf_token %}
        <input type="hidden" name="cliente_id" id="modal-id">

        <div class="modal-body row g-3">
          <div class="col-md-3"><label>Cédula</label><input id="modal-cedula" name="cedula" class="form-control"></div>
          <div class="col-md-3"><label>Nombre</label><input id="modal-nombre" name="nombre" class="form-control"></div>
          <div class="col-md-3"><label>Nacionalidad</label><input id="modal-nacionalidad" name="nacionalidad" class="form-control"></div>
          <div class="col-md-3"><label>Dirección</label><input id="modal-direccion" name="direccion" class="form-control"></div>
          <div class="col-md-3"><label>Teléfono</label><input id="modal-telefono" name="telefono" class="form-control"></div>
          <div class="col-md-3"><label>Referencia 1</label><input id="modal-ref1" name="referencia_1" class="form-control"></div>
          <div class="col-md-3"><label>Tel Ref 1</label><input id="modal-telref1" name="telefono_ref_1" class="form-control"></div>
          <div class="col-md-3"><label>Referencia 2</label><input id="modal-ref2" name="referencia_2" class="form-control"></div>
          <div class="col-md-3"><label>Tel Ref 2</label><input id="modal-telref2" name="telefono_ref_2" class="form-control"></div>

          <div class="col-md-3">
            <label>Tipo</label>
            <select id="modal-tipo" name="tipo" class="form-select">
              <option value="Normal">Normal</option>
              <option value="Inversionista">Inversionista</option>
            </select>
          </div>

          <div class="col-md-3">
            <label>Status</label>
            <select id="modal-status" name="status" class="form-select">
              <option value="Normal">Normal</option>
              <option value="Lista Negra">Lista Negra</option>
            </select>
          </div>

          <div class="col-md-3 inversionista-only d-none">
            <label>Costo Operativo</label>
            <input id="modal-costo-operativo" name="costo_operativo" type="number" step="0.01" class="form-control">
          </div>

          <div class="col-md-3 inversionista-only d-none">
            <label>Costo Administrativo</label>
            <input id="modal-costo-administrativo" name="costo_administrativo" type="number" step="0.01" class="form-control">
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- JS -->
<!-- ========================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  function toggleInversionista(tipo) {
    document.querySelectorAll('.inversionista-only')
      .forEach(el => el.classList.toggle('d-none', tipo !== 'Inversionista'));
  }

  const tipoCreate = document.getElementById('tipo-create');
  if (tipoCreate) {
    toggleInversionista(tipoCreate.value);
    tipoCreate.addEventListener('change', e => toggleInversionista(e.target.value));
  }

  document.querySelectorAll('.edit-cliente-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const map = {
        id: 'modal-id',
        cedula: 'modal-cedula',
        nombre: 'modal-nombre',
        nacionalidad: 'modal-nacionalidad',
        direccion: 'modal-direccion',
        telefono: 'modal-telefono',
        ref1: 'modal-ref1',
        telref1: 'modal-telref1',
        ref2: 'modal-ref2',
        telref2: 'modal-telref2',
        tipo: 'modal-tipo',
        status: 'modal-status',
        costoOperativo: 'modal-costo-operativo',
        costoAdministrativo: 'modal-costo-administrativo'
      };

      Object.entries(map).forEach(([k, id]) => {
        const el = document.getElementById(id);
        if (el) el.value = btn.dataset[k] || '';
      });

      toggleInversionista(btn.dataset.tipo);
    });
  });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const searchInput = document.getElementById('cliente-search');
  if (!searchInput) return;

  searchInput.addEventListener('input', () => {
    const filtro = searchInput.value.toLowerCase().trim();

    document.querySelectorAll('table tbody tr').forEach(row => {
      const cedula = row.children[0]?.textContent.toLowerCase() || '';
      const nombre = row.children[1]?.textContent.toLowerCase() || '';

      const match = cedula.includes(filtro) || nombre.includes(filtro);
      row.style.display = match ? '' : 'none';
    });
  });

});
</script>




{% endblock %}
