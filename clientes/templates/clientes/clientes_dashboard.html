{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h3 class="fw-bold mb-4">üêæ Clientes Dashboard</h3>

  <!-- üîπ Formulario de creaci√≥n -->
  <div class="card mb-4">
    <div class="card-header">Agregar Nuevo Cliente</div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" name="cliente_submit" class="btn btn-primary">Crear Cliente</button>
      </form>
    </div>
  </div>

  <!-- üîπ Tabla de clientes -->
  <div class="card">
    <div class="card-header">Lista de Clientes</div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>C√©dula</th>
            <th>Nombre</th>
            <th>Tel√©fono</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for cliente in clientes %}
          <tr>
            <td>{{ cliente.cedula }}</td>
            <td>{{ cliente.nombre }}</td>
            <td>{{ cliente.telefono }}</td>
            <td>{{ cliente.tipo }}</td>
            <td>{{ cliente.status }}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="editarCliente({{ cliente.id }})">
                ‚úèÔ∏è Editar
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- üîπ Modal de edici√≥n -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="formEditarCliente">
        {% csrf_token %}
        <input type="hidden" id="cliente_id" name="cliente_id">

        <div class="modal-header">
          <h5 class="modal-title" id="clienteModalLabel">Editar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="id_cedula" class="form-label">C√©dula</label>
              <input type="text" name="cedula" class="form-control" id="id_cedula">
            </div>
            <div class="col-md-6">
              <label for="id_nombre" class="form-label">Nombre</label>
              <input type="text" name="nombre" class="form-control" id="id_nombre">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="id_nacionalidad" class="form-label">Nacionalidad</label>
              <input type="text" name="nacionalidad" class="form-control" id="id_nacionalidad">
            </div>
            <div class="col-md-6">
              <label for="id_telefono" class="form-label">Tel√©fono</label>
              <input type="text" name="telefono" class="form-control" id="id_telefono">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="id_direccion" class="form-label">Direcci√≥n</label>
              <input type="text" name="direccion" class="form-control" id="id_direccion">
            </div>
            <div class="col-md-6">
              <label for="id_tipo" class="form-label">Tipo</label>
              <select name="tipo" class="form-select" id="id_tipo">
                <option value="normal">Normal</option>
                <option value="inversionista">Inversionista</option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="id_referencia_1" class="form-label">Referencia 1</label>
              <input type="text" name="referencia_1" class="form-control" id="id_referencia_1">
            </div>
            <div class="col-md-6">
              <label for="id_telefono_ref_1" class="form-label">Tel√©fono Ref 1</label>
              <input type="text" name="telefono_ref_1" class="form-control" id="id_telefono_ref_1">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="id_referencia_2" class="form-label">Referencia 2</label>
              <input type="text" name="referencia_2" class="form-control" id="id_referencia_2">
            </div>
            <div class="col-md-6">
              <label for="id_telefono_ref_2" class="form-label">Tel√©fono Ref 2</label>
              <input type="text" name="telefono_ref_2" class="form-control" id="id_telefono_ref_2">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="id_status" class="form-label">Status</label>
              <select name="status" class="form-select" id="id_status">
                <option value="normal">Normal</option>
                <option value="lista_negra">Lista Negra</option>
              </select>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- üîπ Script AJAX -->
<script>
const modalCliente = new bootstrap.Modal(document.getElementById('clienteModal'));

function editarCliente(id) {
  fetch(`/clientes/${id}/get/`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('cliente_id').value = data.id;
      document.getElementById('id_cedula').value = data.cedula || '';
      document.getElementById('id_nombre').value = data.nombre || '';
      document.getElementById('id_nacionalidad').value = data.nacionalidad || '';
      document.getElementById('id_direccion').value = data.direccion || '';
      document.getElementById('id_telefono').value = data.telefono || '';
      document.getElementById('id_referencia_1').value = data.referencia_1 || '';
      document.getElementById('id_telefono_ref_1').value = data.telefono_ref_1 || '';
      document.getElementById('id_referencia_2').value = data.referencia_2 || '';
      document.getElementById('id_telefono_ref_2').value = data.telefono_ref_2 || '';
      document.getElementById('id_tipo').value = data.tipo || 'normal';
      document.getElementById('id_status').value = data.status || 'normal';
      modalCliente.show();
    })
    .catch(err => console.error(err));
}

document.getElementById('formEditarCliente').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch("{% url 'clientes_update' %}", {
    method: "POST",
    body: formData,
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'ok') {
      modalCliente.hide();
      location.reload(); // puedes reemplazar con actualizaci√≥n din√°mica si quieres
    } else {
      alert("Error al actualizar el cliente.");
    }
  });
});
</script>
{% endblock %}
