{% extends "accounts/home.html" %}
{% load static %}
{% block content %}

<div class="card p-4 shadow-sm">
  <h3 class="fw-bold fs-5 mb-4">Veh√≠culos</h3>

  <!-- ========================= -->
  <!-- Formulario Crear Veh√≠culo -->
  <!-- ========================= -->
  <form method="post" class="row g-3 mb-4">
    {% csrf_token %}

    <!-- Render autom√°tico de inputs + widgets -->
    {{ form.non_field_errors }}

    <div class="col-md-2">
      <label class="form-label">Placa</label>
      {{ form.placa }}
    </div>

    <div class="col-md-2">
      <label class="form-label">Marca</label>
      {{ form.marca }}
    </div>

    <div class="col-md-2">
      <label class="form-label">Modelo</label>
      {{ form.modelo }}
    </div>

    <div class="col-md-2">
      <label class="form-label">Serie</label>
      {{ form.serie }}
    </div>

    <div class="col-md-2">
      <label class="form-label">Propietario</label>
      <select name="propietario" class="form-select">
        <option value="">Seleccione‚Ä¶</option>
        {% for inv in inversionistas %}
            <option value="{{ inv.id }}">{{ inv.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label"># Motor</label>
      {{ form.numero_motor }}
    </div>

    <div class="col-md-2">
      <label class="form-label"># Chasis</label>
      {{ form.numero_chasis }}
    </div>

    <div class="col-md-2">
      <label class="form-label">L√≠nea GPS</label>
      {{ form.linea_gps }}
    </div>

    <div class="col-md-2">
      <label class="form-label">Actualizaci√≥n SOAT</label>
      {{ form.actualizacion_soat }}
    </div>

    <div class="col-md-2">
      <label class="form-label">Estado</label>
      <select class="form-select" disabled readonly>
        <option value="Vitrina" selected>Vitrina</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Observaci√≥n del Estado</label>
      {{ form.estado_obs }}
    </div>

    <div class="col-md-2 d-flex align-items-end justify-content-end">
      <button type="submit" name="vehiculo_submit" class="btn btn-primary px-4 w-100">
        Guardar
      </button>
    </div>
  </form>

  <!-- ===================================== -->
  <!-- Buscador -->
  <!-- ===================================== -->
  <div class="mb-3">
    <input type="text" id="busquedaPlaca" class="form-control" placeholder="Buscar por placa...">
  </div>

  <!-- ===================================== -->
  <!-- Tabla de Veh√≠culos -->
  <!-- ===================================== -->
  <table class="modern-table w-100">
    <thead>
      <tr>
        <th>Placa</th>
        <th>Marca</th>
        <th>Modelo</th>
        <th>Serie</th>
        <th>Propietario</th>
        <th># Motor</th>
        <th># Chasis</th>
        <th>L√≠nea GPS</th>
        <th>SOAT</th>
        <th>Estado</th>
        <th>Obs Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for v in vehiculos %}
      <tr>
        <td>{{ v.placa }}</td>
        <td>{{ v.marca }}</td>
        <td>{{ v.modelo }}</td>
        <td>{{ v.serie }}</td>
        <td>{{ v.propietario }}</td>
        <td>{{ v.numero_motor }}</td>
        <td>{{ v.numero_chasis }}</td>
        <td>{{ v.linea_gps }}</td>
        <td>{{ v.actualizacion_soat|date:"Y-m-d" }}</td>
        <td>{{ v.estado }}</td>
        <td>{{ v.estado_obs }}</td>
        <td>
          <button 
            type="button" 
            class="btn btn-sm btn-warning edit-vehiculo-btn"
            data-id="{{ v.id }}"
            data-placa="{{ v.placa }}"
            data-marca="{{ v.marca }}"
            data-modelo="{{ v.modelo }}"
            data-serie="{{ v.serie }}"
            data-propietario="{{ v.propietario }}"
            data-motor="{{ v.numero_motor }}"
            data-chasis="{{ v.numero_chasis }}"
            data-linea="{{ v.linea_gps }}"
            data-soat="{{ v.actualizacion_soat|date:'Y-m-d' }}"
            data-estado="{{ v.estado }}"
            data-estadoobs="{{ v.estado_obs }}"
            data-bs-toggle="modal"
            data-bs-target="#editarVehiculoModal">
            Editar
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('busquedaPlaca');
      const filas = document.querySelectorAll('table tbody tr');

      input.addEventListener('keyup', function() {
          const filtro = this.value.toLowerCase();
          filas.forEach(fila => {
              const placa = fila.querySelector('td').textContent.toLowerCase();
              fila.style.display = placa.includes(filtro) ? '' : 'none';
          });
      });
  });
  </script>
</div>


<!-- ============================ -->
<!-- Modal √önico para Editar -->
<!-- ============================ -->
<div class="modal fade" id="editarVehiculoModal" tabindex="-1" aria-labelledby="editarVehiculoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Editar Veh√≠culo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="vehiculo_id" id="modal-vehiculo-id">

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Placa</label>
              <input type="text" id="modal-placa" name="placa" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Marca</label>
              <input type="text" id="modal-marca" name="marca" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Modelo</label>
              <input type="text" id="modal-modelo" name="modelo" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Serie</label>
              <input type="text" id="modal-serie" name="serie" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Propietario</label>
              <input type="text" id="modal-propietario" name="propietario" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label"># Motor</label>
              <input type="text" id="modal-motor" name="numero_motor" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label"># Chasis</label>
              <input type="text" id="modal-chasis" name="numero_chasis" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">L√≠nea GPS</label>
              <input type="text" id="modal-linea" name="linea_gps" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">SOAT</label>
              <input type="date" id="modal-soat" name="actualizacion_soat" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Estado</label>
              <select id="modal-estado" name="estado" class="form-select">
                <option value="Activo">Activo</option>
                <option value="Vitrina">Vitrina</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>

            <div class="col-md-12">
              <label class="form-label">Observaci√≥n del Estado</label>
              <textarea id="modal-estado-obs" name="estado_obs" class="form-control"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" name="vehiculo_update">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.querySelectorAll(".edit-vehiculo-btn").forEach(btn => {
    btn.addEventListener("click", function () {

        const get = (key) => this.dataset[key] && this.dataset[key] !== "None" ? this.dataset[key] : "";

        document.getElementById("modal-vehiculo-id").value = get("id");
        document.getElementById("modal-placa").value = get("placa");
        document.getElementById("modal-marca").value = get("marca");
        document.getElementById("modal-modelo").value = get("modelo");
        document.getElementById("modal-serie").value = get("serie");
        document.getElementById("modal-propietario").value = get("propietario");
        document.getElementById("modal-motor").value = get("motor");
        document.getElementById("modal-chasis").value = get("chasis");
        document.getElementById("modal-linea").value = get("linea");
        document.getElementById("modal-soat").value = get("soat");

        // üéØ Aqu√≠ est√° tu fix: seleccionar el Estado correcto
        document.getElementById("modal-estado").value = get("estado");

        // üéØ Y llenar la observaci√≥n
        document.getElementById("modal-estado-obs").value = get("estado_obs");

        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById("editarVehiculoModal"));
        modal.show();
    });
});
</script>



{% endblock %}
